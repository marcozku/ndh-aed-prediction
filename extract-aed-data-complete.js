/**
 * å¾å®Œæ•´å ±å‘Šæ•¸æ“šä¸­æå–æ—¥æœŸå’Œå°±è¨ºäººæ•¸
 * è™•ç† 2015-2025 å¹´çš„ AED æ•¸æ“š
 */

const fs = require('fs');
const path = require('path');

/**
 * å¾ç”¨æˆ¶æä¾›çš„å®Œæ•´æ–‡æœ¬ä¸­æå–æ‰€æœ‰æ—¥æœŸå’Œå°±è¨ºäººæ•¸
 */
function extractAllData() {
    // è®€å–å®Œæ•´çš„ç”¨æˆ¶è¼¸å…¥ï¼ˆæ‡‰è©²å¾æ–‡ä»¶è®€å–ï¼Œé€™è£¡æˆ‘å€‘ç›´æ¥è™•ç†ï¼‰
    // ç”±æ–¼æ•¸æ“šå¤ªé•·ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹æ›´ç³»çµ±çš„æ–¹æ³•
    
    // å¾ç”¨æˆ¶æŸ¥è©¢ä¸­ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°æ•¸æ“šæ¨¡å¼ï¼š
    // 1. "Reg. date" å¾Œé¢è·Ÿè‘—æ—¥æœŸåˆ—è¡¨ï¼ˆDD/MM/YYYYæ ¼å¼ï¼‰
    // 2. "Date :Time :" å¾Œé¢è·Ÿè‘—æ•¸å­—åˆ—è¡¨ï¼ˆå°±è¨ºäººæ•¸ï¼‰
    // 3. æ—¥æœŸå’Œæ•¸å­—æ˜¯æŒ‰é †åºå°æ‡‰çš„
    
    // ç”±æ–¼æ•¸æ“šæ ¼å¼è¤‡é›œï¼Œæˆ‘å€‘æ‰‹å‹•æ§‹å»ºå®Œæ•´çš„æ•¸æ“šé›†
    // åŸºæ–¼ç”¨æˆ¶æä¾›çš„æ•¸æ“šï¼Œæˆ‘å€‘æå–æ‰€æœ‰å¯è¦‹çš„é…å°
    
    const allData = [];
    
    // 2016å¹´æ•¸æ“šï¼ˆ2015-12-01 åˆ° 2016-12-01ï¼‰
    const data2016 = {
        dates: [
            '07/01/2016', '08/01/2016', '09/01/2016', '10/01/2016', '11/01/2016', '12/01/2016', '13/01/2016',
            '14/01/2016', '15/01/2016', '16/01/2016', '17/01/2016', '18/01/2016', '19/01/2016', '20/01/2016',
            '21/01/2016', '22/01/2016', '23/01/2016', '24/01/2016', '25/01/2016', '26/01/2016', '27/01/2016',
            '28/01/2016', '29/01/2016', '30/01/2016', '31/01/2016', '01/02/2016', '02/02/2016', '03/02/2016',
            '04/02/2016', '05/02/2016', '06/02/2016', '07/02/2016', '08/02/2016', '09/02/2016', '10/02/2016',
            '11/02/2016', '12/02/2016', '13/02/2016', '14/02/2016', '15/02/2016', '16/02/2016', '17/02/2016',
            '18/02/2016', '19/02/2016', '20/02/2016', '21/02/2016', '22/02/2016', '23/02/2016', '24/02/2016',
            '25/02/2016', '26/02/2016', '27/02/2016', '28/02/2016', '29/02/2016', '01/03/2016', '02/03/2016',
            '03/03/2016', '04/03/2016', '05/03/2016', '06/03/2016', '07/03/2016', '08/03/2016', '09/03/2016',
            '10/03/2016', '11/03/2016', '12/03/2016', '13/03/2016', '14/03/2016', '15/03/2016', '16/03/2016',
            '17/03/2016', '18/03/2016', '19/03/2016', '20/03/2016', '21/03/2016', '22/03/2016', '23/03/2016',
            '24/03/2016', '25/03/2016', '26/03/2016', '27/03/2016', '28/03/2016', '29/03/2016', '30/03/2016',
            '31/03/2016', '01/04/2016', '02/04/2016', '03/04/2016', '04/04/2016', '05/04/2016', '06/04/2016',
            '07/04/2016', '08/04/2016', '09/04/2016', '10/04/2016', '11/04/2016', '12/04/2016', '13/04/2016',
            '14/04/2016', '15/04/2016', '16/04/2016', '17/04/2016', '18/04/2016', '19/04/2016', '20/04/2016',
            '21/04/2016', '22/04/2016', '23/04/2016', '24/04/2016', '25/04/2016', '26/04/2016', '27/04/2016',
            '28/04/2016', '29/04/2016', '30/04/2016', '01/05/2016', '02/05/2016', '03/05/2016', '04/05/2016',
            '05/05/2016', '06/05/2016', '07/05/2016', '08/05/2016', '09/05/2016', '10/05/2016', '11/05/2016',
            '12/05/2016', '13/05/2016', '14/05/2016', '15/05/2016', '16/05/2016', '17/05/2016', '18/05/2016',
            '19/05/2016', '20/05/2016', '21/05/2016', '22/05/2016', '23/05/2016', '24/05/2016', '25/05/2016',
            '26/05/2016', '27/05/2016', '28/05/2016', '29/05/2016', '30/05/2016', '31/05/2016', '01/06/2016',
            '02/06/2016', '03/06/2016', '04/06/2016', '05/06/2016', '06/06/2016', '07/06/2016', '08/06/2016',
            '09/06/2016', '10/06/2016', '11/06/2016', '12/06/2016', '13/06/2016', '14/06/2016', '15/06/2016',
            '16/06/2016', '17/06/2016', '18/06/2016', '19/06/2016', '20/06/2016', '21/06/2016', '22/06/2016',
            '23/06/2016', '24/06/2016', '25/06/2016', '26/06/2016', '27/06/2016', '28/06/2016', '29/06/2016',
            '30/06/2016', '01/07/2016', '02/07/2016', '03/07/2016', '04/07/2016', '05/07/2016', '06/07/2016',
            '07/07/2016', '08/07/2016', '09/07/2016', '10/07/2016', '11/07/2016', '12/07/2016', '13/07/2016',
            '14/07/2016', '15/07/2016', '16/07/2016', '17/07/2016', '18/07/2016', '19/07/2016', '20/07/2016',
            '21/07/2016', '22/07/2016', '23/07/2016', '24/07/2016', '25/07/2016', '26/07/2016', '27/07/2016',
            '28/07/2016', '29/07/2016', '30/07/2016', '31/07/2016', '01/08/2016', '02/08/2016', '03/08/2016',
            '04/08/2016', '05/08/2016', '06/08/2016', '07/08/2016', '08/08/2016', '09/08/2016', '10/08/2016',
            '11/08/2016', '12/08/2016', '13/08/2016', '14/08/2016', '15/08/2016', '16/08/2016', '17/08/2016',
            '18/08/2016', '19/08/2016', '20/08/2016', '21/08/2016', '22/08/2016', '23/08/2016', '24/08/2016',
            '25/08/2016', '26/08/2016', '27/08/2016', '28/08/2016', '29/08/2016', '30/08/2016', '31/08/2016',
            '01/09/2016', '02/09/2016', '03/09/2016', '04/09/2016', '05/09/2016', '06/09/2016', '07/09/2016',
            '08/09/2016', '09/09/2016', '10/09/2016', '11/09/2016', '12/09/2016', '13/09/2016', '14/09/2016',
            '15/09/2016', '16/09/2016', '17/09/2016', '18/09/2016', '19/09/2016', '20/09/2016', '21/09/2016',
            '22/09/2016', '23/09/2016', '24/09/2016', '25/09/2016', '26/09/2016', '27/09/2016', '28/09/2016',
            '29/09/2016', '30/09/2016', '01/10/2016', '02/10/2016', '03/10/2016', '04/10/2016', '05/10/2016',
            '06/10/2016', '07/10/2016', '08/10/2016', '09/10/2016', '10/10/2016', '11/10/2016', '12/10/2016',
            '13/10/2016', '14/10/2016', '15/10/2016', '16/10/2016', '17/10/2016', '18/10/2016', '19/10/2016',
            '20/10/2016', '21/10/2016', '22/10/2016', '23/10/2016', '24/10/2016', '25/10/2016', '26/10/2016',
            '27/10/2016', '28/10/2016', '29/10/2016', '30/10/2016', '31/10/2016', '01/11/2016', '02/11/2016',
            '03/11/2016', '04/11/2016', '05/11/2016', '06/11/2016', '07/11/2016', '08/11/2016', '09/11/2016',
            '10/11/2016', '11/11/2016', '12/11/2016', '13/11/2016', '14/11/2016', '15/11/2016', '16/11/2016',
            '17/11/2016', '18/11/2016', '19/11/2016', '20/11/2016', '21/11/2016', '22/11/2016', '23/11/2016',
            '24/11/2016', '25/11/2016', '26/11/2016', '27/11/2016', '28/11/2016', '29/11/2016', '30/11/2016',
            '01/12/2016'
        ],
        attendances: [
            296, 286, 282, 290, 279, 264, 306, 260, 260, 258, 256, 330, 283, 295, 296, 241, 227, 225, 297, 305, 323, 306, 315, 325, 303, 300, 303, 297, 299, 286, 278, 282, 326, 394, 389, 379, 351,
            311, 322, 290, 303, 295, 276, 357, 300, 324, 342, 300, 292, 304, 337, 325, 314, 357, 361, 318, 315, 335, 336, 326, 359, 336, 273, 253, 267, 229, 280, 295, 296, 232, 291, 282, 252, 298,
            283, 312, 265, 237, 290, 313, 295, 334, 284, 280, 279, 291, 318, 301, 316, 338, 319, 305, 322, 310, 316, 323, 282, 275, 306, 289, 303, 305, 331, 290, 279, 326, 293, 299, 276, 335, 306,
            297, 311, 281, 313, 285, 312, 333, 289, 310, 342, 306, 336, 337, 294, 298, 337, 283, 319, 307, 355, 335, 309, 303, 292, 313, 319, 333, 306, 306, 280, 285, 279, 302, 359, 327, 289, 311,
            316, 272, 286, 289, 300, 268, 296, 299, 251, 257, 309, 284, 313, 293, 292, 273, 250, 331, 272, 286, 299, 295, 292, 315, 309, 277, 289, 335, 283, 277, 278, 310, 308, 294, 288, 304, 290,
            268, 281, 282, 273, 293, 291, 251, 254, 300, 289, 293, 301, 294, 239, 302, 278, 294, 278, 296, 270, 244, 272, 293, 202, 285, 261, 316, 254, 302, 292, 313, 291, 295, 288, 249, 240, 293,
            243, 265, 261, 280, 298, 289, 301, 306, 302, 324, 276, 251, 261, 288, 320, 316, 268, 297, 264, 275, 321, 291, 297, 289, 284, 300, 307, 353, 281, 277, 265, 325, 334, 309, 378, 275, 308,
            328, 293, 307, 305, 348, 337, 355, 295, 299, 278, 293, 326, 327, 298, 286, 295, 273, 299, 311, 366, 292, 312, 308, 269, 297, 325, 249, 282, 303, 232, 332, 319, 336, 285, 295, 302, 294,
            282, 301, 299, 267, 291, 265, 263, 279, 267, 326, 298, 247, 262, 285, 272, 287, 334, 294, 302, 332, 319, 287, 279, 338, 294, 228, 263, 260, 260, 243, 304, 268, 245, 258
        ]
    };
    
    // è½‰æ›æ—¥æœŸæ ¼å¼ä¸¦é…å°
    data2016.dates.forEach((dateStr, index) => {
        if (data2016.attendances[index] !== undefined) {
            const [day, month, year] = dateStr.split('/');
            const isoDate = `${year}-${month}-${day}`;
            allData.push({
                date: isoDate,
                attendance: data2016.attendances[index],
                original_date: dateStr
            });
        }
    });
    
    // ç”±æ–¼æ•¸æ“šé‡å·¨å¤§ï¼Œæˆ‘å€‘éœ€è¦å¾ç”¨æˆ¶æä¾›çš„å®Œæ•´æ–‡æœ¬ä¸­ç³»çµ±æ€§åœ°æå–
    // é€™è£¡æˆ‘å€‘å‰µå»ºä¸€å€‹é€šç”¨çš„è§£æå‡½æ•¸
    
    return allData;
}

/**
 * å¾å®Œæ•´æ–‡æœ¬ä¸­è§£ææ‰€æœ‰æ•¸æ“š
 * é€™å€‹å‡½æ•¸éœ€è¦è™•ç†ç”¨æˆ¶æä¾›çš„å®Œæ•´æ–‡æœ¬
 */
function parseFullText(fullText) {
    const results = [];
    
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå–æ‰€æœ‰æ—¥æœŸå’Œæ•¸å­—
    // å°‹æ‰¾ "Reg. date" å¾Œé¢çš„æ—¥æœŸåºåˆ—
    const regDatePattern = /Reg\. date([\s\S]*?)(?=Date :Time :|Attendance|Hospital Authority|Accident|For Period:|Page :|$)/gi;
    
    // å°‹æ‰¾ "Date :Time :" å¾Œé¢çš„æ•¸å­—åºåˆ—
    const attendancePattern = /Date :Time :\s*([\d\s]+)/gi;
    
    // æå–æ‰€æœ‰æ—¥æœŸ
    const dateMatches = [];
    let match;
    const dateRegex = /(\d{2}\/\d{2}\/\d{4})/g;
    while ((match = dateRegex.exec(fullText)) !== null) {
        dateMatches.push(match[1]);
    }
    
    // æå–æ‰€æœ‰å¯èƒ½çš„å°±è¨ºäººæ•¸ï¼ˆ3-4ä½æ•¸å­—ï¼‰
    const attendanceMatches = [];
    const attendanceRegex = /\b(\d{3,4})\b/g;
    while ((match = attendanceRegex.exec(fullText)) !== null) {
        const num = parseInt(match[1]);
        // éæ¿¾æ‰å¹´ä»½ã€é ç¢¼ç­‰
        if (num >= 100 && num <= 9999 && num < 2015) {
            attendanceMatches.push(num);
        }
    }
    
    // ç”±æ–¼æ•¸æ“šæ ¼å¼ä¸è¦å‰‡ï¼Œæˆ‘å€‘éœ€è¦æ›´æ™ºèƒ½çš„åŒ¹é…
    // é€™è£¡æˆ‘å€‘è¿”å›ä¸€å€‹éœ€è¦æ‰‹å‹•é©—è­‰çš„çµæœ
    
    return {
        dates: dateMatches,
        attendances: attendanceMatches,
        note: 'éœ€è¦æ‰‹å‹•é©—è­‰å’Œé…å°'
    };
}

// å¦‚æœç›´æ¥é‹è¡Œæ­¤è…³æœ¬
if (require.main === module) {
    console.log('ğŸ“Š é–‹å§‹æå–å®Œæ•´çš„ AED æ•¸æ“š...');
    
    // å…ˆæå– 2016 å¹´çš„æ•¸æ“šä½œç‚ºç¤ºä¾‹
    const sampleData = extractAllData();
    console.log(`âœ… æå–å®Œæˆï¼Œå…± ${sampleData.length} ç­†æ•¸æ“šï¼ˆ2016å¹´ç¤ºä¾‹ï¼‰`);
    
    if (sampleData.length > 0) {
        console.log('\nå‰10ç­†æ•¸æ“šï¼š');
        sampleData.slice(0, 10).forEach(item => {
            console.log(`${item.date}: ${item.attendance}`);
        });
        
        console.log('\næœ€å¾Œ10ç­†æ•¸æ“šï¼š');
        sampleData.slice(-10).forEach(item => {
            console.log(`${item.date}: ${item.attendance}`);
        });
        
        // ä¿å­˜åˆ°æ–‡ä»¶
        const outputPath = path.join(__dirname, 'extracted-aed-data-2016.json');
        fs.writeFileSync(outputPath, JSON.stringify(sampleData, null, 2), 'utf8');
        console.log(`\nâœ… æ•¸æ“šå·²ä¿å­˜åˆ° ${outputPath}`);
        
        // ä¹Ÿä¿å­˜ç‚º CSV æ ¼å¼
        const csvPath = path.join(__dirname, 'extracted-aed-data-2016.csv');
        const csvHeader = 'Date,Attendance\n';
        const csvContent = sampleData.map(item => `${item.date},${item.attendance}`).join('\n');
        fs.writeFileSync(csvPath, csvHeader + csvContent, 'utf8');
        console.log(`âœ… CSV æ•¸æ“šå·²ä¿å­˜åˆ° ${csvPath}`);
    }
    
    console.log('\nâš ï¸  æ³¨æ„ï¼šç”±æ–¼æ•¸æ“šæ ¼å¼è¤‡é›œï¼Œå®Œæ•´æ•¸æ“šéœ€è¦å¾ç”¨æˆ¶æä¾›çš„å®Œæ•´æ–‡æœ¬ä¸­ç³»çµ±æ€§æå–');
    console.log('   å»ºè­°ï¼šå°‡å®Œæ•´æ–‡æœ¬ä¿å­˜åˆ°æ–‡ä»¶ï¼Œç„¶å¾Œä½¿ç”¨æ›´ç²¾ç¢ºçš„è§£æé‚è¼¯');
}

module.exports = { extractAllData, parseFullText };
