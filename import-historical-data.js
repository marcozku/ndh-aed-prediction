/**
 * Ê≠∑Âè≤Êï∏ÊìöÂ∞éÂÖ•ËÖ≥Êú¨
 * Ëß£Êûê‰∏¶Â∞éÂÖ•Âæû 2014-12-01 Âà∞ 2025-12-06 ÁöÑÊ≠∑Âè≤Êï∏Êìö
 */

const { initDatabase, insertBulkActualData } = require('./database');

// Áç≤ÂèñÈ¶ôÊ∏ØÊôÇÈñìÁöÑÊó•ÊúüÂ≠óÁ¨¶‰∏≤ÔºàÁî®ÊñºÊó•Ë™åÔºâ
function getHKTimeStr() {
    const now = new Date();
    const hkFormatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Asia/Hong_Kong',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    
    const parts = hkFormatter.formatToParts(now);
    const getPart = (type) => parts.find(p => p.type === type)?.value || '00';
    
    return `${getPart('year')}-${getPart('month')}-${getPart('day')} ${getPart('hour')}:${getPart('minute')}:${getPart('second')}`;
}

// Áî®Êà∂Êèê‰æõÁöÑÂéüÂßãÊï∏ÊìöÔºàDD/MM/YYYY Á∑äÊé•ËëóÊï∏Â≠óÔºâ
const rawData = `01/12/201428402/12/201425303/12/201426204/12/201423305/12/201426006/12/201421707/12/201424508/12/201429209/12/201428810/12/201427711/12/201428312/12/201425013/12/201422814/12/201428615/12/201429316/12/201426817/12/201424718/12/201423419/12/201423520/12/201428121/12/201427522/12/201427023/12/201431124/12/201428225/12/201426426/12/201431427/12/201431128/12/201428329/12/201431130/12/201432731/12/201429601/01/201528102/01/201531203/01/201531004/01/201530305/01/201536906/01/201532307/01/201529208/01/201528209/01/201529510/01/201528611/01/201530812/01/201529213/01/201530314/01/201530115/01/201530416/01/201532917/01/201532018/01/201532419/01/201535220/01/201533121/01/201534722/01/201534923/01/201534524/01/201533925/01/201532226/01/201534327/01/201536028/01/201535029/01/201532130/01/201534731/01/201529701/02/201531802/02/201538903/02/201534904/02/201530105/02/201526706/02/201528107/02/201527508/02/201526009/02/201530410/02/201529111/02/201531712/02/201529013/02/201526914/02/201524615/02/201530516/02/201527417/02/201524218/02/201521019/02/201523720/02/201530621/02/201532422/02/201528223/02/201529424/02/201524625/02/201525626/02/201527927/02/201526328/02/201525101/03/201526302/03/201527403/03/201528704/03/201525305/03/201525306/03/201526207/03/201520708/03/201524009/03/201530210/03/201526711/03/201526912/03/201523513/03/201525314/03/201527515/03/201527816/03/201532217/03/201530918/03/201528819/03/201532020/03/201530921/03/201529322/03/201528123/03/201531624/03/201528325/03/201529426/03/201526827/03/201529028/03/201528829/03/201526130/03/201533431/03/201529701/04/201527102/04/201528503/04/201530304/04/201531805/04/201531806/04/201532707/04/201530208/04/201528009/04/201528910/04/201526211/04/201527212/04/201526813/04/201531214/04/201530515/04/201528516/04/201527917/04/201529118/04/201529719/04/201529320/04/201534421/04/201531522/04/201528823/04/201531224/04/201527125/04/201527526/04/201528027/04/201531828/04/201532429/04/201530030/04/201530101/05/201528402/05/201527503/05/201530404/05/201534905/05/201529506/05/201527507/05/201527308/05/201527909/05/201528710/05/201528211/05/201528212/05/201533013/05/201530114/05/201531515/05/201527116/05/201526117/05/201529918/05/201529619/05/201527220/05/201526321/05/201529922/05/201529423/05/201526824/05/201528525/05/201533026/05/201531127/05/201532428/05/201531829/05/201533930/05/201530931/05/201531301/06/201535902/06/201530403/06/201532404/06/201532205/06/201533606/06/201530007/06/201531908/06/201534309/06/201531510/06/201530511/06/201534212/06/201529713/06/201528714/06/201529015/06/201531316/06/201531917/06/201530318/06/201530619/06/201526820/06/201529621/06/201530822/06/201534923/06/201531924/06/201531225/06/201530126/06/201532227/06/201531228/06/201532829/06/201539430/06/201532601/07/201530402/07/201533403/07/201531204/07/201529905/07/201529306/07/201534807/07/201528608/07/201528509/07/201526610/07/201527411/07/201530212/07/201530013/07/201531914/07/201530515/07/201530116/07/201529617/07/201529418/07/201525519/07/201530420/07/201531321/07/201525722/07/201527023/07/201527424/07/201524625/07/201526026/07/201529127/07/201531428/07/201527729/07/201526930/07/201526831/07/201526801/08/201526402/08/201525903/08/201527004/08/201528805/08/201526806/08/201529107/08/201526808/08/201525609/08/201525810/08/201529111/08/201528212/08/201528713/08/201527814/08/201526315/08/201527116/08/201526717/08/201530518/08/201525719/08/201529220/08/201527621/08/201524222/08/201526723/08/201528524/08/201532025/08/201529126/08/201526427/08/201528628/08/201526429/08/201527730/08/201525131/08/201529801/09/201529402/09/201525503/09/201526404/09/201529005/09/201528006/09/201528707/09/201530508/09/201528009/09/201529510/09/201528811/09/201529612/09/201527613/09/201529614/09/201531115/09/201530816/09/201528017/09/201527318/09/201531319/09/201529220/09/201530921/09/201530522/09/201531330/10/201526531/10/201527401/11/201525102/11/201530103/11/201531204/11/201527505/11/201529106/11/201531507/11/201527908/11/201527109/11/201536010/11/201529411/11/201528212/11/201530213/11/201525714/11/201528615/11/201528616/11/201526917/11/201530518/11/201532019/11/201531420/11/201529321/11/201527022/11/201531923/11/201532124/11/201530625/11/201526626/11/201524427/11/201527728/11/201528129/11/201526830/11/201531901/12/201530202/12/201526203/12/201527104/12/201527005/12/201525406/12/201524607/12/201527308/12/201528209/12/201522510/12/201528811/12/201526412/12/201525113/12/201528214/12/201533215/12/201527016/12/201524717/12/201529718/12/201529019/12/201525020/12/201521421/12/201529522/12/201530123/12/201526024/12/201530725/12/201525926/12/201527927/12/201527928/12/201529129/12/201529930/12/201527531/12/201525201/01/201626402/01/201628303/01/201626604/01/201636005/01/201627306/01/201631307/01/201629608/01/201628609/01/201628210/01/201629011/01/201627912/01/201626413/01/201630614/01/201626015/01/201626016/01/201625817/01/201625618/01/201633019/01/201628320/01/201629521/01/201629622/01/201624123/01/201622724/01/201622525/01/201629726/01/201630527/01/201632328/01/201630629/01/201631530/01/201632531/01/201630301/02/201630002/02/201630303/02/201629704/02/201629905/02/201628606/02/201627807/02/201628208/02/201632609/02/201639410/02/201638911/02/201637912/02/201635113/02/201631114/02/201632215/02/201629016/02/201630317/02/201629518/02/201627619/02/201635720/02/201630021/02/201632422/02/201634223/02/201630024/02/201629225/02/201630426/02/201633727/02/201632528/02/201631429/02/201635701/03/201636102/03/201631803/03/201631504/03/201633505/03/201633606/03/201632607/03/201635908/03/201633609/03/201627310/03/201625311/03/201626712/03/201622913/03/201628014/03/201629515/03/201629616/03/201623217/03/201629118/03/201628219/03/201625220/03/201629821/03/201628322/03/201631223/03/201626524/03/201623725/03/201629026/03/201631327/03/201629528/03/201633429/03/201628430/03/201628031/03/201627901/04/201629102/04/201631803/04/201630104/04/201631605/04/201633806/04/201631907/04/201630508/04/201632209/04/201631010/04/201631611/04/201632312/04/201628213/04/201627514/04/201630615/04/201628916/04/201630317/04/201630518/04/201633119/04/201629020/04/201627921/04/201632622/04/201629323/04/201629924/04/201627625/04/201633526/04/201630627/04/201629728/04/201631129/04/201628130/04/201631301/05/201628502/05/201631203/05/201633304/05/201628905/05/201631006/05/201634207/05/201630608/05/201633609/05/201633710/05/201629411/05/201629812/05/201633713/05/201628314/05/201631915/05/201630716/05/201635517/05/201633518/05/201630919/05/201630320/05/201629221/05/201631322/05/201631923/05/201633324/05/201630625/05/201630626/05/201628027/05/201628528/05/201627929/05/201630230/05/201635931/05/201632701/06/201628902/06/201631110/07/201626811/07/201628112/07/201628213/07/201627314/07/201629315/07/201629116/07/201625117/07/201625418/07/201630019/07/201628920/07/201629321/07/201630122/07/201629423/07/201623924/07/201630225/07/201627826/07/201629427/07/201627828/07/201629629/07/201627030/07/201624431/07/201627201/08/201629302/08/201620203/08/201628504/08/201626105/08/201631606/08/201625407/08/201630208/08/201629209/08/201631310/08/201629111/08/201629512/08/201628813/08/201624914/08/201624015/08/201629301/12/201625802/12/201627903/12/201625904/12/201629705/12/201634506/12/201629707/12/201630608/12/201629309/12/201630810/12/201628011/12/201630412/12/201631113/12/201629514/12/201627715/12/201629316/12/201626217/12/201627018/12/201628719/12/201628620/12/201632621/12/201627422/12/201630023/12/201627624/12/201623125/12/201626726/12/201629027/12/201626128/12/201627929/12/201627630/12/201626531/12/201625301/01/201728802/01/201729603/01/201729204/01/201728905/01/201728806/01/201727107/01/201728808/01/201727809/01/201729410/01/201728311/01/201725212/01/201725913/01/201725914/01/201723815/01/201724816/01/201729517/01/201728018/01/201727419/01/201728220/01/201726021/01/201722322/01/201725223/01/201728824/01/201724125/01/201727226/01/201723827/01/201720428/01/201721729/01/201725130/01/201732431/01/201727001/02/201727902/02/201723003/02/201726304/02/201727405/02/201726606/02/201729107/02/201728708/02/201729009/02/201724710/02/201727511/02/201721312/02/201726613/02/201733214/02/201728615/02/201728016/02/201729717/02/201729718/02/201726019/02/201725420/02/201735621/02/201728922/02/201729423/02/201729324/02/201727725/02/201722326/02/201727527/02/201731728/02/201728601/03/201730202/03/201726403/03/201728304/03/201729005/03/201730606/03/201732207/03/201731508/03/201726009/03/201727810/03/201730011/03/201725912/03/201727013/03/201735414/03/201732315/03/201728516/03/201729517/03/201729218/03/201729619/03/201727320/03/201733421/03/201731622/03/201728523/03/201730824/03/201731725/03/201726826/03/201724127/03/201728328/03/201731129/03/201729330/03/201731931/03/201727201/04/201728002/04/201729703/04/201730804/04/201726705/04/201733806/04/201729807/04/201727808/04/201728609/04/201726710/04/201732911/04/201731412/04/201728613/04/201729514/04/201728815/04/201727116/04/201727917/04/201732818/04/201733919/04/201731420/04/201728821/04/201729322/04/201727823/04/201728924/04/201732025/04/201730526/04/201730327/04/201728628/04/201730829/04/201730230/04/201731601/05/201732402/05/201734403/05/201728704/05/201730305/05/201729206/05/201731207/05/201729308/05/201734309/05/201730810/05/201731211/05/201729512/05/201728713/05/201726314/05/201729115/05/201733816/05/201734417/05/201732818/05/201731919/05/201730020/05/201730321/05/201729122/05/201733923/05/201727424/05/201728325/05/201727726/05/201729827/05/201728128/05/201729529/05/201733730/05/201729731/05/202527601/12/202527602/12/202528503/12/202525304/12/202523405/12/202526206/12/2025234`;

/**
 * Ëß£ÊûêÂéüÂßãÊï∏ÊìöÂ≠óÁ¨¶‰∏≤
 * Ê†ºÂºèÔºöDD/MM/YYYY Á∑äÊé•ËëóÊï∏Â≠óÔºà‰æãÂ¶ÇÔºö01/12/2014284Ôºâ
 */
function parseRawData(rawDataStr) {
    const results = [];
    let i = 0;
    
    while (i < rawDataStr.length) {
        // Êü•ÊâæÊó•ÊúüÊ®°Âºè DD/MM/YYYY
        const dateMatch = rawDataStr.substring(i).match(/^(\d{2})\/(\d{2})\/(\d{4})/);
        
        if (!dateMatch) {
            // Â¶ÇÊûúÊâæ‰∏çÂà∞Êó•ÊúüÊ®°ÂºèÔºåË∑≥ÈÅéÁï∂ÂâçÂ≠óÁ¨¶
            i++;
            continue;
        }
        
        const day = dateMatch[1];
        const month = dateMatch[2];
        const year = dateMatch[3];
        
        // Ë∑≥ÈÅéÊó•ÊúüÈÉ®ÂàÜÔºà10ÂÄãÂ≠óÁ¨¶ÔºöDD/MM/YYYYÔºâ
        i += 10;
        
        // ÊèêÂèñÊï∏Â≠óÈÉ®ÂàÜÔºàÁõ¥Âà∞‰∏ã‰∏ÄÂÄãÊó•ÊúüÊàñÂ≠óÁ¨¶‰∏≤ÁµêÊùüÔºâ
        let numberStr = '';
        while (i < rawDataStr.length && !rawDataStr.substring(i).match(/^\d{2}\/\d{2}\/\d{4}/)) {
            const char = rawDataStr[i];
            if (char >= '0' && char <= '9') {
                numberStr += char;
            } else {
                // ÈÅáÂà∞ÈùûÊï∏Â≠óÂ≠óÁ¨¶ÔºåÂÅúÊ≠¢ÊèêÂèñ
                break;
            }
            i++;
        }
        
        if (numberStr) {
            const patientCount = parseInt(numberStr, 10);
            if (!isNaN(patientCount)) {
                // ËΩâÊèõÊó•ÊúüÊ†ºÂºèÂæû DD/MM/YYYY Âà∞ YYYY-MM-DD
                const dateStr = `${year}-${month}-${day}`;
                results.push({
                    date: dateStr,
                    patient_count: patientCount
                });
            }
        }
    }
    
    return results;
}

/**
 * ‰∏ªÂáΩÊï∏ÔºöÂ∞éÂÖ•Ê≠∑Âè≤Êï∏Êìö
 * @param {boolean} skipInit - ÊòØÂê¶Ë∑≥ÈÅéÊï∏ÊìöÂ∫´ÂàùÂßãÂåñÔºàÂ¶ÇÊûúÂ∑≤Á∂ìÂàùÂßãÂåñÂâáÂÇ≥ trueÔºâ
 * @param {object} dbInstance - ÂèØÈÅ∏ÁöÑÊï∏ÊìöÂ∫´ÂØ¶‰æãÔºàÂ¶ÇÊûúÊèê‰æõÂâá‰ΩøÁî®ÔºåÂê¶Ââá‰ΩøÁî®ÈªòË™çÁöÑÔºâ
 */
async function importHistoricalData(skipInit = false, dbInstance = null) {
    console.log('üìä ÈñãÂßãÂ∞éÂÖ•Ê≠∑Âè≤Êï∏Êìö...');
    console.log(`üïê ÈñãÂßãÊôÇÈñì: ${getHKTimeStr()} HKT`);
    
    try {
        // ‰ΩøÁî®Êèê‰æõÁöÑ db ÂØ¶‰æãÊàñÂàùÂßãÂåñÊï∏ÊìöÂ∫´
        let db = dbInstance;
        if (!db) {
            // ÂàùÂßãÂåñÊï∏ÊìöÂ∫´ÔºàÂ¶ÇÊûúÂ∞öÊú™ÂàùÂßãÂåñÔºâ
            if (!skipInit) {
                await initDatabase();
                console.log('‚úÖ Êï∏ÊìöÂ∫´ÂàùÂßãÂåñÂÆåÊàê');
            }
            // Áç≤ÂèñÊï∏ÊìöÂ∫´ÂØ¶‰æã
            const dbModule = require('./database');
            db = dbModule;
        }
        
        // Ëß£ÊûêÂéüÂßãÊï∏Êìö
        console.log('üìù Ëß£ÊûêÂéüÂßãÊï∏Êìö...');
        const parsedData = parseRawData(rawData);
        console.log(`‚úÖ ÊàêÂäüËß£Êûê ${parsedData.length} Á≠ÜÊï∏Êìö`);
        
        // ËΩâÊèõÁÇ∫Êï∏ÊìöÂ∫´Ê†ºÂºè
        const dataToInsert = parsedData.map(d => ({
            date: d.date,
            patient_count: d.patient_count,
            source: 'historical_bulk_import',
            notes: `ÊâπÈáèÂ∞éÂÖ•ÁöÑÊ≠∑Âè≤Êï∏ÊìöÔºà2014-12-01 Ëá≥ 2025-12-06Ôºâ`
        }));
        
        // ÊâπÈáèÊèíÂÖ•Êï∏Êìö
        console.log('üíæ ÈñãÂßãÊèíÂÖ•Êï∏ÊìöÂà∞Êï∏ÊìöÂ∫´...');
        const results = await db.insertBulkActualData(dataToInsert);
        console.log(`‚úÖ ÊàêÂäüÂ∞éÂÖ• ${results.length} Á≠ÜÊ≠∑Âè≤Êï∏ÊìöÂà∞Êï∏ÊìöÂ∫´`);
        
        // È°ØÁ§∫Áµ±Ë®à‰ø°ÊÅØ
        const dateRange = {
            min: parsedData.reduce((min, d) => d.date < min ? d.date : min, parsedData[0].date),
            max: parsedData.reduce((max, d) => d.date > max ? d.date : max, parsedData[0].date)
        };
        console.log(`üìÖ Êï∏ÊìöÊó•ÊúüÁØÑÂúç: ${dateRange.min} Ëá≥ ${dateRange.max}`);
        
        const patientCountStats = {
            min: Math.min(...parsedData.map(d => d.patient_count)),
            max: Math.max(...parsedData.map(d => d.patient_count)),
            avg: Math.round(parsedData.reduce((sum, d) => sum + d.patient_count, 0) / parsedData.length)
        };
        console.log(`üìä ÁóÖ‰∫∫Êï∏ÈáèÁµ±Ë®à: ÊúÄÂ∞è ${patientCountStats.min}, ÊúÄÂ§ß ${patientCountStats.max}, Âπ≥Âùá ${patientCountStats.avg}`);
        
        console.log(`üïê ÂÆåÊàêÊôÇÈñì: ${getHKTimeStr()} HKT`);
        console.log('‚úÖ Ê≠∑Âè≤Êï∏ÊìöÂ∞éÂÖ•ÂÆåÊàêÔºÅ');
        
        return results;
    } catch (error) {
        console.error('‚ùå Â∞éÂÖ•Ê≠∑Âè≤Êï∏ÊìöÂ§±Êïó:', error);
        console.error('ÈåØË™§Ë©≥ÊÉÖ:', error.stack);
        throw error; // ÈáçÊñ∞ÊããÂá∫ÈåØË™§ÔºåËÆìË™øÁî®ËÄÖËôïÁêÜ
    }
}

// Âü∑Ë°åÂ∞éÂÖ•ÔºàÂÉÖÂú®Áõ¥Êé•ÈÅãË°åÊôÇÔºâ
if (require.main === module) {
    importHistoricalData().then(() => {
        process.exit(0);
    }).catch((error) => {
        process.exit(1);
    });
}

// Â∞éÂá∫ rawData ‰ª•‰æøÊ∏¨Ë©¶
module.exports = { parseRawData, importHistoricalData, rawData };
