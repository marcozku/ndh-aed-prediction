/**
 * å¾åŸå§‹å ±å‘Šæ•¸æ“šä¸­æå–æ—¥æœŸå’Œå°±è¨ºäººæ•¸
 * æ•¸æ“šä¾†æºï¼šHospital Authority Accident & Emergency Department Attendance Summary
 */

const fs = require('fs');
const path = require('path');

// å¾ç”¨æˆ¶æä¾›çš„åŸå§‹æ•¸æ“šä¸­æå–
const rawData = `
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11207/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date07/01/201629608/01/201628609/01/201628210/01/201629011/01/201627912/01/201626413/01/201630614/01/201626015/01/201626016/01/201625817/01/201625618/01/201633019/01/201628320/01/201629521/01/201629622/01/201624123/01/201622724/01/201622525/01/201629726/01/201630527/01/201632328/01/201630629/01/201631530/01/201632531/01/201630301/02/201630002/02/201630303/02/201629704/02/201629905/02/201628606/02/201627807/02/201628208/02/201632609/02/201639410/02/201638911/02/201637912/02/201635107/12/202517:45
Date :Time :
296286282290279264306260260258256330283295296241227225297305323306315325303300303297299286278282326394389379351
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)07/01/201608/01/201609/01/201610/01/201611/01/201612/01/201613/01/201614/01/201615/01/201616/01/201617/01/201618/01/201619/01/201620/01/201621/01/201622/01/201623/01/201624/01/201625/01/201626/01/201627/01/201628/01/201629/01/201630/01/201631/01/201601/02/201602/02/201603/02/201604/02/201605/02/201606/02/201607/02/201608/02/201609/02/201610/02/201611/02/201612/02/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
2
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11307/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date13/02/201631114/02/201632215/02/201629016/02/201630317/02/201629518/02/201627619/02/201635720/02/201630021/02/201632422/02/201634223/02/201630024/02/201629225/02/201630426/02/201633727/02/201632528/02/201631429/02/201635701/03/201636102/03/201631803/03/201631504/03/201633505/03/201633606/03/201632607/03/201635908/03/201633609/03/201627310/03/201625311/03/201626712/03/201622913/03/201628014/03/201629515/03/201629616/03/201623217/03/201629118/03/201628219/03/201625220/03/201629807/12/202517:45
Date :Time :
311322290303295276357300324342300292304337325314357361318315335336326359336273253267229280295296232291282252298
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)13/02/201614/02/201615/02/201616/02/201617/02/201618/02/201619/02/201620/02/201621/02/201622/02/201623/02/201624/02/201625/02/201626/02/201627/02/201628/02/201629/02/201601/03/201602/03/201603/03/201604/03/201605/03/201606/03/201607/03/201608/03/201609/03/201610/03/201611/03/201612/03/201613/03/201614/03/201615/03/201616/03/201617/03/201618/03/201619/03/201620/03/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
3
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11407/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date21/03/201628322/03/201631223/03/201626524/03/201623725/03/201629026/03/201631327/03/201629528/03/201633429/03/201628430/03/201628031/03/201627901/04/201629102/04/201631803/04/201630104/04/201631605/04/201633806/04/201631907/04/201630508/04/201632209/04/201631010/04/201631611/04/201632312/04/201628213/04/201627514/04/201630615/04/201628916/04/201630317/04/201630518/04/201633119/04/201629020/04/201627921/04/201632622/04/201629323/04/201629924/04/201627625/04/201633526/04/201630607/12/202517:45
Date :Time :
283312265237290313295334284280279291318301316338319305322310316323282275306289303305331290279326293299276335306
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)21/03/201622/03/201623/03/201624/03/201625/03/201626/03/201627/03/201628/03/201629/03/201630/03/201631/03/201601/04/201602/04/201603/04/201604/04/201605/04/201606/04/201607/04/201608/04/201609/04/201610/04/201611/04/201612/04/201613/04/201614/04/201615/04/201616/04/201617/04/201618/04/201619/04/201620/04/201621/04/201622/04/201623/04/201624/04/201625/04/201626/04/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
4
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11507/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date27/04/201629728/04/201631129/04/201628130/04/201631301/05/201628502/05/201631203/05/201633304/05/201628905/05/201631006/05/201634207/05/201630608/05/201633609/05/201633710/05/201629411/05/201629812/05/201633713/05/201628314/05/201631915/05/201630716/05/201635517/05/201633518/05/201630919/05/201630320/05/201629221/05/201631322/05/201631923/05/201633324/05/201630625/05/201630626/05/201628027/05/201628528/05/201627929/05/201630230/05/201635931/05/201632701/06/201628902/06/201631107/12/202517:45
Date :Time :
297311281313285312333289310342306336337294298337283319307355335309303292313319333306306280285279302359327289311
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)27/04/201628/04/201629/04/201630/04/201601/05/201602/05/201603/05/201604/05/201605/05/201606/05/201607/05/201608/05/201609/05/201610/05/201611/05/201612/05/201613/05/201614/05/201615/05/201616/05/201617/05/201618/05/201619/05/201620/05/201621/05/201622/05/201623/05/201624/05/201625/05/201626/05/201627/05/201628/05/201629/05/201630/05/201631/05/201601/06/201602/06/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
5
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11607/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date03/06/201631604/06/201627205/06/201628606/06/201628907/06/201630008/06/201626809/06/201629610/06/201629911/06/201625112/06/201625713/06/201630914/06/201628415/06/201631316/06/201629317/06/201629218/06/201627319/06/201625020/06/201633121/06/201627222/06/201628623/06/201629924/06/201629525/06/201629226/06/201631527/06/201630928/06/201627729/06/201628930/06/201633501/07/201628302/07/201627703/07/201627804/07/201631005/07/201630806/07/201629407/07/201628808/07/201630409/07/201629007/12/202517:45
Date :Time :
316272286289300268296299251257309284313293292273250331272286299295292315309277289335283277278310308294288304290
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)03/06/201604/06/201605/06/201606/06/201607/06/201608/06/201609/06/201610/06/201611/06/201612/06/201613/06/201614/06/201615/06/201616/06/201617/06/201618/06/201619/06/201620/06/201621/06/201622/06/201623/06/201624/06/201625/06/201626/06/201627/06/201628/06/201629/06/201630/06/201601/07/201602/07/201603/07/201604/07/201605/07/201606/07/201607/07/201608/07/201609/07/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
6
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11707/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date10/07/201626811/07/201628112/07/201628213/07/201627314/07/201629315/07/201629116/07/201625117/07/201625418/07/201630019/07/201628920/07/201629321/07/201630122/07/201629423/07/201623924/07/201630225/07/201627826/07/201629427/07/201627828/07/201629629/07/201627030/07/201624431/07/201627201/08/201629302/08/201620203/08/201628504/08/201626105/08/201631606/08/201625407/08/201630208/08/201629209/08/201631310/08/201629111/08/201629512/08/201628813/08/201624914/08/201624015/08/201629307/12/202517:45
Date :Time :
268281282273293291251254300289293301294239302278294278296270244272293202285261316254302292313291295288249240293
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)10/07/201611/07/201612/07/201613/07/201614/07/201615/07/201616/07/201617/07/201618/07/201619/07/201620/07/201621/07/201622/07/201623/07/201624/07/201625/07/201626/07/201627/07/201628/07/201629/07/201630/07/201631/07/201601/08/201602/08/201603/08/201604/08/201605/08/201606/08/201607/08/201608/08/201609/08/201610/08/201611/08/201612/08/201613/08/201614/08/201615/08/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
7
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11807/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date16/08/201624317/08/201626518/08/201626119/08/201628020/08/201629821/08/201628922/08/201630123/08/201630624/08/201630225/08/201632426/08/201627627/08/201625128/08/201626129/08/201628830/08/201632031/08/201631601/09/201626802/09/201629703/09/201626404/09/201627505/09/201632106/09/201629107/09/201629708/09/201628909/09/201628410/09/201630011/09/201630712/09/201635313/09/201628114/09/201627715/09/201626516/09/201632517/09/201633418/09/201630919/09/201637820/09/201627521/09/201630807/12/202517:45
Date :Time :
243265261280298289301306302324276251261288320316268297264275321291297289284300307353281277265325334309378275308
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)16/08/201617/08/201618/08/201619/08/201620/08/201621/08/201622/08/201623/08/201624/08/201625/08/201626/08/201627/08/201628/08/201629/08/201630/08/201631/08/201601/09/201602/09/201603/09/201604/09/201605/09/201606/09/201607/09/201608/09/201609/09/201610/09/201611/09/201612/09/201613/09/201614/09/201615/09/201616/09/201617/09/201618/09/201619/09/201620/09/201621/09/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
8
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of11907/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date22/09/201632823/09/201629324/09/201630725/09/201630526/09/201634827/09/201633728/09/201635529/09/201629530/09/201629901/10/201627802/10/201629303/10/201632604/10/201632705/10/201629806/10/201628607/10/201629508/10/201627309/10/201629910/10/201631111/10/201636612/10/201629213/10/201631214/10/201630815/10/201626916/10/201629717/10/201632518/10/201624919/10/201628220/10/201630321/10/201623222/10/201633223/10/201631924/10/201633625/10/201628526/10/201629527/10/201630228/10/201629407/12/202517:45
Date :Time :
328293307305348337355295299278293326327298286295273299311366292312308269297325249282303232332319336285295302294
Attendance
Hospital Authority
North District Hospital
Reg. date
Attendance Summary (by Date)22/09/201623/09/201624/09/201625/09/201626/09/201627/09/201628/09/201629/09/201630/09/201601/10/201602/10/201603/10/201604/10/201605/10/201606/10/201607/10/201608/10/201609/10/201610/10/201611/10/201612/10/201613/10/201614/10/201615/10/201616/10/201617/10/201618/10/201619/10/201620/10/201621/10/202622/10/201623/10/201624/10/201625/10/201626/10/201627/10/201628/10/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
9
AE_ATT02
ID :
Page : For Period:
Hospital AuthorityAccident & Emergency DepartmentAttendance Summary (by Date)ID :Page :AE_ATT02of111007/12/202517:45Time :Date :North District HospitalAttendanceFor Period:01/12/2015to01/12/2016Reg. date29/10/201628230/10/201630131/10/201629901/11/201626702/11/201629103/11/201626504/11/201626305/11/201627906/11/201626707/11/201632608/11/201629809/11/201624710/11/201626211/11/201628512/11/201627213/11/201628714/11/201633415/11/201629416/11/201630217/11/201633218/11/201631919/11/201628720/11/201627921/11/201633822/11/201629423/11/201622824/11/201626325/11/201626026/11/201626027/11/201624328/11/201630429/11/201626830/11/201624501/12/2016258Total107,946Average29407/12/202517:45
Date :Time :
282301299267291265263279267326298247262285272287334294302332319287279338294228263260260243304268245258 294
107,946
Attendance
Hospital Authority
North District Hospital Total
Average
Reg. date
Attendance Summary (by Date)29/10/201630/10/201631/10/201601/11/201602/11/201603/11/201604/11/201605/11/201606/11/201607/11/201608/11/201609/11/201610/11/201611/11/201612/11/201613/11/201614/11/201615/11/201616/11/201617/11/201618/11/201619/11/201620/11/201621/11/201622/11/201623/11/201624/11/201625/11/201626/11/201627/11/201628/11/201629/11/201630/11/201601/12/2016
Accident & Emergency Department
01/12/2016
to
11 01/12/2015
of
10
AE_ATT02
ID :
Page : For Period:
*** End of Report ****** End of Report ***
`;

/**
 * è§£æåŸå§‹å ±å‘Šæ•¸æ“šï¼Œæå–æ—¥æœŸå’Œå°±è¨ºäººæ•¸
 */
function extractAEDData(rawText) {
    const data = [];
    
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼åŒ¹é…æ—¥æœŸå’Œæ•¸å­—æ¨¡å¼
    // æ—¥æœŸæ ¼å¼ï¼šDD/MM/YYYY
    const datePattern = /(\d{2}\/\d{2}\/\d{4})/g;
    // æ•¸å­—æ¨¡å¼ï¼š3ä½æ•¸å­—ï¼ˆå°±è¨ºäººæ•¸ï¼‰
    const numberPattern = /\b(\d{3,4})\b/g;
    
    // å°‡æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²
    const lines = rawText.split('\n');
    
    let currentYear = null;
    let dates = [];
    let attendances = [];
    
    for (let line of lines) {
        // æå–æ—¥æœŸ
        const dateMatches = line.match(datePattern);
        if (dateMatches) {
            dates.push(...dateMatches);
        }
        
        // æå–æ•¸å­—ï¼ˆå¯èƒ½æ˜¯å°±è¨ºäººæ•¸ï¼‰
        // åªæå–3-4ä½æ•¸å­—ï¼ˆå°±è¨ºäººæ•¸é€šå¸¸åœ¨100-9999ä¹‹é–“ï¼‰
        const numberMatches = line.match(/\b(\d{3,4})\b/g);
        if (numberMatches) {
            // éæ¿¾æ‰æ˜é¡¯ä¸æ˜¯å°±è¨ºäººæ•¸çš„æ•¸å­—ï¼ˆå¦‚å¹´ä»½ã€é ç¢¼ç­‰ï¼‰
            const validNumbers = numberMatches.filter(num => {
                const n = parseInt(num);
                // æ’é™¤å¹´ä»½ç¯„åœ
                if (n >= 2015 && n <= 2025) return false;
                // æ’é™¤é ç¢¼ï¼ˆé€šå¸¸å¾ˆå°ï¼‰
                if (n < 100) return false;
                // æ’é™¤ç¸½è¨ˆå’Œå¹³å‡å€¼ï¼ˆé€šå¸¸å¾ˆå¤§ï¼‰
                if (n > 10000) return false;
                return true;
            });
            attendances.push(...validNumbers);
        }
    }
    
    // é…å°æ—¥æœŸå’Œå°±è¨ºäººæ•¸
    // ç”±æ–¼æ•¸æ“šæ ¼å¼ä¸è¦å‰‡ï¼Œæˆ‘å€‘éœ€è¦æ›´æ™ºèƒ½çš„åŒ¹é…
    // å°‹æ‰¾ "Reg. date" å¾Œé¢çš„æ—¥æœŸåºåˆ—å’Œå°æ‡‰çš„æ•¸å­—åºåˆ—
    
    // é‡æ–°è§£æï¼šå°‹æ‰¾æ—¥æœŸå’Œæ•¸å­—çš„é…å°æ¨¡å¼
    const sections = rawText.split(/Reg\. date|Date :Time :/);
    
    for (let section of sections) {
        // æå–æ—¥æœŸ
        const sectionDates = section.match(/(\d{2}\/\d{2}\/\d{4})/g) || [];
        
        // æå–æ•¸å­—ï¼ˆå°±è¨ºäººæ•¸ï¼‰
        // å°‹æ‰¾ç·Šè·Ÿåœ¨æ—¥æœŸå¾Œé¢çš„æ•¸å­—åºåˆ—
        const numbers = section.match(/\b(\d{3,4})\b/g) || [];
        
        // éæ¿¾æ•¸å­—
        const validNumbers = numbers.filter(num => {
            const n = parseInt(num);
            if (n >= 2015 && n <= 2025) return false;
            if (n < 100) return false;
            if (n > 10000) return false;
            return true;
        });
        
        // å¦‚æœæ—¥æœŸå’Œæ•¸å­—æ•¸é‡åŒ¹é…ï¼Œé€²è¡Œé…å°
        if (sectionDates.length > 0 && validNumbers.length > 0) {
            // å˜—è©¦é…å°
            const minLength = Math.min(sectionDates.length, validNumbers.length);
            for (let i = 0; i < minLength; i++) {
                const dateStr = sectionDates[i];
                const attendance = parseInt(validNumbers[i]);
                
                // è½‰æ›æ—¥æœŸæ ¼å¼å¾ DD/MM/YYYY åˆ° YYYY-MM-DD
                const [day, month, year] = dateStr.split('/');
                const isoDate = `${year}-${month}-${day}`;
                
                data.push({
                    date: isoDate,
                    attendance: attendance,
                    original_date: dateStr
                });
            }
        }
    }
    
    // å»é‡ï¼ˆåŸºæ–¼æ—¥æœŸï¼‰
    const uniqueData = [];
    const seenDates = new Set();
    
    for (let item of data) {
        if (!seenDates.has(item.date)) {
            seenDates.add(item.date);
            uniqueData.push(item);
        }
    }
    
    // æŒ‰æ—¥æœŸæ’åº
    uniqueData.sort((a, b) => a.date.localeCompare(b.date));
    
    return uniqueData;
}

/**
 * æ›´ç²¾ç¢ºçš„è§£ææ–¹æ³•ï¼šç›´æ¥å¾ç”¨æˆ¶æä¾›çš„å®Œæ•´æ•¸æ“šä¸­æå–
 */
function parseCompleteData() {
    // ç”±æ–¼æ•¸æ“šæ ¼å¼è¤‡é›œï¼Œæˆ‘å€‘æ‰‹å‹•æå–é—œéµéƒ¨åˆ†
    // å¾ç”¨æˆ¶æä¾›çš„æ•¸æ“šä¸­ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°æ—¥æœŸå’Œæ•¸å­—æ˜¯åˆ†é–‹åˆ—å‡ºçš„
    
    // é€™è£¡æˆ‘å€‘éœ€è¦è®€å–å®Œæ•´çš„ç”¨æˆ¶è¼¸å…¥æ•¸æ“š
    // ç”±æ–¼æ•¸æ“šå¤ªé•·ï¼Œæˆ‘å€‘å°‡å‰µå»ºä¸€å€‹æ›´ç³»çµ±çš„æ–¹æ³•
    
    const extractedData = [];
    
    // å®šç¾©æ¯å€‹å ±å‘ŠæœŸé–“çš„æ•¸æ“š
    // 2015-12-01 åˆ° 2016-12-01
    const data2016 = [
        // å¾åŸå§‹æ•¸æ“šä¸­æ‰‹å‹•æå–çš„é…å°
        // æ ¼å¼ï¼š{date: "YYYY-MM-DD", attendance: number}
        // ç”±æ–¼æ•¸æ“šæ ¼å¼æ··äº‚ï¼Œæˆ‘å€‘éœ€è¦æ›´ç³»çµ±çš„æ–¹æ³•
    ];
    
    return extractedData;
}

// å¦‚æœç›´æ¥é‹è¡Œæ­¤è…³æœ¬
if (require.main === module) {
    console.log('ğŸ“Š é–‹å§‹æå– AED æ•¸æ“š...');
    
    // è®€å–ç”¨æˆ¶æä¾›çš„å®Œæ•´æ•¸æ“šï¼ˆæ‡‰è©²å¾æ–‡ä»¶æˆ–æ¨™æº–è¼¸å…¥è®€å–ï¼‰
    // é€™è£¡æˆ‘å€‘å…ˆæ¸¬è©¦è§£æåŠŸèƒ½
    
    const result = extractAEDData(rawData);
    console.log(`âœ… æå–å®Œæˆï¼Œå…± ${result.length} ç­†æ•¸æ“š`);
    
    if (result.length > 0) {
        console.log('\nå‰10ç­†æ•¸æ“šï¼š');
        result.slice(0, 10).forEach(item => {
            console.log(`${item.date}: ${item.attendance}`);
        });
        
        // ä¿å­˜åˆ°æ–‡ä»¶
        const outputPath = path.join(__dirname, 'extracted-aed-data.json');
        fs.writeFileSync(outputPath, JSON.stringify(result, null, 2), 'utf8');
        console.log(`\nâœ… æ•¸æ“šå·²ä¿å­˜åˆ° ${outputPath}`);
        
        // ä¹Ÿä¿å­˜ç‚º CSV æ ¼å¼
        const csvPath = path.join(__dirname, 'extracted-aed-data.csv');
        const csvHeader = 'Date,Attendance\n';
        const csvContent = result.map(item => `${item.date},${item.attendance}`).join('\n');
        fs.writeFileSync(csvPath, csvHeader + csvContent, 'utf8');
        console.log(`âœ… CSV æ•¸æ“šå·²ä¿å­˜åˆ° ${csvPath}`);
    } else {
        console.log('âš ï¸ æœªèƒ½æå–åˆ°æ•¸æ“šï¼Œå¯èƒ½éœ€è¦èª¿æ•´è§£æé‚è¼¯');
    }
}

module.exports = { extractAEDData, parseCompleteData };
