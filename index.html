<!DOCTYPE html>
<html lang="zh-HK" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="description" content="NDH AED 病人數量預測系統 - 北區醫院急症室人流預測">
    <meta name="theme-color" content="#f8fafc" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="北區醫院預測">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=6">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png?v=6">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152.png?v=6">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120.png?v=6">
    <link rel="manifest" href="/manifest.json?v=6">
    
    <title>NDH AED 預測系統</title>
    <link rel="stylesheet" href="styles.css?v=6">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <!-- Sticky Navigation Bar -->
    <nav class="sticky-nav" id="sticky-nav" role="navigation" aria-label="主導航">
        <div class="nav-container">
            <div class="nav-brand">
                <img class="nav-logo" src="assets/ndh-logo.jpg" alt="NDH 北區醫院">
                <span class="nav-title">NDH AED</span>
            </div>
            <div class="nav-links">
                <a href="#today-section" class="nav-link active" data-section="today" aria-label="今日預測">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text" data-lang-key="nav-today">今日</span>
                </a>
                <a href="#forecast-section" class="nav-link" data-section="forecast" aria-label="7日預測">
                    <span class="nav-icon">📅</span>
                    <span class="nav-text" data-lang-key="nav-forecast">7日</span>
                </a>
                <a href="#charts-section" class="nav-link" data-section="charts" aria-label="歷史趨勢">
                    <span class="nav-icon">📈</span>
                    <span class="nav-text" data-lang-key="nav-history">趨勢</span>
                </a>
                <a href="#model-training-section" class="nav-link" data-section="training" aria-label="模型訓練">
                    <span class="nav-icon">🤖</span>
                    <span class="nav-text" data-lang-key="nav-training">訓練</span>
                </a>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn" id="notify-btn" title="通知設定" aria-label="通知設定">
                    <span>🔔</span>
                </button>
                <button class="nav-action-btn" id="theme-toggle" title="切換主題 (Ctrl+D)" aria-label="切換深色模式">
                    <span class="theme-icon">🌙</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="back-to-top" title="返回頂部 (Home)" aria-label="返回頂部">
        <span>↑</span>
    </button>

    <!-- Notification Toast Container -->
    <div class="toast-container" id="toast-container" role="alert" aria-live="polite"></div>

    <!-- 主容器 -->
    <div class="app-container" id="app-container">
        <!-- 標題區 -->
        <header class="app-header" id="app-header">
            <div class="header-content">
                <h1 class="header-title" data-lang-key="app-title">NDH AED 病人數量預測系統</h1>
                <p class="header-subtitle" data-lang-key="app-subtitle">North District Hospital A&E Attendance Prediction</p>
                <div class="header-info">
                    <div class="current-datetime" id="current-datetime">
                        <span class="datetime-icon">⏱️</span>
                        <span class="datetime-text">載入中...</span>
                    </div>
                    <div class="weather-display" id="weather-display">
                        <span class="weather-loading">載入天氣資料...</span>
                    </div>
                    <div class="status-badges">
                        <div class="status-badge db-status loading" id="db-status">
                            <span class="status-icon">📊</span>
                            <span class="status-text">檢查數據庫連接...</span>
                        </div>
                        <div class="status-badge ai-status loading" id="ai-status">
                            <span class="status-icon">🤖</span>
                            <span class="status-text">檢查 AI 連接...</span>
                        </div>
                        <div class="status-badge auto-predict-status loading" id="auto-predict-status">
                            <span class="status-icon">🔮</span>
                            <span class="status-text">檢查自動預測...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 今日預測區塊 -->
        <section class="prediction-section today-section" id="today-section" aria-labelledby="today-section-title">
            <div class="section-loading" id="today-prediction-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text"><span data-lang-key="loading">載入中...</span> <span class="loading-percent" id="today-prediction-percent">0%</span></div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="today-prediction-progress"></div>
                </div>
            </div>
            <div class="prediction-grid" id="today-prediction-grid" style="display: none;">
                <!-- 主預測卡片 -->
                <div class="prediction-card main-prediction-card" id="main-prediction-card">
                    <div class="card-header">
                        <h2 class="card-title" data-lang-key="today-prediction">今日預測</h2>
                        <span class="date-badge" id="today-date">--</span>
                    </div>
                    
                    <!-- 平滑後最終預測 -->
                    <div class="smoothed-prediction-section">
                        <div class="prediction-type-label">
                            <span class="label-icon">📊</span>
                            <span class="label-text" data-lang-key="combined-prediction">綜合預測</span>
                            <span class="smoothing-method" id="smoothing-method" title="平滑方法">--</span>
                        </div>
                        <div class="prediction-value-container">
                            <div class="prediction-value">
                                <span class="big-number" id="today-predicted">--</span>
                                <span class="unit" data-lang-key="unit-people">人</span>
                            </div>
                        </div>
                        <div class="stability-indicator" id="stability-indicator">
                            <span class="stability-label" data-lang-key="stability">穩定性</span>
                            <span class="stability-value" id="stability-value">--</span>
                        </div>
                    </div>
                    
                    <!-- 實時最新預測 -->
                    <div class="realtime-prediction-section">
                        <div class="prediction-type-label realtime">
                            <span class="label-icon">⚡</span>
                            <span class="label-text" data-lang-key="realtime-prediction">實時預測</span>
                            <span class="realtime-time" id="realtime-time">--</span>
                        </div>
                        <div class="realtime-value-container">
                            <div class="realtime-value">
                                <span class="realtime-number" id="realtime-predicted">--</span>
                                <span class="unit" data-lang-key="unit-people">人</span>
                            </div>
                            <div class="realtime-diff" id="realtime-diff"></div>
                        </div>
                    </div>
                    
                    <div class="confidence-intervals">
                        <div class="ci-item">
                            <span class="ci-label" data-lang-key="ci-80">80% 信賴區間</span>
                            <span class="ci-value" id="today-ci80">-- - -- 人</span>
                        </div>
                        <div class="ci-item">
                            <span class="ci-label" data-lang-key="ci-95">95% 信賴區間</span>
                            <span class="ci-value" id="today-ci95">-- - -- 人</span>
                        </div>
                    </div>
                    <div class="factors-breakdown" id="factors-breakdown"></div>
                </div>

                <!-- 統計摘要卡片 -->
                <div class="prediction-card stats-card">
                    <div class="card-header">
                        <h2 class="card-title" data-lang-key="historical-stats">歷史統計</h2>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="stat-mean">--</span>
                            <span class="stat-label" data-lang-key="daily-avg">日均人數</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stat-max">--</span>
                            <span class="stat-label" data-lang-key="max-peak">最高峰</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stat-min">--</span>
                            <span class="stat-label" data-lang-key="min-trough">最低谷</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stat-std">--</span>
                            <span class="stat-label" data-lang-key="std-dev">標準差</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 實時影響因素 -->
        <section class="factors-section" id="factors-section">
            <div class="section-header">
                <h2 class="section-title" data-lang-key="realtime-factors">實時影響因素</h2>
                <button class="refresh-btn" id="ai-refresh-btn" onclick="forceRefreshAI()" title="強制重新分析">
                    <span class="refresh-icon">🔄</span>
                    <span class="refresh-text" data-lang-key="reanalyze">重新分析</span>
                </button>
            </div>
            <div class="section-loading" id="factors-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入中... <span class="loading-percent" id="factors-percent">0%</span></div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="factors-progress"></div>
                </div>
            </div>
            <div class="factors-container" id="factors-content" style="display: none;"></div>
        </section>

        <!-- 未來7天預測 -->
        <section class="forecast-section" id="forecast-section">
            <h2 class="section-title" data-lang-key="forecast-7days">未來 7 天預測</h2>
            <div class="section-loading" id="forecast-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入中... <span class="loading-percent" id="forecast-percent">0%</span></div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="forecast-progress"></div>
                </div>
            </div>
            <div class="forecast-cards" id="forecast-content" style="display: none;"></div>
        </section>

        <!-- 模型置信度儀表盤 -->
        <section class="confidence-dashboard" id="confidence-dashboard">
            <div class="section-header">
                <h2 class="section-title" data-lang-key="confidence-title">模型置信度</h2>
                <button class="info-btn" id="methodology-btn" title="了解預測方法論">
                    <span>ℹ️</span>
                    <span data-lang-key="methodology-btn">方法論</span>
                </button>
            </div>
            <div class="confidence-grid">
                <div class="confidence-item">
                    <div class="confidence-tooltip">
                        <div class="confidence-tooltip-title">📊 數據品質計算公式</div>
                        <div class="confidence-tooltip-formula">
                            總分 = 基礎 + 近期 + 覆蓋率
                        </div>
                        • 基礎分數 = min(數據天數/1000, 1) × 50<br>
                        • 近期分數 = (30天內數據/30) × 30<br>
                        • 覆蓋率 = 日期連續性 × 20
                    </div>
                    <div class="confidence-gauge" id="gauge-data-quality">
                        <svg viewBox="0 0 100 50">
                            <path class="gauge-bg" d="M10,45 A35,35 0 0,1 90,45"></path>
                            <path class="gauge-fill" id="gauge-fill-data" d="M10,45 A35,35 0 0,1 90,45"></path>
                        </svg>
                        <span class="gauge-value" id="gauge-value-data">--%</span>
                    </div>
                    <span class="confidence-label" data-lang-key="conf-data">數據品質</span>
                </div>
                <div class="confidence-item">
                    <div class="confidence-tooltip">
                        <div class="confidence-tooltip-title">🤖 模型擬合計算公式</div>
                        <div class="confidence-tooltip-formula">
                            擬合度 = R² × 100%
                        </div>
                        • R² = 模型解釋變異的比例<br>
                        • 訓練 R² = 0.958（95.8%）<br>
                        • 100% = 完美擬合歷史數據
                    </div>
                    <div class="confidence-gauge" id="gauge-model-fit">
                        <svg viewBox="0 0 100 50">
                            <path class="gauge-bg" d="M10,45 A35,35 0 0,1 90,45"></path>
                            <path class="gauge-fill" id="gauge-fill-model" d="M10,45 A35,35 0 0,1 90,45"></path>
                        </svg>
                        <span class="gauge-value" id="gauge-value-model">--%</span>
                    </div>
                    <span class="confidence-label" data-lang-key="conf-model">模型擬合</span>
                </div>
                <div class="confidence-item">
                    <div class="confidence-tooltip">
                        <div class="confidence-tooltip-title">🎯 近期準確度計算公式</div>
                        <div class="confidence-tooltip-formula">
                            準確度 = 100% - MAPE
                        </div>
                        • MAPE = Σ|實際-預測|/實際 / N<br>
                        • 基於最近 30 天比較<br>
                        • 目標：準確度 > 95%
                    </div>
                    <div class="confidence-gauge" id="gauge-recent-accuracy">
                        <svg viewBox="0 0 100 50">
                            <path class="gauge-bg" d="M10,45 A35,35 0 0,1 90,45"></path>
                            <path class="gauge-fill" id="gauge-fill-accuracy" d="M10,45 A35,35 0 0,1 90,45"></path>
                        </svg>
                        <span class="gauge-value" id="gauge-value-accuracy">--%</span>
                    </div>
                    <span class="confidence-label" data-lang-key="conf-accuracy">近期準確度</span>
                </div>
                <div class="confidence-item">
                    <div class="confidence-tooltip">
                        <div class="confidence-tooltip-title">📈 綜合置信度計算公式</div>
                        <div class="confidence-tooltip-formula">
                            綜合 = 數據×30% + 擬合×40% + 準確×30%
                        </div>
                        • 模型擬合權重最高（40%）<br>
                        • >90% = 高置信度 ✅<br>
                        • 70-90% = 中等 ⚡<br>
                        • <70% = 需審查 ⚠️
                    </div>
                    <div class="confidence-gauge" id="gauge-overall">
                        <svg viewBox="0 0 100 50">
                            <path class="gauge-bg" d="M10,45 A35,35 0 0,1 90,45"></path>
                            <path class="gauge-fill overall" id="gauge-fill-overall" d="M10,45 A35,35 0 0,1 90,45"></path>
                        </svg>
                        <span class="gauge-value" id="gauge-value-overall">--%</span>
                    </div>
                    <span class="confidence-label" data-lang-key="conf-overall">綜合置信度</span>
                </div>
            </div>
        </section>

        <!-- 圖表區域 -->
        <section class="charts-section" id="charts-section">
            <!-- 圖表控制工具列 -->
            <div class="chart-toolbar" id="chart-toolbar">
                <div class="toolbar-group">
                    <label class="toolbar-label" data-lang-key="chart-scale">Y軸縮放：</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="auto-scale-toggle" checked>
                        <label for="auto-scale-toggle">
                            <span class="toggle-option" data-lang-key="scale-auto">自動</span>
                            <span class="toggle-option" data-lang-key="scale-fixed">固定</span>
                        </label>
                    </div>
                </div>
                <div class="toolbar-group">
                    <label class="toolbar-label" data-lang-key="show-predictions">顯示預測線：</label>
                    <input type="checkbox" id="show-predictions-toggle" class="toolbar-checkbox" checked>
                </div>
                <div class="toolbar-group">
                    <label class="toolbar-label" data-lang-key="show-anomalies">標記異常：</label>
                    <input type="checkbox" id="show-anomalies-toggle" class="toolbar-checkbox" checked>
                </div>
            </div>

            <!-- 未來30天預測圖 -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3 class="chart-title" data-lang-key="forecast-chart-title">未來 30 天預測趨勢</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" id="forecast-fullscreen" title="全屏">⛶</button>
                    </div>
                </div>
                <div class="chart-container" id="forecast-chart-container">
                    <div class="chart-loading" id="forecast-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" data-lang-key="loading">載入中...</div>
                    </div>
                    <canvas id="forecast-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 準確度趨勢圖 -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3 class="chart-title" data-lang-key="accuracy-trend-title">📈 模型準確度趨勢</h3>
                </div>
                <div class="chart-container" id="accuracy-chart-container">
                    <div class="chart-loading" id="accuracy-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" data-lang-key="loading">載入中...</div>
                    </div>
                    <canvas id="accuracy-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 天氣相關性圖 -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title" data-lang-key="weather-corr-title">🌡️ 天氣影響分析</h3>
                </div>
                <div class="chart-container" id="weather-corr-chart-container">
                    <div class="chart-loading" id="weather-corr-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" data-lang-key="loading">載入中...</div>
                    </div>
                    <canvas id="weather-corr-chart" style="display: none;"></canvas>
                    <div id="weather-corr-stats" style="text-align: center; padding: 8px 0;"></div>
                </div>
            </div>

            <!-- 星期效應圖 -->
            <div class="chart-card">
                <h3 class="chart-title" data-lang-key="dow-chart-title">星期效應分析</h3>
                <div class="chart-container" id="dow-chart-container">
                    <div class="chart-loading" id="dow-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" data-lang-key="loading">載入中...</div>
                    </div>
                    <canvas id="dow-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 月份分佈圖 -->
            <div class="chart-card">
                <h3 class="chart-title" data-lang-key="month-chart-title">月份分佈統計</h3>
                <div class="chart-container" id="month-chart-container">
                    <div class="chart-loading" id="month-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" data-lang-key="loading">載入中...</div>
                    </div>
                    <canvas id="month-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 歷史趨勢圖 -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3 class="chart-title" data-lang-key="history-chart-title">歷史趨勢</h3>
                    <div class="chart-actions">
                        <select class="time-range-dropdown" id="time-range-dropdown" title="選擇時間範圍">
                            <option value="1D">1D</option>
                            <option value="1週">1週</option>
                            <option value="1月" selected>1月</option>
                            <option value="3月">3月</option>
                            <option value="6月">6月</option>
                            <option value="1年">1年</option>
                            <option value="2年">2年</option>
                            <option value="5年">5年</option>
                            <option value="10年">10年</option>
                            <option value="全部">全部</option>
                        </select>
                        <button class="chart-action-btn compare-btn" id="compare-year-btn" title="對比去年同期">
                            📊 <span data-lang-key="compare-year">對比去年</span>
                        </button>
                    </div>
                </div>
                <div class="time-range-selector" id="history-time-range">
                    <button class="time-range-btn" data-range="1D">1D</button>
                    <button class="time-range-btn" data-range="1週">1週</button>
                    <button class="time-range-btn active" data-range="1月">1月</button>
                    <button class="time-range-btn" data-range="3月">3月</button>
                    <button class="time-range-btn" data-range="6月">6月</button>
                    <button class="time-range-btn" data-range="1年">1年</button>
                    <button class="time-range-btn" data-range="2年">2年</button>
                    <button class="time-range-btn" data-range="5年">5年</button>
                    <button class="time-range-btn" data-range="10年">10年</button>
                    <button class="time-range-btn" data-range="全部">全部</button>
                </div>
                <div class="history-navigation" id="history-navigation" style="display: none;">
                    <button class="nav-btn" id="history-prev-btn">← 上一頁</button>
                    <span id="history-date-range"></span>
                    <button class="nav-btn" id="history-next-btn">下一頁 →</button>
                </div>
                <div class="chart-container large" id="history-chart-container">
                    <div class="chart-loading" id="history-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" data-lang-key="loading">載入中...</div>
                    </div>
                    <canvas id="history-chart" style="display: none;"></canvas>
                </div>
                <!-- 圖表 Onboarding 提示 -->
                <div class="chart-onboarding" id="chart-onboarding" style="display: none;">
                    <div class="onboarding-content">
                        <span class="onboarding-icon">💡</span>
                        <span class="onboarding-text" data-lang-key="chart-hint">提示：拖曳可平移，滾輪可縮放，點擊數據點查看詳情</span>
                        <button class="onboarding-dismiss" id="dismiss-onboarding">✕</button>
                    </div>
                </div>
            </div>

            <!-- 實際 vs 預測對比圖 -->
            <div class="chart-card full-width comparison-section">
                <div class="comparison-header">
                    <h3 class="chart-title">實際 vs 預測對比</h3>
                    <button id="add-actual-data-btn" class="add-data-btn" style="display: none;" onclick="triggerAddActualData()">
                        📊 添加實際數據
                    </button>
                </div>
                <div class="chart-container" id="comparison-chart-container">
                    <div class="chart-loading" id="comparison-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="comparison-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 詳細比較數據表格 -->
            <div class="chart-card full-width comparison-section">
                <h3 class="chart-title">詳細比較數據</h3>
                <div class="comparison-table-container" id="comparison-table-container">
                    <div class="chart-loading" id="comparison-table-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <table class="comparison-table" id="comparison-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>實際人數</th>
                                <th>預測人數</th>
                                <th>誤差</th>
                                <th>誤差率</th>
                                <th>80% CI</th>
                                <th>95% CI</th>
                                <th>準確度</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- v2.9.88: 預測波動圖表 - 顯示當天所有預測點 vs 最終平滑值 -->
            <div class="chart-card full-width prediction-volatility-section">
                <div class="volatility-header">
                    <h3 class="chart-title">📊 預測波動分析</h3>
                    <div class="volatility-controls">
                        <select id="volatility-date-select" class="volatility-date-select">
                            <option value="today">今日</option>
                        </select>
                        <button class="refresh-btn" id="refresh-volatility-chart" title="刷新圖表">
                            <span>🔄</span>
                        </button>
                    </div>
                </div>
                <p class="chart-description">顯示選定日期內所有預測點的變化，與最終平滑預測值和實際值的對比</p>
                <div class="chart-container" id="volatility-chart-container" style="height: 300px;">
                    <div class="chart-loading" id="volatility-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="volatility-chart" style="display: none;"></canvas>
                </div>
                <div class="volatility-stats" id="volatility-stats" style="margin-top: var(--space-md); display: none;">
                    <div class="volatility-stat-row">
                        <span class="stat-label">預測次數：</span>
                        <span class="stat-value" id="volatility-count">-</span>
                        <span class="stat-label" style="margin-left: var(--space-lg);">預測範圍：</span>
                        <span class="stat-value" id="volatility-range">-</span>
                        <span class="stat-label" style="margin-left: var(--space-lg);">標準差：</span>
                        <span class="stat-value" id="volatility-std">-</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 模型訓練狀態 -->
        <section class="model-training-section" id="model-training-section">
            <div class="section-header">
                <h2 class="section-title" data-lang-key="model-training-status">模型訓練狀態</h2>
                <div class="header-actions">
                    <button class="train-btn" id="start-training-btn" title="開始訓練模型">
                        <span>🚀</span>
                        <span>開始訓練</span>
                    </button>
                    <button class="stop-btn" id="stop-training-btn" title="停止訓練" style="display: none;">
                        <span>🛑</span>
                        <span>停止</span>
                    </button>
                    <button class="refresh-btn" id="refresh-training-status" title="刷新狀態">
                        <span>🔄</span>
                    </button>
                </div>
            </div>
            <div class="training-status-container" id="training-status-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入訓練狀態...</div>
            </div>
        </section>

        <!-- 算法演進時間線 -->
        <section class="algorithm-timeline-section" id="timeline-section">
            <h2 class="section-title">📈 算法演進時間線</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">追蹤算法更新對預測準確度的影響</p>
            <div class="timeline-main-container">
                <div id="main-algorithm-timeline" class="algorithm-timeline">
                    <div class="timeline-loading">載入中...</div>
                </div>
                <div class="timeline-chart-wrapper">
                    <canvas id="main-accuracy-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- 算法說明 -->
        <section class="algorithm-section" id="algorithm-section">
            <h2 class="section-title">預測算法說明（基於真實研究）</h2>
            <div class="algorithm-content" id="algorithm-content">
                <!-- 動態生成內容 -->
            </div>
        </section>

        <!-- 頁腳 -->
        <footer class="app-footer" role="contentinfo">
            <p id="data-source-info" style="cursor: pointer; text-decoration: underline;" data-lang-key="footer-source">數據來源：載入中...</p>
            <p id="last-update-info" class="last-update-info"></p>
            <p>預測模型版本 2.9.52 · 香港時間 HKT</p>
            <p style="margin-top: var(--space-sm); color: var(--text-tertiary); font-size: 0.85rem;">© 2025 Marco Ma. All Rights Reserved.</p>
            <div class="footer-links">
                <a href="/api/docs" class="footer-link" data-lang-key="footer-api">API 文檔</a>
                <span class="footer-divider">·</span>
                <a href="#" id="keyboard-shortcuts-link" class="footer-link" data-lang-key="footer-shortcuts">鍵盤快捷鍵</a>
            </div>
        </footer>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
        <div class="modal-content shortcuts-modal-content">
            <div class="modal-header">
                <h3 id="shortcuts-title" data-lang-key="shortcuts-title">⌨️ 鍵盤快捷鍵</h3>
                <button class="modal-close" id="shortcuts-close" aria-label="關閉">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item"><kbd>R</kbd><span data-lang-key="shortcut-refresh">刷新數據</span></div>
                <div class="shortcut-item"><kbd>T</kbd><span data-lang-key="shortcut-train">開始訓練</span></div>
                <div class="shortcut-item"><kbd>D</kbd><span data-lang-key="shortcut-theme">切換深色模式</span></div>
                <div class="shortcut-item"><kbd>E</kbd><span data-lang-key="shortcut-export">匯出數據</span></div>
                <div class="shortcut-item"><kbd>S</kbd><span data-lang-key="shortcut-share">分享</span></div>
                <div class="shortcut-item"><kbd>Home</kbd><span data-lang-key="shortcut-top">返回頂部</span></div>
                <div class="shortcut-item"><kbd>1-4</kbd><span data-lang-key="shortcut-nav">導航區塊</span></div>
                <div class="shortcut-item"><kbd>?</kbd><span data-lang-key="shortcut-help">顯示快捷鍵</span></div>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="notify-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="notify-title" aria-modal="true">
        <div class="modal-content notify-modal-content">
            <div class="modal-header">
                <h3 id="notify-title">🔔 <span data-lang-key="notify-title">通知設定</span></h3>
                <button class="modal-close" id="notify-close" aria-label="關閉">&times;</button>
            </div>
            <div class="notify-settings">
                <div class="notify-item">
                    <label class="notify-label">
                        <input type="checkbox" id="notify-high-volume" class="notify-checkbox">
                        <span class="notify-text" data-lang-key="notify-high">高人流預警 (>300人)</span>
                    </label>
                </div>
                <div class="notify-item">
                    <label class="notify-label">
                        <input type="checkbox" id="notify-training-complete" class="notify-checkbox">
                        <span class="notify-text" data-lang-key="notify-training">訓練完成通知</span>
                    </label>
                </div>
                <div class="notify-item">
                    <label class="notify-label">
                        <input type="checkbox" id="notify-daily-prediction" class="notify-checkbox">
                        <span class="notify-text" data-lang-key="notify-daily">每日預測提醒</span>
                    </label>
                </div>
                <button class="notify-save-btn" id="notify-save" data-lang-key="notify-save">儲存設定</button>
            </div>
        </div>
    </div>


    <!-- Methodology Modal -->
    <div id="methodology-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="methodology-title" aria-modal="true">
        <div class="modal-content methodology-modal-content">
            <div class="modal-header">
                <h3 id="methodology-title">📖 <span data-lang-key="methodology-title">預測方法論</span></h3>
                <button class="modal-close" id="methodology-close" aria-label="關閉">&times;</button>
            </div>
            <div class="methodology-content">
                <div class="methodology-section">
                    <h4>🎯 核心算法（v2.9.52 - 特徵優化版）</h4>
                    <p>本系統採用 <strong>XGBoost 梯度提升樹</strong>作為主要預測模型，使用 <strong>Optuna TPE</strong> + <strong>特徵選擇優化</strong>。</p>
                    <div class="formula-box">
                        <code>預測 = XGBoost(25特徵) × 實時天氣調整 × AI因素調整</code>
                    </div>
                    <p style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                        研究表明：25 精選特徵比 161 特徵更準確！<strong>MAE 5.33</strong>、<strong>R² 92.0%</strong>
                    </p>
                </div>
                <div class="methodology-section">
                    <h4>📊 優化特徵集（25 個精選特徵）</h4>
                    <ul class="feature-list">
                        <li><strong style="color: var(--accent-color);">🔥 EWMA7</strong>：指數加權移動平均 7 天（佔 <strong>45%</strong> 重要性！）</li>
                        <li><strong style="color: var(--accent-color);">🔥 EWMA14</strong>：指數加權移動平均 14 天（佔 <strong>45%</strong> 重要性！）</li>
                        <li><strong>Daily_Change</strong>：每日變化量</li>
                        <li><strong>Monthly_Change</strong>：月度變化量</li>
                        <li><strong>Attendance_Lag1</strong>：昨日人數</li>
                        <li><strong>Day_of_Week</strong>：星期幾</li>
                        <li><strong>滾動統計</strong>：Rolling7/14、Position7/14/30</li>
                        <li><strong>目標編碼</strong>：DayOfWeek_Target_Mean</li>
                        <li><strong>假期因子</strong>：Holiday_Factor</li>
                        <li><strong>流感季節</strong>：Is_Winter_Flu_Season</li>
                    </ul>
                    <p style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                        💡 研究發現：EWMA7+EWMA14 兩個特徵佔 90% 重要性，其餘 23 個特徵佔 10%
                    </p>
                </div>
                <div class="methodology-section">
                    <h4>⚖️ 樣本權重（研究基礎）</h4>
                    <ul class="feature-list">
                        <li><strong>時間衰減</strong>：半衰期 365 天，近期數據權重更高 <em>(JMIR 2025)</em></li>
                        <li><strong>COVID 調整</strong>：2020-02 至 2022-06 權重 30%</li>
                        <li><strong>異常值處理</strong>：Z-score > 3 權重減半</li>
                    </ul>
                </div>
                <div class="methodology-section">
                    <h4>📈 模型性能（v2.9.52）</h4>
                    <ul>
                        <li><strong style="color: var(--accent-color);">R²</strong>：<span id="methodology-r2">92.0</span>%（模型擬合度）</li>
                        <li><strong>MAE</strong>：<span id="methodology-mae">5.33</span> 人</li>
                        <li><strong>MAPE</strong>：<span id="methodology-mape">2.10</span>%</li>
                        <li><strong>80% CI</strong>：±1.5σ · <strong>95% CI</strong>：±2.5σ</li>
                    </ul>
                    <p style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                        訓練日期：<span id="methodology-train-date">--</span> · 數據量：<span id="methodology-data-count">--</span> 筆
                    </p>
                </div>
                <div class="methodology-section">
                    <h4>📈 算法演進時間線</h4>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 12px;">追蹤算法更新對預測準確度的影響</p>
                    <div id="algorithm-timeline" class="algorithm-timeline">
                        <div class="timeline-loading">載入中...</div>
                    </div>
                    <div class="timeline-chart-container" style="height: 220px; margin-top: 16px;">
                        <canvas id="accuracy-trend-chart"></canvas>
                    </div>
                </div>
                <div class="methodology-section">
                    <h4>🔬 研究參考</h4>
                    <ul class="feature-list" style="font-size: 0.85em;">
                        <li><strong>BMC EM (2025)</strong>：法國醫院 XGBoost，MAE 2.63</li>
                        <li><strong>BMC MIDM (2024)</strong>：特徵工程增強預測</li>
                        <li><strong>JMIR (2025)</strong>：時間衰減權重、多數據源</li>
                        <li><strong>Prophet</strong>：Fourier 季節特徵</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Window Drop Zone -->
    <div id="drop-zone-overlay" class="drop-zone-overlay" style="display: none;">
        <div class="drop-zone-content">
            <span class="drop-icon">📁</span>
            <span class="drop-text" data-lang-key="drop-hint">放開以上傳 CSV 文件</span>
        </div>
    </div>

    <!-- CSV 上傳對話框 -->
    <div id="csv-upload-modal" class="upload-modal" style="display: none;">
        <div class="upload-modal-overlay"></div>
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3>上傳歷史數據</h3>
                <button class="upload-modal-close" id="csv-upload-close">&times;</button>
            </div>
            <div class="upload-modal-body">
                <p class="upload-instructions">
                    請輸入或貼上 CSV 格式的數據，格式如下：<br>
                    <code>Date,Attendance<br>2025-12-01,276<br>2025-12-02,285<br>...</code>
                </p>
                <div class="upload-tabs">
                    <button class="upload-tab active" data-tab="text">文本輸入</button>
                    <button class="upload-tab" data-tab="file">文件上傳</button>
                </div>
                <div class="upload-tab-content active" id="upload-tab-text">
                    <textarea id="csv-text-input" class="csv-textarea" placeholder="請貼上或輸入 CSV 數據，例如：&#10;Date,Attendance&#10;2025-12-01,276&#10;2025-12-02,285&#10;..."></textarea>
                    <div class="upload-preview" id="csv-text-preview" style="display: none;">
                        <h4>解析到的數據：</h4>
                        <div id="csv-text-preview-content"></div>
                    </div>
                </div>
                <div class="upload-tab-content" id="upload-tab-file" style="display: none;">
                    <div class="upload-area" id="csv-upload-area">
                        <input type="file" id="csv-file-input" accept=".csv,text/csv" style="display: none;">
                        <label for="csv-file-input" class="upload-label">
                            <span class="upload-icon">📁</span>
                            <span class="upload-text">點擊選擇 CSV 文件或拖放文件到此處</span>
                        </label>
                    </div>
                    <div class="upload-preview" id="csv-file-preview" style="display: none;">
                        <h4>預覽數據：</h4>
                        <textarea id="csv-file-preview-text" readonly></textarea>
                    </div>
                </div>
                <div class="upload-status" id="csv-upload-status"></div>
            </div>
            <div class="upload-modal-footer">
                <button class="upload-btn upload-btn-cancel" id="csv-upload-cancel">取消</button>
                <button class="upload-btn upload-btn-submit" id="csv-upload-submit" disabled>上傳</button>
            </div>
        </div>
    </div>

    <!-- 原始預測邏輯（保留所有功能） -->
    <script src="prediction.js?v=5"></script>
    <!-- 模組化包裝層 -->
    <script type="module" src="app.js?v=5"></script>
</body>
</html>
