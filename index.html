<!DOCTYPE html>
<html lang="zh-HK" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="description" content="NDH AED 病人數量預測系統 - 北區醫院急症室人流預測">
    <meta name="theme-color" content="#f8fafc" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="北區醫院預測">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=6">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png?v=6">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152.png?v=6">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120.png?v=6">
    <link rel="manifest" href="/manifest.json?v=6">
    
    <title>NDH AED 預測系統</title>
    <link rel="stylesheet" href="styles.css?v=6">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <!-- Sticky Navigation Bar -->
    <nav class="sticky-nav" id="sticky-nav" role="navigation" aria-label="主導航">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="nav-logo">🏥</span>
                <span class="nav-title" data-lang-key="nav-title">NDH AED</span>
            </div>
            <div class="nav-links">
                <a href="#today-section" class="nav-link active" data-section="today" aria-label="今日預測">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text" data-lang-key="nav-today">今日</span>
                </a>
                <a href="#forecast-section" class="nav-link" data-section="forecast" aria-label="7日預測">
                    <span class="nav-icon">📅</span>
                    <span class="nav-text" data-lang-key="nav-forecast">7日</span>
                </a>
                <a href="#charts-section" class="nav-link" data-section="charts" aria-label="歷史趨勢">
                    <span class="nav-icon">📈</span>
                    <span class="nav-text" data-lang-key="nav-history">趨勢</span>
                </a>
                <a href="#model-training-section" class="nav-link" data-section="training" aria-label="模型訓練">
                    <span class="nav-icon">🤖</span>
                    <span class="nav-text" data-lang-key="nav-training">訓練</span>
                </a>
            </div>
            <div class="nav-actions">
                <button class="nav-action-btn" id="export-btn" title="匯出數據 (Ctrl+E)" aria-label="匯出數據">
                    <span>📥</span>
                </button>
                <button class="nav-action-btn" id="share-btn" title="分享 (Ctrl+S)" aria-label="分享">
                    <span>🔗</span>
                </button>
                <button class="nav-action-btn" id="notify-btn" title="通知設定" aria-label="通知設定">
                    <span>🔔</span>
                </button>
                <button class="nav-action-btn" id="lang-toggle" title="切換語言 (Ctrl+L)" aria-label="切換語言">
                    <span>EN</span>
                </button>
                <button class="nav-action-btn" id="theme-toggle" title="切換主題 (Ctrl+D)" aria-label="切換深色模式">
                    <span class="theme-icon">🌙</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="back-to-top" title="返回頂部 (Home)" aria-label="返回頂部">
        <span>↑</span>
    </button>

    <!-- Notification Toast Container -->
    <div class="toast-container" id="toast-container" role="alert" aria-live="polite"></div>

    <!-- 主容器 -->
    <div class="app-container" id="app-container">
        <!-- 標題區 -->
        <header class="app-header" id="app-header">
            <div class="header-content">
                <h1 class="header-title">NDH AED 病人數量預測系統</h1>
                <p class="header-subtitle">North District Hospital A&E Attendance Prediction</p>
                <div class="header-info">
                    <div class="current-datetime" id="current-datetime">
                        <span class="datetime-icon">⏱️</span>
                        <span class="datetime-text">載入中...</span>
                    </div>
                    <div class="weather-display" id="weather-display">
                        <span class="weather-loading">載入天氣資料...</span>
                    </div>
                    <div class="status-badges">
                        <div class="status-badge db-status loading" id="db-status">
                            <span class="status-icon">📊</span>
                            <span class="status-text">檢查數據庫連接...</span>
                        </div>
                        <div class="status-badge ai-status loading" id="ai-status">
                            <span class="status-icon">🤖</span>
                            <span class="status-text">檢查 AI 連接...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 今日預測區塊 -->
        <section class="prediction-section today-section" id="today-section" aria-labelledby="today-section-title">
            <div class="section-loading" id="today-prediction-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text"><span data-lang-key="loading">載入中...</span> <span class="loading-percent" id="today-prediction-percent">0%</span></div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="today-prediction-progress"></div>
                </div>
            </div>
            <div class="prediction-grid" id="today-prediction-grid" style="display: none;">
                <!-- 主預測卡片 -->
                <div class="prediction-card main-prediction-card" id="main-prediction-card">
                    <div class="card-header">
                        <h2 class="card-title">今日預測</h2>
                        <span class="date-badge" id="today-date">--</span>
                    </div>
                    
                    <!-- 平滑後最終預測 -->
                    <div class="smoothed-prediction-section">
                        <div class="prediction-type-label">
                            <span class="label-icon">📊</span>
                            <span class="label-text">綜合預測</span>
                            <span class="smoothing-method" id="smoothing-method" title="平滑方法">--</span>
                        </div>
                        <div class="prediction-value-container">
                            <div class="prediction-value">
                                <span class="big-number" id="today-predicted">--</span>
                                <span class="unit">人</span>
                            </div>
                        </div>
                        <div class="stability-indicator" id="stability-indicator">
                            <span class="stability-label">穩定性</span>
                            <span class="stability-value" id="stability-value">--</span>
                        </div>
                    </div>
                    
                    <!-- 實時最新預測 -->
                    <div class="realtime-prediction-section">
                        <div class="prediction-type-label realtime">
                            <span class="label-icon">⚡</span>
                            <span class="label-text">實時預測</span>
                            <span class="realtime-time" id="realtime-time">--</span>
                        </div>
                        <div class="realtime-value-container">
                            <div class="realtime-value">
                                <span class="realtime-number" id="realtime-predicted">--</span>
                                <span class="unit">人</span>
                            </div>
                            <div class="realtime-diff" id="realtime-diff"></div>
                        </div>
                    </div>
                    
                    <div class="confidence-intervals">
                        <div class="ci-item">
                            <span class="ci-label">80% 信賴區間</span>
                            <span class="ci-value" id="today-ci80">-- - -- 人</span>
                        </div>
                        <div class="ci-item">
                            <span class="ci-label">95% 信賴區間</span>
                            <span class="ci-value" id="today-ci95">-- - -- 人</span>
                        </div>
                    </div>
                    <div class="factors-breakdown" id="factors-breakdown"></div>
                </div>

                <!-- 統計摘要卡片 -->
                <div class="prediction-card stats-card">
                    <div class="card-header">
                        <h2 class="card-title">歷史統計</h2>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="stat-mean">--</span>
                            <span class="stat-label">日均人數</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stat-max">--</span>
                            <span class="stat-label">最高峰</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stat-min">--</span>
                            <span class="stat-label">最低谷</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="stat-std">--</span>
                            <span class="stat-label">標準差</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 實時影響因素 -->
        <section class="factors-section" id="factors-section">
            <div class="section-header">
                <h2 class="section-title">實時影響因素</h2>
                <button class="refresh-btn" id="ai-refresh-btn" onclick="forceRefreshAI()" title="強制重新分析">
                    <span class="refresh-icon">🔄</span>
                    <span class="refresh-text">重新分析</span>
                </button>
            </div>
            <div class="section-loading" id="factors-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入中... <span class="loading-percent" id="factors-percent">0%</span></div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="factors-progress"></div>
                </div>
            </div>
            <div class="factors-container" id="factors-content" style="display: none;"></div>
        </section>

        <!-- 未來7天預測 -->
        <section class="forecast-section" id="forecast-section">
            <h2 class="section-title">未來 7 天預測</h2>
            <div class="section-loading" id="forecast-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入中... <span class="loading-percent" id="forecast-percent">0%</span></div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="forecast-progress"></div>
                </div>
            </div>
            <div class="forecast-cards" id="forecast-content" style="display: none;"></div>
        </section>

        <!-- 圖表區域 -->
        <section class="charts-section" id="charts-section">
            <!-- 未來30天預測圖 -->
            <div class="chart-card full-width">
                <h3 class="chart-title">未來 30 天預測趨勢</h3>
                <div class="chart-container" id="forecast-chart-container">
                    <div class="chart-loading" id="forecast-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="forecast-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 星期效應圖 -->
            <div class="chart-card">
                <h3 class="chart-title">星期效應分析</h3>
                <div class="chart-container" id="dow-chart-container">
                    <div class="chart-loading" id="dow-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="dow-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 月份分佈圖 -->
            <div class="chart-card">
                <h3 class="chart-title">月份分佈統計</h3>
                <div class="chart-container" id="month-chart-container">
                    <div class="chart-loading" id="month-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="month-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 歷史趨勢圖 -->
            <div class="chart-card full-width">
                <h3 class="chart-title">歷史趨勢</h3>
                <div class="time-range-selector" id="history-time-range">
                    <button class="time-range-btn" data-range="1D">1D</button>
                    <button class="time-range-btn" data-range="1週">1週</button>
                    <button class="time-range-btn active" data-range="1月">1月</button>
                    <button class="time-range-btn" data-range="3月">3月</button>
                    <button class="time-range-btn" data-range="6月">6月</button>
                    <button class="time-range-btn" data-range="1年">1年</button>
                    <button class="time-range-btn" data-range="2年">2年</button>
                    <button class="time-range-btn" data-range="5年">5年</button>
                    <button class="time-range-btn" data-range="10年">10年</button>
                    <button class="time-range-btn" data-range="全部">全部</button>
                </div>
                <div class="history-navigation" id="history-navigation" style="display: none;">
                    <button class="nav-btn" id="history-prev-btn">← 上一頁</button>
                    <span id="history-date-range"></span>
                    <button class="nav-btn" id="history-next-btn">下一頁 →</button>
                </div>
                <div class="chart-container large" id="history-chart-container">
                    <div class="chart-loading" id="history-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="history-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 實際 vs 預測對比圖 -->
            <div class="chart-card full-width comparison-section">
                <div class="comparison-header">
                    <h3 class="chart-title">實際 vs 預測對比</h3>
                    <button id="add-actual-data-btn" class="add-data-btn" style="display: none;" onclick="triggerAddActualData()">
                        📊 添加實際數據
                    </button>
                </div>
                <div class="chart-container" id="comparison-chart-container">
                    <div class="chart-loading" id="comparison-chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <canvas id="comparison-chart" style="display: none;"></canvas>
                </div>
            </div>

            <!-- 詳細比較數據表格 -->
            <div class="chart-card full-width comparison-section">
                <h3 class="chart-title">詳細比較數據</h3>
                <div class="comparison-table-container" id="comparison-table-container">
                    <div class="chart-loading" id="comparison-table-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">載入中...</div>
                    </div>
                    <table class="comparison-table" id="comparison-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>實際人數</th>
                                <th>預測人數</th>
                                <th>誤差</th>
                                <th>誤差率</th>
                                <th>80% CI</th>
                                <th>95% CI</th>
                                <th>準確度</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 模型訓練狀態 -->
        <section class="model-training-section" id="model-training-section">
            <div class="section-header">
                <h2 class="section-title">模型訓練狀態</h2>
                <div class="header-actions">
                    <button class="train-btn" id="start-training-btn" title="開始訓練模型">
                        <span>🚀</span>
                        <span>開始訓練</span>
                    </button>
                    <button class="refresh-btn" id="refresh-training-status" title="刷新狀態">
                        <span>🔄</span>
                    </button>
                </div>
            </div>
            <div class="training-status-container" id="training-status-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入訓練狀態...</div>
            </div>
        </section>

        <!-- 算法說明 -->
        <section class="algorithm-section" id="algorithm-section">
            <h2 class="section-title">預測算法說明（基於真實研究）</h2>
            <div class="algorithm-content" id="algorithm-content">
                <!-- 動態生成內容 -->
            </div>
        </section>

        <!-- 頁腳 -->
        <footer class="app-footer" role="contentinfo">
            <p id="data-source-info" style="cursor: pointer; text-decoration: underline;" data-lang-key="footer-source">數據來源：載入中...</p>
            <p id="last-update-info" class="last-update-info"></p>
            <p><span data-lang-key="footer-version">預測模型版本</span> 2.6.0 · <span data-lang-key="footer-timezone">香港時間 HKT</span></p>
            <p style="margin-top: var(--space-sm); color: var(--text-tertiary); font-size: 0.85rem;">© 2025 Marco Ma. All Rights Reserved.</p>
            <div class="footer-links">
                <a href="/api/docs" class="footer-link" data-lang-key="footer-api">API 文檔</a>
                <span class="footer-divider">·</span>
                <a href="#" id="keyboard-shortcuts-link" class="footer-link" data-lang-key="footer-shortcuts">鍵盤快捷鍵</a>
            </div>
        </footer>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
        <div class="modal-content shortcuts-modal-content">
            <div class="modal-header">
                <h3 id="shortcuts-title" data-lang-key="shortcuts-title">⌨️ 鍵盤快捷鍵</h3>
                <button class="modal-close" id="shortcuts-close" aria-label="關閉">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item"><kbd>R</kbd><span data-lang-key="shortcut-refresh">刷新數據</span></div>
                <div class="shortcut-item"><kbd>T</kbd><span data-lang-key="shortcut-train">開始訓練</span></div>
                <div class="shortcut-item"><kbd>D</kbd><span data-lang-key="shortcut-theme">切換深色模式</span></div>
                <div class="shortcut-item"><kbd>L</kbd><span data-lang-key="shortcut-lang">切換語言</span></div>
                <div class="shortcut-item"><kbd>E</kbd><span data-lang-key="shortcut-export">匯出數據</span></div>
                <div class="shortcut-item"><kbd>S</kbd><span data-lang-key="shortcut-share">分享</span></div>
                <div class="shortcut-item"><kbd>Home</kbd><span data-lang-key="shortcut-top">返回頂部</span></div>
                <div class="shortcut-item"><kbd>1-4</kbd><span data-lang-key="shortcut-nav">導航區塊</span></div>
                <div class="shortcut-item"><kbd>?</kbd><span data-lang-key="shortcut-help">顯示快捷鍵</span></div>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="notify-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="notify-title" aria-modal="true">
        <div class="modal-content notify-modal-content">
            <div class="modal-header">
                <h3 id="notify-title">🔔 <span data-lang-key="notify-title">通知設定</span></h3>
                <button class="modal-close" id="notify-close" aria-label="關閉">&times;</button>
            </div>
            <div class="notify-settings">
                <div class="notify-item">
                    <label class="notify-label">
                        <input type="checkbox" id="notify-high-volume" class="notify-checkbox">
                        <span class="notify-text" data-lang-key="notify-high">高人流預警 (>300人)</span>
                    </label>
                </div>
                <div class="notify-item">
                    <label class="notify-label">
                        <input type="checkbox" id="notify-training-complete" class="notify-checkbox">
                        <span class="notify-text" data-lang-key="notify-training">訓練完成通知</span>
                    </label>
                </div>
                <div class="notify-item">
                    <label class="notify-label">
                        <input type="checkbox" id="notify-daily-prediction" class="notify-checkbox">
                        <span class="notify-text" data-lang-key="notify-daily">每日預測提醒</span>
                    </label>
                </div>
                <button class="notify-save-btn" id="notify-save" data-lang-key="notify-save">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="export-title" aria-modal="true">
        <div class="modal-content export-modal-content">
            <div class="modal-header">
                <h3 id="export-title">📥 <span data-lang-key="export-title">匯出數據</span></h3>
                <button class="modal-close" id="export-close" aria-label="關閉">&times;</button>
            </div>
            <div class="export-options">
                <button class="export-option-btn" id="export-csv" data-format="csv">
                    <span class="export-icon">📄</span>
                    <span class="export-text">CSV</span>
                </button>
                <button class="export-option-btn" id="export-excel" data-format="excel">
                    <span class="export-icon">📊</span>
                    <span class="export-text">Excel</span>
                </button>
                <button class="export-option-btn" id="export-pdf" data-format="pdf">
                    <span class="export-icon">📑</span>
                    <span class="export-text">PDF</span>
                </button>
            </div>
            <div class="export-range">
                <label data-lang-key="export-range">數據範圍：</label>
                <select id="export-range-select">
                    <option value="7" data-lang-key="export-7days">過去 7 天</option>
                    <option value="30" data-lang-key="export-30days">過去 30 天</option>
                    <option value="90" data-lang-key="export-90days">過去 90 天</option>
                    <option value="all" data-lang-key="export-all">全部數據</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="share-title" aria-modal="true">
        <div class="modal-content share-modal-content">
            <div class="modal-header">
                <h3 id="share-title">🔗 <span data-lang-key="share-title">分享預測</span></h3>
                <button class="modal-close" id="share-close" aria-label="關閉">&times;</button>
            </div>
            <div class="share-options">
                <button class="share-option-btn" id="share-link">
                    <span class="share-icon">🔗</span>
                    <span class="share-text" data-lang-key="share-link">複製連結</span>
                </button>
                <button class="share-option-btn" id="share-image">
                    <span class="share-icon">🖼️</span>
                    <span class="share-text" data-lang-key="share-image">儲存為圖片</span>
                </button>
                <button class="share-option-btn" id="share-report">
                    <span class="share-icon">📊</span>
                    <span class="share-text" data-lang-key="share-report">生成報告</span>
                </button>
            </div>
        </div>
    </div>

    <!-- CSV 上傳對話框 -->
    <div id="csv-upload-modal" class="upload-modal" style="display: none;">
        <div class="upload-modal-overlay"></div>
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3>上傳歷史數據</h3>
                <button class="upload-modal-close" id="csv-upload-close">&times;</button>
            </div>
            <div class="upload-modal-body">
                <p class="upload-instructions">
                    請輸入或貼上 CSV 格式的數據，格式如下：<br>
                    <code>Date,Attendance<br>2025-12-01,276<br>2025-12-02,285<br>...</code>
                </p>
                <div class="upload-tabs">
                    <button class="upload-tab active" data-tab="text">文本輸入</button>
                    <button class="upload-tab" data-tab="file">文件上傳</button>
                </div>
                <div class="upload-tab-content active" id="upload-tab-text">
                    <textarea id="csv-text-input" class="csv-textarea" placeholder="請貼上或輸入 CSV 數據，例如：&#10;Date,Attendance&#10;2025-12-01,276&#10;2025-12-02,285&#10;..."></textarea>
                    <div class="upload-preview" id="csv-text-preview" style="display: none;">
                        <h4>解析到的數據：</h4>
                        <div id="csv-text-preview-content"></div>
                    </div>
                </div>
                <div class="upload-tab-content" id="upload-tab-file" style="display: none;">
                    <div class="upload-area" id="csv-upload-area">
                        <input type="file" id="csv-file-input" accept=".csv,text/csv" style="display: none;">
                        <label for="csv-file-input" class="upload-label">
                            <span class="upload-icon">📁</span>
                            <span class="upload-text">點擊選擇 CSV 文件或拖放文件到此處</span>
                        </label>
                    </div>
                    <div class="upload-preview" id="csv-file-preview" style="display: none;">
                        <h4>預覽數據：</h4>
                        <textarea id="csv-file-preview-text" readonly></textarea>
                    </div>
                </div>
                <div class="upload-status" id="csv-upload-status"></div>
            </div>
            <div class="upload-modal-footer">
                <button class="upload-btn upload-btn-cancel" id="csv-upload-cancel">取消</button>
                <button class="upload-btn upload-btn-submit" id="csv-upload-submit" disabled>上傳</button>
            </div>
        </div>
    </div>

    <!-- 原始預測邏輯（保留所有功能） -->
    <script src="prediction.js?v=5"></script>
    <!-- 模組化包裝層 -->
    <script type="module" src="app.js?v=5"></script>
</body>
</html>
