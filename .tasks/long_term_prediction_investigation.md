# 長期預測能力深度調查報告

**調查日期**: 2026-01-30
**調查人**: Claude (Ma Tsz Kiu)
**目標**: 確定模型能夠準確預測的最大天數

---

## 🎯 調查目標

### 核心問題

1. **當前系統能預測多少天？**
   - 目前是 7 天還是 30 天？
   - 實際預測範圍是多少？

2. **不同預測天數的誤差如何變化？**
   - Day 1-7 的誤差
   - Day 8-14 的誤差
   - Day 15-30 的誤差

3. **模型的最佳預測範圍是多少？**
   - 在什麼範圍內誤差可接受？
   - 超過多少天後誤差急劇上升？

4. **如何優化長期預測？**
   - 需要什麼技術改進？
   - 是否需要不同的模型架構？

---

## 📊 初步證據收集

### 1. 數據庫查詢結果

**當前預測範圍** (2025-11-01 至今):
```
最小預測天數: 0 天 (當天預測)
最大預測天數: 29 天
總共預測範圍: 30 天
```

**結論**: 系統已經在預測 30 天，不是只有 7 天！

### 2. 不同預測天數的誤差分析

**原始數據** (2025-11-01 至今，每個天數只有 1 個樣本):

```
Day 0:  24 人誤差
Day 1:  12 人誤差
Day 2:  1 人誤差  ✅ 最佳
Day 3:  34 人誤差
Day 4:  17 人誤差
Day 5:  3 人誤差  ✅ 優秀
Day 6:  34 人誤差
Day 7:  17 人誤差
Day 8:  6 人誤差  ✅ 優秀
Day 9:  59 人誤差  ⚠️
Day 10: 54 人誤差  ⚠️
Day 11: 19 人誤差
Day 12: 28 人誤差
Day 13: 2 人誤差  ✅ 最佳
Day 14: 36 人誤差
Day 15: 13 人誤差
Day 16: 18 人誤差
Day 17: 16 人誤差
Day 18: 6 人誤差  ✅ 優秀
Day 19: 5 人誤差  ✅ 優秀
Day 20: 12 人誤差
Day 21: 61 人誤差  ⚠️⚠️
Day 22: 25 人誤差
Day 23: 13 人誤差
Day 24: 2 人誤差  ✅ 最佳
Day 25: 5 人誤差  ✅ 優秀
Day 26: 7 人誤差  ✅ 優秀
Day 27: 9 人誤差  ✅ 優秀
Day 28: 76 人誤差  ⚠️⚠️⚠️ (元旦假期)
Day 29: 44 人誤差  ⚠️
```

**初步觀察**:
- 誤差分佈不規則，沒有明顯的隨天數增加而增加的趨勢
- 最大誤差出現在 Day 28 (76 人) - 這是元旦假期
- 第二大誤差 Day 21 (61 人) - 可能是聖誕節
- 有些長期預測反而很準確 (Day 24-27 都在 10 人以內)

**關鍵發現**: 誤差主要由**特殊事件**（假期）驅動，而不是預測天數本身！

### 3. 現有長期預測測試腳本

發現文件: `python/test_long_term_prediction.py`

**功能**:
- 測試 7 天 vs 14 天 vs 30 天預測準確度
- 支持遞歸預測（用預測值作為 lag 特徵）
- 分段計算誤差 (Day 1-7, Day 8-14, Day 15-30)

**問題**: 這個腳本可能沒有被運行過，或者結果沒有被記錄

---

## 🔬 實驗計劃

### 實驗 1: 運行現有長期預測測試

**目標**: 使用 v3.3.00 模型測試不同預測範圍的準確度

**步驟**:
1. 修改 `test_long_term_prediction.py` 使用 v3.3.00 模型
2. 測試 7 天、14 天、30 天預測
3. 分析誤差隨天數的變化趨勢

**預期結果**:
- Day 1-7: MAE < 15 人
- Day 8-14: MAE < 25 人
- Day 15-30: MAE < 35 人

### 實驗 2: 分析誤差來源

**目標**: 確定誤差是由預測天數還是特殊事件驅動

**步驟**:
1. 分離假期和非假期的預測誤差
2. 計算不同天數範圍的平均誤差
3. 識別誤差突增的臨界點

**假設**:
- 假期預測誤差 >> 非假期預測誤差
- 非假期預測誤差隨天數緩慢增加
- 假期預測誤差與天數無關

### 實驗 3: 遞歸預測 vs 直接預測

**目標**: 比較兩種預測策略的準確度

**遞歸預測**:
- Day 1: 用真實 lag 特徵
- Day 2+: 用預測值作為 lag 特徵
- 誤差會累積

**直接預測**:
- 每天都用真實歷史數據
- 不累積誤差
- 但需要每天重新預測

**預期**:
- 遞歸預測: 誤差隨天數指數增長
- 直接預測: 誤差隨天數線性增長

### 實驗 4: 特徵重要性隨預測天數變化

**目標**: 了解哪些特徵對長期預測最重要

**步驟**:
1. 訓練 3 個模型: 7 天、14 天、30 天
2. 比較特徵重要性的變化
3. 識別長期預測的關鍵特徵

**假設**:
- 短期預測: Lag1, EWMA7 最重要
- 長期預測: 週期特徵 (Day_of_Week, sin/cos) 更重要
- 假期特徵對所有範圍都重要

---

## 📈 初步結論（基於有限數據）

### 1. 當前系統已經在預測 30 天

**證據**:
- 數據庫中有 0-29 天的預測記錄
- 每個預測日期都生成 30 天的預測

**問題**: 用戶可能只看到 7 天的預測（前端顯示限制）

### 2. 誤差主要由特殊事件驅動

**證據**:
- 最大誤差 (76 人) 出現在元旦 (Day 28)
- 第二大誤差 (61 人) 可能是聖誕節 (Day 21)
- 非假期的長期預測也可以很準確 (Day 24-27: 2-9 人)

**結論**: 問題不是"能預測多少天"，而是"如何預測假期"

### 3. v3.3.00 的假期特徵應該能改善長期預測

**理由**:
- v3.3.00 添加了 5 個假期特徵
- 假期是長期預測誤差的主要來源
- 預期長期預測誤差會顯著下降

### 4. 樣本量不足

**問題**:
- 每個預測天數只有 1 個樣本
- 無法計算可靠的平均誤差
- 需要更多數據來驗證

---

## 🎯 建議的改進方案

### 方案 1: 優化當前系統（推薦）

**目標**: 改善 30 天預測的準確度

**步驟**:
1. ✅ 已完成: 添加假期特徵 (v3.3.00)
2. 部署 v3.3.00 到生產環境
3. 收集 30 天數據驗證改善效果
4. 根據實際數據微調

**預期改善**:
- 假期預測誤差: 60-76 → 15-20 人
- 非假期長期預測: 保持或改善
- 整體 30 天 MAE: < 20 人

### 方案 2: 實施混合預測策略

**短期預測 (1-7 天)**:
- 使用當前 XGBoost 模型
- 重點: Lag 特徵、EWMA
- 預期 MAE: < 10 人

**中期預測 (8-14 天)**:
- 使用當前 XGBoost 模型
- 重點: 週期特徵、假期特徵
- 預期 MAE: < 15 人

**長期預測 (15-30 天)**:
- 使用簡化模型或統計方法
- 重點: 歷史平均、季節性、假期
- 預期 MAE: < 25 人

### 方案 3: 開發專門的長期預測模型

**技術選項**:

1. **LSTM / GRU**
   - 優勢: 捕捉長期依賴
   - 劣勢: 需要更多數據、訓練時間長
   - 適用: 15-30 天預測

2. **Prophet**
   - 優勢: 專門處理季節性和假期
   - 劣勢: 可能不如 XGBoost 靈活
   - 適用: 7-30 天預測

3. **Ensemble (XGBoost + Prophet)**
   - 優勢: 結合兩者優勢
   - 劣勢: 複雜度增加
   - 適用: 全範圍預測

### 方案 4: 改進前端顯示

**問題**: 用戶可能只看到 7 天預測

**解決方案**:
1. 添加"未來 30 天預測趨勢"圖表
2. 顯示置信區間（越遠越寬）
3. 標註假期和特殊事件
4. 提供不同時間範圍的切換

---

## 🔍 需要進一步調查的問題

### 1. 前端顯示限制

**問題**: 用戶說"只能預測 7 天"

**可能原因**:
- 前端只顯示 7 天的預測
- API 只返回 7 天的數據
- 用戶沒有看到完整的預測

**調查步驟**:
1. 檢查前端代碼中的預測天數限制
2. 檢查 API 返回的預測數量
3. 確認用戶看到的界面

### 2. 遞歸預測的誤差累積

**問題**: 長期預測是否使用遞歸方法？

**影響**:
- 遞歸預測: 誤差會累積，Day 30 誤差可能很大
- 直接預測: 每天獨立預測，誤差不累積

**調查步驟**:
1. 檢查 `ensemble_predict.py` 的預測邏輯
2. 確認是否使用預測值作為 lag 特徵
3. 測試兩種方法的誤差差異

### 3. 模型的實際預測範圍

**問題**: 模型訓練時考慮了多長的預測範圍？

**影響**:
- 如果只訓練 7 天預測，用於 30 天會不準確
- 需要確認訓練時的預測範圍設定

**調查步驟**:
1. 檢查訓練腳本的預測範圍設定
2. 確認測試集的評估範圍
3. 驗證模型是否針對長期預測優化

---

## 📋 行動計劃

### 階段 1: 證據收集（立即執行）

1. **檢查前端代碼**
   - 搜索預測天數限制
   - 確認顯示邏輯
   - 找出 7 天限制的來源

2. **檢查預測邏輯**
   - 閱讀 `ensemble_predict.py`
   - 確認是遞歸還是直接預測
   - 了解 lag 特徵的更新方式

3. **運行長期預測測試**
   - 使用 v3.3.00 模型
   - 測試 7/14/30 天預測
   - 記錄詳細結果

### 階段 2: 問題診斷（基於證據）

1. **如果是前端限制**
   - 修改前端顯示 30 天預測
   - 添加時間範圍切換
   - 改善可視化

2. **如果是遞歸預測問題**
   - 實施直接預測策略
   - 或改進遞歸預測的誤差控制
   - 對比兩種方法的效果

3. **如果是模型能力問題**
   - 訓練專門的長期預測模型
   - 或實施混合預測策略
   - 添加更多長期預測特徵

### 階段 3: 實施改進（基於診斷）

1. **部署 v3.3.00**
   - 假期特徵應該能改善長期預測
   - 監控 30 天預測的實際效果
   - 收集數據驗證改善

2. **優化預測策略**
   - 根據實際數據調整
   - 可能需要不同範圍的不同策略
   - 持續監控和改進

3. **改進用戶體驗**
   - 清晰顯示預測範圍
   - 提供置信區間
   - 標註不確定性

---

## 💡 關鍵洞察

### 1. 系統已經在預測 30 天

**證據**: 數據庫中有 0-29 天的預測記錄

**問題**: 可能是前端顯示限制，不是模型能力問題

### 2. 誤差主要由假期驅動

**證據**: 最大誤差都出現在假期

**解決方案**: v3.3.00 的假期特徵應該能解決

### 3. 長期預測不一定不準確

**證據**: Day 24-27 的誤差只有 2-9 人

**結論**: 模型有能力做準確的長期預測

### 4. 需要更多數據驗證

**問題**: 每個天數只有 1 個樣本

**解決方案**: 部署 v3.3.00 後收集 30 天數據

---

## 🎯 推薦方案

### 立即執行（今天）

1. **檢查前端代碼** - 找出 7 天限制的來源
2. **檢查預測邏輯** - 確認遞歸 vs 直接預測
3. **運行長期預測測試** - 使用 v3.3.00 模型

### 短期（1-3 天）

1. **修復前端限制** - 如果是顯示問題
2. **部署 v3.3.00** - 假期特徵應該能改善長期預測
3. **添加 30 天預測圖表** - 改善用戶體驗

### 中期（1-2 週）

1. **收集 30 天數據** - 驗證 v3.3.00 的改善效果
2. **分析誤差模式** - 確定是否需要進一步優化
3. **微調預測策略** - 根據實際數據調整

### 長期（1-2 月）

1. **考慮混合預測策略** - 如果單一模型不夠
2. **開發專門的長期預測模型** - 如果需要
3. **持續優化** - 根據實際數據改進

---

**報告完成時間**: 2026-01-30 22:25 HKT
**下一步**: 執行階段 1 的證據收集
