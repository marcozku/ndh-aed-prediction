# 版本更新日誌

## v1.2.0 - 2025-12-07 15:46 HKT

### 🎯 重大算法更新（基於十年數據分析報告）

根據2015-2024年十年歷史數據的綜合分析，全面更新預測算法：

#### 核心算法變更

1. **True Normal Baseline: 260**
   - 將baseline從數據計算改為固定值260
   - 基於2018-2019和2024-2025正常年份數據
   - 排除2020-2022疫情期間異常值

2. **星期因子更新（基於十年數據驗證）**
   - **Monday Surge**: 1.08（週一增加8-10%）
   - **Saturday Dip**: 0.90（週六減少10%，最安靜的一天）
   - 其他星期保持1.0基準

3. **LNY Law（農曆新年法則）**
   - **LNY Day 1**: 0.70（下降~30%，9/10年驗證）
   - **LNY Day 4**: 1.15（反彈增加15-20%）
   - 這是十年數據中最可靠的預測因子

4. **Post-Holiday Surge（假期後激增）**
   - 假期後首個工作日：1.20（增加15-25%）
   - 自動檢測假期後的工作日
   - 驗證：2018-01-02達到338（+30%）

5. **Post-Typhoon Surge（颱風後激增）**
   - 颱風信號降級後：1.30（增加30%）
   - 預留接口，可通過AI分析觸發

6. **極端寒冷天氣**
   - <10°C: 1.15（增加15%）
   - 基於2016年黑天鵝事件分析（3°C時達到394）

#### 算法公式更新

```
預測值 = Baseline(260) 
       × 月份因子 
       × 星期因子 
       × 假期因子 
       × Post-Holiday因子(1.20)
       × 天氣因子 
       × AI因子
       × Post-Typhoon因子(1.30)
```

#### 技術細節

- 星期因子改為固定值，不再從數據計算
- Baseline使用固定260而非歷史數據平均值
- 標準差仍從歷史數據計算（用於信賴區間）
- 月份因子保持動態計算
- 添加Post-Holiday和Post-Typhoon檢測邏輯

### 📊 驗證數據

- **數據範圍**: 2015-12-03 至 2024-12-03（774筆）
- **驗證準確度**: 
  - LNY Law: 9/10年準確（90%）
  - Monday Surge: 持續驗證
  - Post-Holiday Surge: 多個案例驗證

---

## v1.1.11 - 2025-12-07 15:35 HKT

### 🆕 新功能

1. **自動導入歷史數據**
   - 服務器啟動時自動檢查並導入2015-2024年歷史數據
   - 智能檢測：如果數據已存在則跳過導入，避免重複
   - 無需手動執行導入腳本，部署後自動完成數據初始化
   - 導入過程不阻塞服務器啟動，失敗時只記錄錯誤

### 🔧 改進

- 服務器啟動流程優化，自動完成數據庫初始化
- 導入腳本支持作為模組被require使用
- 改進錯誤處理，確保服務器正常啟動即使導入失敗

### 📊 技術細節

- `server.js` 中添加 `autoImportHistoricalData()` 函數
- `import-historical-data.js` 支持可選的db參數
- 自動檢查數據庫中是否已有歷史數據（通過source標記）
- 使用現有的數據庫連接，避免重複初始化

---

## v1.1.10 - 2025-12-07 15:30 HKT

### 🆕 新功能

1. **十年歷史數據整合（2015-2024）**
   - 導入2015年12月至2024年12月的完整歷史數據（共774筆）
   - 數據涵蓋疫情前、疫情期間和疫情後的完整週期
   - 新增 `import-historical-data.js` 腳本用於批量導入歷史數據
   - 數據來源標記為 `historical_analysis_2015_2024`

2. **預測算法更新（基於十年數據分析）**
   - 更新算法註釋，反映十年數據分析的核心發現
   - True Normal Baseline: ~260 病人/天（基於2018-2019和2024-2025正常年份）
   - LNY Law: 農曆新年第一天下降~30%（9/10年驗證）
   - Monday Surge: 週一增加8-10%
   - Post-Holiday Surge: 假期後首個工作日增加15-25%
   - 疫情期間（2020-2022）數據識別為異常值

### 📊 技術細節

- CSV數據解析支持自動修復日期格式錯誤
- 批量導入使用 `insertBulkActualData` 函數，支持衝突更新
- 數據範圍：2015-12-03 至 2024-12-03
- 所有歷史數據標記為 `historical_analysis_2015_2024` 來源

### 🔧 改進

- 預測算法文檔更新，反映十年數據分析結果
- 數據導入腳本包含錯誤處理和進度顯示
- 支持數據庫連接檢查和友好的錯誤訊息

---

## v1.1.9 - 2025-12-07 03:39 HKT

### 🔧 改進

1. **AI 分析因素繁體中文支持**
   - 確保 AI 返回的所有分析因素使用繁體中文
   - 在 system message 和 prompt 中明確要求使用繁體中文
   - 添加簡體到繁體的類型映射，確保顯示正確
   - 因素類型、描述、分析理由、總結等全部使用繁體中文

### 📊 技術細節

- 更新 `ai-service.js` 中的 prompt，明確要求返回繁體中文
- 在 `prediction.js` 中添加簡體到繁體的類型轉換映射
- 確保信心度顯示也使用繁體中文

---

## v1.1.7 - 2025-12-06 07:46 HKT

### 🆕 新功能

1. **每日預測記錄與平均化系統**
   - 新增 `daily_predictions` 表：記錄每次預測更新（包含時間戳、天氣數據、AI因素）
   - 新增 `final_daily_predictions` 表：保存每天的平均預測值（用於與真實數據比較）
   - 每次預測更新時自動保存到數據庫
   - 每天 00:00 HKT 自動計算前一天所有預測的平均值

2. **預測準確度追蹤改進**
   - `calculateAccuracy()` 現在優先使用最終平均預測數據進行比較
   - 支持查看每日預測的更新歷史
   - 更準確的 AI vs 真實數據比較

3. **新增 API 端點**
   - `POST /api/daily-predictions` - 保存每次預測更新
   - `POST /api/calculate-final-prediction` - 手動觸發計算某天的最終預測

### 🔧 改進

- 預測系統現在會持續記錄每次更新，而不是只保存最後一次
- 使用平均值作為最終預測，減少單次預測的波動影響
- 自動定時任務確保每天結束時計算平均值

### 📊 技術細節

- 新增 `insertDailyPrediction()` 函數保存每次預測
- 新增 `calculateFinalDailyPrediction()` 函數計算平均值
- 新增 `getFinalDailyPredictions()` 函數獲取最終預測數據
- 定時任務使用香港時間（HKT）確保準確性
- 數據庫索引優化查詢性能

---

## v1.1.6 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.5 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.4 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI 分析錯誤處理改進**
   - 改進 AI API 錯誤處理，提供更詳細的錯誤訊息
   - 添加錯誤響應解析，正確顯示 API 返回的錯誤詳情
   - 改進 HTTP 錯誤處理，顯示具體的錯誤代碼和訊息
   - 添加錯誤日誌記錄，便於診斷問題
   - 改進 JSON 解析錯誤處理，顯示原始響應內容

2. **錯誤顯示改進**
   - 添加專門的錯誤狀態 UI（`.factors-error`）
   - 改進錯誤訊息顯示，包含錯誤圖標、標題、詳細訊息和提示
   - 確保錯誤訊息能正確傳遞到前端並顯示
   - 添加錯誤樣式，使用紅色主題突出顯示錯誤狀態

### 🔧 改進

- 改進 `ai-service.js` 中的錯誤處理邏輯
- 改進 `server.js` 中的 API 錯誤處理
- 改進 `prediction.js` 中的錯誤處理和日誌記錄
- 添加詳細的錯誤堆疊日誌，便於調試
- 改進 API 響應錯誤解析，提取具體錯誤訊息

### 📊 技術細節

- 在 `callAI()` 函數中添加錯誤響應解析
- 在 `searchRelevantNewsAndEvents()` 中添加詳細錯誤日誌
- 在 `updateAIFactors()` 中添加錯誤響應解析
- 添加 `.factors-error` CSS 樣式類
- 改進錯誤訊息的用戶友好性

---

## v1.1.3 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI Summary 顯示問題**
   - 修復 AI 只返回 summary 時被誤判為失敗的問題
   - 改進數據有效性檢查邏輯，統一所有檢查點
   - 當 AI 返回有意義的 summary（即使沒有 factors）時，正確顯示而不是顯示錯誤
   - 改進緩存數據為空時的處理邏輯
   - 確保有意義的 summary 也能正確保存和顯示

2. **AI 分析載入進度顯示**
   - 修復「載入 AI 分析中...」無法顯示百分比進度的問題
   - 添加 `factors-loading` 的進度條和百分比顯示
   - 實現 `updateFactorsLoadingProgress()` 函數來更新 AI 分析載入進度
   - 在 `updateAIFactors()` 函數中添加進度更新邏輯（10% → 30% → 60% → 90% → 100%）
   - 更新 CSS 樣式，使 `factors-loading` 與其他載入元素樣式一致

### 🔧 改進

- 統一所有數據有效性檢查邏輯
- 改進日誌輸出，顯示實際返回的數據以便調試
- 改進用戶體驗，避免誤報錯誤

### 📊 技術細節

- 新增 `updateFactorsLoadingProgress()` 函數用於更新 AI 分析載入進度
- 在 AI 分析的各個階段（API 請求、數據處理、保存緩存）添加進度更新
- 改進 `factors-loading` 的 HTML 結構，包含 spinner、百分比文字和進度條
- 統一載入狀態的視覺樣式
- 改進數據有效性驗證，檢查 summary 是否為空字符串或只有空白字符

---

## v1.1.2 - 2025-12-06 (香港時間 HKT)

### 🎨 UI/UX 改進

1. **統一 Section 樣式**
   - 統一所有 section 的標題樣式（h2）：字體大小 1.5rem，字重 700，統一的間距和字母間距
   - 統一所有 section 的底部間距：`margin-bottom: var(--space-3xl)`
   - 為每個 section 添加統一的圖標前綴：
     - 📊 實時影響因素
     - 📅 未來 7 天預測
     - 📈 圖表區域
     - 🔬 算法說明
   - 響應式設計：在小螢幕上統一調整 section 標題大小和間距

### 📊 技術細節

- 新增統一的 `section` 和 `section h2` 基礎樣式
- 所有 section 現在使用一致的視覺語言
- 改進移動端顯示一致性

---

## v1.1.1 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **AI 整合**
   - 整合 AI 模型分析，自動搜索可能影響北區醫院病人數量的新聞和事件
   - 支持多種 AI 模型：
     - 高級模型（gpt-5.1, gpt-5, gpt-4o, gpt-4.1）：一天5次
     - 中級模型（deepseek-r1, deepseek-v3, deepseek-v3-2-exp）：一天30次
     - 基礎模型（gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano）：一天200次
   - 智能模型選擇，根據使用限制自動切換

2. **天氣觸發預測更新**
   - 當天氣數據更新時，自動觸發預測重新計算
   - 每分鐘檢查天氣變化，如有變化則更新預測
   - 天氣因素已整合到預測算法中

3. **AI 因素分析**
   - 自動分析可能影響病人數量的因素：
     - 天氣相關事件（極端天氣、颱風、暴雨等）
     - 公共衛生事件（流感爆發、食物中毒等）
     - 社會事件（大型活動、交通事故等）
     - 季節性因素（節日效應、學校假期等）
   - AI 分析結果自動整合到預測計算中

4. **新增 API 端點**
   - `GET /api/ai-analyze` - 獲取 AI 分析的因素
   - `POST /api/ai-analyze-range` - 分析特定日期範圍的因素
   - `GET /api/ai-usage` - 獲取 AI 使用統計

### 🔧 改進

1. **預測算法增強**
   - 預測公式更新：`預測值 = 全局平均 × 月份因子 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子`
   - 預測結果現在包含天氣影響和 AI 分析因素
   - UI 顯示所有影響因子，包括天氣和 AI 因素

2. **自動更新機制**
   - 每分鐘自動檢查天氣更新
   - 每30分鐘自動更新 AI 因素分析
   - 天氣或 AI 因素更新時自動刷新預測和圖表

3. **性能優化**
   - AI 因素緩存機制，減少重複分析
   - 智能使用計數器，按日期自動重置

### 📊 算法邏輯更新

- 天氣影響因子已整合到預測計算中
- AI 分析因素作為額外乘數因子應用
- 所有因子在 UI 中清晰顯示

### 🔐 技術細節

- 使用 Node.js 原生 https 模組進行 AI API 調用
- 支持服務器端和客戶端環境
- API 使用限制管理，防止超額使用
- 使用 API 轉發主機：
  - 主主機：`api.chatanywhere.tech` (國內中轉，延遲更低)
  - 備用主機：`api.chatanywhere.org` (國外使用)
  - 自動故障轉移：主主機失敗時自動切換到備用主機

---

## v1.0.0 - 2024-12-XX

### 初始版本

- 基於歷史數據的預測模型
- 星期效應、月份效應、假期效應分析
- 天氣數據獲取和顯示
- 圖表可視化
- 數據庫整合
<<<<<<< Updated upstream
=======


>>>>>>> Stashed changes
