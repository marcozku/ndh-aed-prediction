# 版本更新日誌

## v1.1.4 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI 分析錯誤處理改進**
   - 改進 AI API 錯誤處理，提供更詳細的錯誤訊息
   - 添加錯誤響應解析，正確顯示 API 返回的錯誤詳情
   - 改進 HTTP 錯誤處理，顯示具體的錯誤代碼和訊息
   - 添加錯誤日誌記錄，便於診斷問題
   - 改進 JSON 解析錯誤處理，顯示原始響應內容

2. **錯誤顯示改進**
   - 添加專門的錯誤狀態 UI（`.factors-error`）
   - 改進錯誤訊息顯示，包含錯誤圖標、標題、詳細訊息和提示
   - 確保錯誤訊息能正確傳遞到前端並顯示
   - 添加錯誤樣式，使用紅色主題突出顯示錯誤狀態

### 🔧 改進

- 改進 `ai-service.js` 中的錯誤處理邏輯
- 改進 `server.js` 中的 API 錯誤處理
- 改進 `prediction.js` 中的錯誤處理和日誌記錄
- 添加詳細的錯誤堆疊日誌，便於調試
- 改進 API 響應錯誤解析，提取具體錯誤訊息

### 📊 技術細節

- 在 `callAI()` 函數中添加錯誤響應解析
- 在 `searchRelevantNewsAndEvents()` 中添加詳細錯誤日誌
- 在 `updateAIFactors()` 中添加錯誤響應解析
- 添加 `.factors-error` CSS 樣式類
- 改進錯誤訊息的用戶友好性

---

## v1.1.3 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI Summary 顯示問題**
   - 修復 AI 只返回 summary 時被誤判為失敗的問題
   - 改進數據有效性檢查邏輯，統一所有檢查點
   - 當 AI 返回有意義的 summary（即使沒有 factors）時，正確顯示而不是顯示錯誤
   - 改進緩存數據為空時的處理邏輯
   - 確保有意義的 summary 也能正確保存和顯示

2. **AI 分析載入進度顯示**
   - 修復「載入 AI 分析中...」無法顯示百分比進度的問題
   - 添加 `factors-loading` 的進度條和百分比顯示
   - 實現 `updateFactorsLoadingProgress()` 函數來更新 AI 分析載入進度
   - 在 `updateAIFactors()` 函數中添加進度更新邏輯（10% → 30% → 60% → 90% → 100%）
   - 更新 CSS 樣式，使 `factors-loading` 與其他載入元素樣式一致

### 🔧 改進

- 統一所有數據有效性檢查邏輯
- 改進日誌輸出，顯示實際返回的數據以便調試
- 改進用戶體驗，避免誤報錯誤

### 📊 技術細節

- 新增 `updateFactorsLoadingProgress()` 函數用於更新 AI 分析載入進度
- 在 AI 分析的各個階段（API 請求、數據處理、保存緩存）添加進度更新
- 改進 `factors-loading` 的 HTML 結構，包含 spinner、百分比文字和進度條
- 統一載入狀態的視覺樣式
- 改進數據有效性驗證，檢查 summary 是否為空字符串或只有空白字符

---

## v1.1.2 - 2025-12-06 (香港時間 HKT)

### 🎨 UI/UX 改進

1. **統一 Section 樣式**
   - 統一所有 section 的標題樣式（h2）：字體大小 1.5rem，字重 700，統一的間距和字母間距
   - 統一所有 section 的底部間距：`margin-bottom: var(--space-3xl)`
   - 為每個 section 添加統一的圖標前綴：
     - 📊 實時影響因素
     - 📅 未來 7 天預測
     - 📈 圖表區域
     - 🔬 算法說明
   - 響應式設計：在小螢幕上統一調整 section 標題大小和間距

### 📊 技術細節

- 新增統一的 `section` 和 `section h2` 基礎樣式
- 所有 section 現在使用一致的視覺語言
- 改進移動端顯示一致性

---

## v1.1.1 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **AI 整合**
   - 整合 AI 模型分析，自動搜索可能影響北區醫院病人數量的新聞和事件
   - 支持多種 AI 模型：
     - 高級模型（gpt-5.1, gpt-5, gpt-4o, gpt-4.1）：一天5次
     - 中級模型（deepseek-r1, deepseek-v3, deepseek-v3-2-exp）：一天30次
     - 基礎模型（gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano）：一天200次
   - 智能模型選擇，根據使用限制自動切換

2. **天氣觸發預測更新**
   - 當天氣數據更新時，自動觸發預測重新計算
   - 每分鐘檢查天氣變化，如有變化則更新預測
   - 天氣因素已整合到預測算法中

3. **AI 因素分析**
   - 自動分析可能影響病人數量的因素：
     - 天氣相關事件（極端天氣、颱風、暴雨等）
     - 公共衛生事件（流感爆發、食物中毒等）
     - 社會事件（大型活動、交通事故等）
     - 季節性因素（節日效應、學校假期等）
   - AI 分析結果自動整合到預測計算中

4. **新增 API 端點**
   - `GET /api/ai-analyze` - 獲取 AI 分析的因素
   - `POST /api/ai-analyze-range` - 分析特定日期範圍的因素
   - `GET /api/ai-usage` - 獲取 AI 使用統計

### 🔧 改進

1. **預測算法增強**
   - 預測公式更新：`預測值 = 全局平均 × 月份因子 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子`
   - 預測結果現在包含天氣影響和 AI 分析因素
   - UI 顯示所有影響因子，包括天氣和 AI 因素

2. **自動更新機制**
   - 每分鐘自動檢查天氣更新
   - 每30分鐘自動更新 AI 因素分析
   - 天氣或 AI 因素更新時自動刷新預測和圖表

3. **性能優化**
   - AI 因素緩存機制，減少重複分析
   - 智能使用計數器，按日期自動重置

### 📊 算法邏輯更新

- 天氣影響因子已整合到預測計算中
- AI 分析因素作為額外乘數因子應用
- 所有因子在 UI 中清晰顯示

### 🔐 技術細節

- 使用 Node.js 原生 https 模組進行 AI API 調用
- 支持服務器端和客戶端環境
- API 使用限制管理，防止超額使用
- 使用 API 轉發主機：
  - 主主機：`api.chatanywhere.tech` (國內中轉，延遲更低)
  - 備用主機：`api.chatanywhere.org` (國外使用)
  - 自動故障轉移：主主機失敗時自動切換到備用主機

---

## v1.0.0 - 2024-12-XX

### 初始版本

- 基於歷史數據的預測模型
- 星期效應、月份效應、假期效應分析
- 天氣數據獲取和顯示
- 圖表可視化
- 數據庫整合

