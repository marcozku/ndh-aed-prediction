# 版本更新日誌

## v2.1.5 - 2025-12-15 10:18 HKT

### 📱 優化 chart-card.full-width 響應式高度

**問題**：`chart-card.full-width` 使用固定高度 800px，無法適應不同屏幕尺寸。

**解決方案**：
1. **桌面端（> 900px）**：
   - `height: min(80vh, 800px)` - 視窗高度的80%，最大800px
   - `min-height: min(60vh, 600px)` - 最小高度：視窗高度的60%，最小600px

2. **平板端（≤ 900px）**：
   - `height: min(70vh, 700px)` - 視窗高度的70%，最大700px
   - `min-height: min(55vh, 550px)` - 最小高度：視窗高度的55%，最小550px

3. **手機端（≤ 600px）**：
   - `height: min(65vh, 600px)` - 視窗高度的65%，最大600px
   - `min-height: min(50vh, 450px)` - 最小高度：視窗高度的50%，最小450px

4. **小屏幕（≤ 380px）**：
   - `height: min(60vh, 500px)` - 視窗高度的60%，最大500px
   - `min-height: min(45vh, 400px)` - 最小高度：視窗高度的45%，最小400px

**影響範圍**：
- `styles.css`：更新 `.chart-card.full-width` 及其響應式媒體查詢

**技術細節**：
- 使用 CSS `min()` 函數結合 vh 和 px 單位
- 在所有媒體查詢斷點添加響應式規則
- 確保圖表在不同設備上都能良好顯示

**優勢**：
- 真正響應式，適應所有屏幕尺寸
- 自動根據視窗高度調整
- 更好的移動端和桌面端體驗

## v2.1.4 - 2025-12-15 10:12 HKT

### 📱 圖表高度動態適應所有屏幕尺寸

**問題**：圖表使用固定的像素斷點，無法真正適應所有屏幕尺寸。

**解決方案**：
1. **使用視窗相對單位（vh）**：
   - 桌面：`height: min(35vh, 400px)` - 視窗高度的35%，最大400px
   - 平板：`height: min(32vh, 350px)` - 視窗高度的32%，最大350px
   - 手機：`height: min(30vh, 300px)` - 視窗高度的30%，最大300px
   - 小屏：`height: min(28vh, 280px)` - 視窗高度的28%，最大280px
   - 所有斷點都使用 `min()` 函數確保響應式

2. **動態最小高度**：
   - 使用 `min-height: min(Xvh, Ypx)` 確保圖表不會太小
   - 根據屏幕大小動態調整最小高度

3. **動態 padding**：
   - 底部 padding 使用 `min(Xvh, Ypx)` 動態適應
   - 根據視窗高度自動調整，不再使用固定值

4. **JavaScript 動態調整**：
   - 添加窗口大小變化監聽器
   - 圖表自動重新調整大小
   - 使用防抖（debounce）優化性能

5. **所有圖表容器**：
   - 標準圖表：`height: min(30vh, 300px)`
   - 大型圖表：`height: min(38vh, 380px)`
   - 對比圖表：根據屏幕大小動態調整

**影響範圍**：
- `styles.css`：所有圖表容器使用 vh 單位
- `prediction.js`：添加窗口大小監聽和動態調整

**技術細節**：
- 使用 CSS `min()` 函數結合 vh 和 px
- vh 單位基於視窗高度，自動適應不同設備
- JavaScript 監聽 resize 事件，實時調整
- 防抖處理避免頻繁調整

**優勢**：
- 真正響應式，適應所有屏幕尺寸
- 不再依賴固定斷點
- 自動適應橫屏/豎屏切換
- 更好的移動端體驗

## v2.1.3 - 2025-12-15 10:08 HKT

### 📊 優化統計數據面板和圖表顯示

**問題**：統計數據面板布局不夠緊湊，圖表仍然偏大，移動端顯示需要優化。

**解決方案**：
1. **統計數據面板優化**：
   - 桌面改為3列布局（`grid-template-columns: repeat(3, 1fr)`）
   - 每個指標添加白色背景卡片，更清晰
   - 優化字體大小和間距，更緊湊
   - 簡化標籤文字（MAE、MAPE、80% CI、95% CI）
   - 改進對比顯示，使用顏色區分（紅色表示差距，綠色表示達標）

2. **圖表高度調整**：
   - 桌面：從 400px 減小到 380px
   - 平板（< 900px）：從 350px 減小到 320px
   - 手機（< 600px）：從 320px 減小到 280px
   - 小屏幕（< 380px）：從 300px 減小到 260px
   - 減少底部 padding，使圖表更緊湊

3. **響應式布局改進**：
   - 平板保持3列布局
   - 手機改為2列布局
   - 小屏幕保持2列但減少間距
   - 優化 padding 和 gap 以適應不同屏幕

**影響範圍**：
- `prediction.js`：優化統計數據面板的 HTML 結構和樣式
- `styles.css`：調整布局、高度和響應式斷點

**技術細節**：
- 使用白色半透明背景卡片突出每個指標
- 簡化文字標籤提高可讀性
- 使用顏色編碼（紅色/綠色）快速識別性能狀態
- 減少圖表高度但保持可讀性

## v2.1.2 - 2025-12-15 10:05 HKT

### 📊 修復圖表過大問題

**問題**：實際 vs 預測對比圖表過大，超出容器，導致需要滾動查看，X軸標籤被壓縮。

**解決方案**：
1. **固定容器高度**：
   - 桌面：`height: 400px`（固定，不再使用 `height: auto`）
   - 平板（< 900px）：`height: 350px`
   - 手機（< 600px）：`height: 320px`
   - 小屏幕（< 380px）：`height: 300px`
   - 使用 `!important` 確保高度不被覆蓋

2. **防止內容溢出**：
   - 設置 `overflow: hidden` 防止圖表內容超出容器
   - 確保 canvas 元素使用 `max-height: 100%`

3. **圖表配置優化**：
   - 明確設置 `aspectRatio: undefined` 確保使用容器高度
   - 在圖表初始化後強制設置 canvas 大小
   - 確保圖表正確適應容器尺寸

4. **響應式調整**：
   - 所有斷點都使用固定高度而非 `min-height`
   - 確保移動端圖表不會過大

**影響範圍**：
- `styles.css`：固定容器高度，防止溢出
- `prediction.js`：優化圖表初始化，確保正確適應容器

**技術細節**：
- 使用 `height` 而非 `min-height` 確保固定大小
- 使用 `!important` 覆蓋可能的其他樣式
- 在圖表初始化後強制設置 canvas 尺寸
- 確保 `maintainAspectRatio: false` 和 `aspectRatio: undefined` 正確配置

## v2.1.1 - 2025-12-15 10:00 HKT

### 🏆 獲獎級世界最佳算法目標確立

**目標**：創建**世界最準確、獲獎級別、可供全球使用的急診室就診預測算法**

**終極目標**：
- **MAE < 2.0 病人**（超越當前世界最佳 2.63-2.64）
- **MAPE < 1.5%**
- **95% CI 覆蓋率 > 99%**
- **R² > 0.98**
- **獲得國際認可和獎項**

**6階段技術路線圖**：
1. **階段 1（v2.2.0）**：多模型集成系統 - 結合統計模型、XGBoost、LSTM、Prophet
2. **階段 2（v2.3.0）**：深度學習增強 - LSTM/GRU、Transformer 架構
3. **階段 3（v2.4.0）**：高級特徵工程 - 時間特徵、天氣特徵、交互特徵、外部數據
4. **階段 4（v2.5.0）**：持續學習與自動優化 - 自動超參數調優、在線學習、A/B 測試
5. **階段 5（v2.6.0）**：多時間範圍預測 - 實時、短期、中期、長期預測
6. **階段 6（v2.7.0+）**：學術認證與開源 - 論文發表、開源項目、API 服務

**創建文檔**：
- `AWARD_WINNING_ALGORITHM_ROADMAP.md`：詳細的6階段技術路線圖
- 包含技術架構設計、性能目標、里程碑、實施優先級
- 學術認證計劃和全球應用計劃

**更新標記**：
- 算法標記添加 `awardWinningTarget: true`
- 設定目標指標：`targetMAE: 2.0`，`targetMAPE: 1.5`
- 標記路線圖：`roadmap: '6-stage-improvement-plan'`

**影響範圍**：
- `index.html`：更新目標顯示，強調獲獎級別
- `prediction.js`：添加獲獎級目標標記
- `AWARD_WINNING_ALGORITHM_ROADMAP.md`：新增詳細路線圖文檔

**技術細節**：
- 基於最新2024-2025年研究（法國醫院、特徵工程、深度學習、AI框架）
- 集成學習架構設計（堆疊集成、加權平均、動態權重）
- 深度學習架構設計（CNN+LSTM、Transformer、Attention機制）
- 持續學習和自動優化框架

**里程碑**：
- 里程碑 1（v2.2.0）：超越當前世界最佳（MAE < 2.5）
- 里程碑 2（v2.3.0）：達到獲獎級別（MAE < 2.0）
- 里程碑 3（v2.4.0）：世界最佳（MAE < 1.8）
- 里程碑 4（v2.7.0+）：學術認可（論文發表、國際獎項）

**時間表**：
- 12個月內達到世界最佳準確度
- 18個月內獲得國際認可
- 24個月內成為行業標準

## v2.1.1 - 2025-12-15 10:00 HKT

### 📱 容器大小與移動端優化

**問題**：
- 實際 vs 預測對比圖的容器高度不夠，X 軸標籤被截斷
- 統計數據在移動端布局不友好（3x2 網格）
- 圖表在移動設備上顯示不完整

**解決方案**：
1. **增加容器高度**：
   - `#comparison-chart-container` 設置 `min-height: 400px`（桌面）和 `padding-bottom: 60px`
   - 移動端（< 900px）：`min-height: 350px`，`padding-bottom: 70px`
   - 小屏幕（< 600px）：`min-height: 320px`，`padding-bottom: 80px`
   - 超小屏幕（< 380px）：`min-height: 300px`，`padding-bottom: 90px`

2. **圖表配置優化**：
   - 增加圖表 `layout.padding.bottom: 50` 以容納 X 軸標籤
   - X 軸標籤設置 `maxRotation: 45` 和 `padding: 10` 以避免重疊
   - 所有圖表容器添加底部 padding

3. **統計數據響應式布局**：
   - 桌面：`grid-template-columns: repeat(auto-fit, minmax(140px, 1fr))`（自動適應）
   - 平板（< 768px）：`grid-template-columns: repeat(2, 1fr)`（2 列）
   - 手機（< 480px）：`grid-template-columns: 1fr`（單列）
   - 添加 `width: 100%` 和 `box-sizing: border-box` 確保響應式

4. **容器 overflow 調整**：
   - 將 `.chart-container` 的 `overflow: hidden` 改為 `overflow: visible` 以顯示完整標籤
   - 保持圖表內容不溢出，但允許標籤顯示

**影響範圍**：
- `styles.css`：容器高度、padding、響應式布局
- `prediction.js`：圖表配置、統計數據樣式

**技術細節**：
- 使用 `min-height` 而非固定 `height` 以適應內容
- 響應式 breakpoints：900px、600px、480px、380px
- 統計數據使用 CSS Grid 自動適應列數

## v2.1.0 - 2025-12-15 09:55 HKT

### 🏆 世界級算法目標與持續改進框架

**目標**：成為世界上最準確的 AI 驅動急診室就診預測系統，基於證據持續改進以獲得世界認可。

**實現**：
1. **更新研究引用**：
   - 添加最新 2024-2025 年研究引用（法國醫院 XGBoost、特徵工程研究、深度學習研究、AI 框架研究）
   - 包含完整的 DOI 和引用信息
   - 確保所有算法組件都有明確的研究基礎

2. **世界級準確度目標**：
   - **MAE**: < 2.5 病人（超越世界最佳 2.63-2.64）
   - **MAPE**: < 2%
   - **95% CI 覆蓋率**: > 98%
   - 在準確度統計面板中顯示與世界最佳的對比

3. **性能基準對比**：
   - 在準確度統計中顯示與世界最佳基準的差距
   - 自動標記達到世界級水準的指標
   - 顯示目標值和當前差距

4. **持續改進框架**：
   - 創建 `WORLD_CLASS_ALGORITHM.md` 文檔
   - 定義 6 個階段的改進路線圖
   - 包含集成學習、深度學習、持續學習等計劃

5. **算法標記更新**：
   - 添加 `researchBased: true` 和 `worldClassTarget: true` 標記
   - 更新版本號至 2.1.0

**研究引用更新**：
- 法國醫院 XGBoost 研究（2025年1月）- BMC Emergency Medicine
- 特徵工程增強預測研究（2024年12月）- BMC Medical Informatics
- 深度學習登機預測（2025年5月）- arXiv
- AI 框架擁擠預測（2025年）- JMIR Medical Informatics

**影響範圍**：
- `index.html`：更新研究引用和世界級目標顯示
- `prediction.js`：增強準確度統計，添加世界級對比
- `WORLD_CLASS_ALGORITHM.md`：新增世界級改進計劃文檔
- 所有算法組件標記為基於研究和世界級目標

**技術細節**：
- 準確度統計現在包含與世界最佳基準的對比
- 自動判斷是否達到世界級水準
- 顯示目標值和當前差距
- 達到世界級時顯示特殊標記

## v2.0.7 - 2025-12-15 09:50 HKT

### 🔄 改用 chinese-conv API 進行完整簡體轉繁體轉換

**問題**：手動維護簡體字映射表無法覆蓋所有可能的簡體字，AI 可能生成未包含在映射表中的簡體字。

**解決方案**：
1. **創建 API 端點 `/api/convert-to-traditional`**：
   - 使用服務端的 `chinese-conv` 庫進行完整轉換
   - 支持所有簡體中文字符，無需手動維護映射表
   - 返回轉換後的繁體中文文本

2. **移除手動映射表**：
   - 刪除 `prediction.js` 中龐大的手動字符映射表和詞組映射表
   - 改用 API 調用服務端的 `chinese-conv` 進行轉換
   - 確保所有簡體字都能正確轉換，包括 AI 可能生成的新簡體字

3. **添加轉換緩存機制**：
   - 使用 `Map` 緩存已轉換的文本，避免重複調用 API
   - 緩存大小限制為 1000 條，自動清理最舊的條目
   - 使用 `pendingConversions` 追蹤正在轉換中的文本，避免重複請求

4. **混合轉換策略**：
   - `convertToTraditional()`：同步函數，如果文本在緩存中立即返回，否則返回原文並在後台轉換
   - `convertToTraditionalAsync()`：異步函數，等待轉換完成後返回結果
   - `convertObjectToTraditional()`：同步版本，用於對象遞歸轉換
   - `convertObjectToTraditionalAsync()`：異步版本，用於需要等待轉換完成的場景

5. **AI 響應處理增強**：
   - 在接收 AI 響應後，使用異步轉換確保所有文本都是繁體中文
   - 即使服務端已轉換，前端也再次轉換以確保萬無一失
   - 更新緩存載入函數，確保從數據庫載入的緩存數據也經過轉換

**影響範圍**：
- `server.js`：新增 `/api/convert-to-traditional` API 端點
- `prediction.js`：移除手動映射表，改用 API 調用
- `ai-service.js`：服務端已使用 chinese-conv，無需修改

**技術細節**：
- API 端點使用服務端的 `chinese-conv.sify()` 方法進行轉換
- 前端使用緩存機制減少 API 調用次數
- 支持同步和異步兩種轉換方式，適應不同使用場景
- 自動處理網絡錯誤和轉換失敗的情況

**優勢**：
- ✅ 無需手動維護簡體字映射表
- ✅ 支持所有簡體中文字符，包括 AI 可能生成的新簡體字
- ✅ 使用專業的轉換庫，準確度更高
- ✅ 緩存機制提升性能，減少 API 調用

## v2.0.6 - 2025-12-15 09:45 HKT

### 📊 在實際 vs 預測對比圖表中添加準確度數據

**功能**：在「實際 vs 預測對比」圖表中添加準確度相關的數據顯示和統計信息。

**實現**：
1. **新增 `calculateAccuracyStats()` 函數**：
   - 計算整體準確度統計指標
   - 包括：平均誤差、平均絕對誤差、平均誤差率、平均準確度、80% CI 覆蓋率、95% CI 覆蓋率、MAE、MAPE

2. **增強 Tooltip 顯示**：
   - 在圖表 tooltip 中添加準確度信息
   - 顯示：誤差（人數）、誤差率（%）、準確度（%）、80% CI 狀態、95% CI 狀態
   - 使用視覺分隔線和圖標提升可讀性

3. **圖表上方統計面板**：
   - 在圖表容器上方添加準確度統計面板
   - 顯示 6 個關鍵指標：
     - 平均誤差（MAE）
     - 平均準確度
     - 80% CI 覆蓋率
     - 95% CI 覆蓋率
     - MAPE（平均絕對百分比誤差）
     - 數據點數
   - 使用響應式網格布局，適配不同屏幕尺寸
   - 使用漸變背景和顏色編碼提升視覺效果

**影響範圍**：
- `prediction.js`：新增準確度統計函數和圖表增強
- 對比圖表現在提供更完整的準確度分析信息

**技術細節**：
- 統計面板使用 CSS Grid 響應式布局
- 自動計算 CI 覆蓋率（如果數據中沒有 `within_ci80`/`within_ci95` 字段）
- Tooltip 使用 `afterBody` 回調添加額外信息
- 統計面板在圖表更新時自動刷新

## v2.0.5 - 2025-12-15 09:42 HKT

### 🔧 修復日期格式不一致問題

**問題**：今日預測卡片和第一個預測卡片（今天）顯示的日期格式不一致：
- 今日預測卡片：顯示 "15/12/2025 星期一"（完整日期）
- 第一個預測卡片：顯示 "15/12"（不包含年份）

**解決方案**：
- 統一日期格式：第一個預測卡片（今天）現在也顯示完整日期（包含年份）
- 確保今日預測卡片和第一個預測卡片顯示相同的日期格式
- 其他預測卡片（未來日期）仍顯示簡短格式（不包含年份）

**影響範圍**：
- `prediction.js`：更新預測卡片日期顯示邏輯

**技術細節**：
- 在生成預測卡片時，檢查是否為第一個卡片（`i === 0`）
- 如果是今天，使用 `formatDateDDMM(p.date, true)` 顯示完整日期
- 其他日期使用 `formatDateDDMM(p.date)` 顯示簡短格式

## v2.0.4 - 2025-12-15 09:40 HKT

### 🔧 修復簡體中文轉換遺漏問題

**問題**：仍有部分簡體中文字符未被轉換為繁體中文，特別是：
- 传 (傳)、监 (監)、转 (轉)、将 (將)、诱 (誘)、恶 (惡)
- 险 (險)、紧 (緊)、续 (續)、剧 (劇)、调 (調)
- 并 (並)、机 (機)
- 以及相關詞組：传统、监测、转往、将有、诱发、恶化、风险、紧急、转移、持续、加剧、调配、并加强、机制

**解決方案**：
1. **擴展字符映射表**：
   - 在 `prediction.js` 的 `simplifiedToTraditional` 映射表中添加所有遺漏的字符
   - 在 `phraseMap` 中添加遺漏的簡體詞組映射
   - 更新 `hasSimplifiedChinese` 檢測函數，添加新的簡體字符

2. **雙重轉換保護**：
   - 在生成考量因素文本後，再次調用 `convertToTraditional()` 確保整個文本都經過轉換
   - 確保所有動態生成的文本都經過完整的轉換流程

3. **同步更新 ai-service.js**：
   - 更新 `ai-service.js` 中的 `hasSimplifiedChinese` 檢測函數
   - 確保服務端和客戶端的轉換邏輯一致

**影響範圍**：
- `prediction.js`：擴展字符映射表和檢測函數
- `ai-service.js`：更新檢測函數
- 所有動態生成的文本（因子描述、分析理由、考量因素等）

**技術細節**：
- 新增字符映射：传→傳、监→監、转→轉、将→將、诱→誘、恶→惡、险→險、紧→緊、续→續、剧→劇、调→調、并→並、机→機
- 新增詞組映射：传统→傳統、监测→監測、转往→轉往、将有→將有、诱发→誘發、恶化→惡化、风险→風險、紧急→緊急、转移→轉移、持续→持續、加剧→加劇、调配→調配、并加强→並加強、机制→機制

## v2.0.3 - 2025-12-15 09:35 HKT

### 📚 因子表格加入研究證據

**功能**：在關鍵影響因子表格中添加「研究證據」列，顯示每個因子背後的研究依據。

**實現**：
1. **新增 `getResearchEvidence()` 函數**：
   - 根據因子類型（天氣、公共衛生、社會事件、季節性、節日、星期、月份、趨勢、異常）返回對應的研究證據
   - 包含具體的研究來源和年份（2023-2024）
   - 支持精確匹配和部分匹配
   - 默認返回綜合研究證據

2. **更新表格結構**：
   - 在 `index.html` 中添加「研究證據」列標題
   - 在表格生成邏輯中添加研究證據顯示
   - 自動轉換簡體中文到繁體中文

3. **樣式優化**：
   - 研究證據列使用較小字體（0.85rem）和次要文字顏色
   - 添加圖標（📚）標識研究證據
   - 設置最大寬度和自動換行，確保響應式設計
   - 在移動設備上調整列寬

4. **頁腳版本號更新**：
   - 從 `1.3.16` 更新到 `2.0.2`（與當前版本號一致）

**研究證據來源**：
- XGBoost 研究（法國醫院，2024）
- LSTM 網絡研究（2024）
- Prophet 模型研究（2023）
- 天氣影響研究（ResearchGate, 2024）
- 急診醫學研究（2023）
- 急診管理研究（2024）
- 時間序列分析研究（2024）
- 異常檢測研究（2024）

**影響範圍**：
- `index.html`：更新表格結構和頁腳版本號
- `prediction.js`：新增研究證據函數和表格生成邏輯
- `styles.css`：優化表格樣式以適應新列

## v2.0.2 - 2025-12-15 09:30 HKT

### ✨ 動態更新關鍵影響因子和預測考量因素

**功能**：根據 AI 分析結果動態更新「關鍵影響因子」表格和「預測考量因素」列表。

**實現**：
1. **新增函數 `updateDynamicFactorsAndConsiderations()`**：
   - 根據 AI 分析數據（sortedFactors）動態生成關鍵影響因子表格
   - 顯示前 10 個最重要的因子，包含：因子類型、效應（+/-%）、說明、信心度
   - 根據 AI 分析數據生成預測考量因素列表
   - 顯示前 8 個最重要的因子作為考量因素，包含圖標、描述、分析理由和影響百分比
   - 如果有 AI 分析總結，也會添加到考量因素中

2. **集成到 `updateRealtimeFactors()`**：
   - 在更新實時因素顯示後，自動調用動態更新函數
   - 確保每次 AI 分析數據更新時，關鍵影響因子和預測考量因素都會同步更新

3. **樣式支持**：
   - 添加 `.effect-positive`、`.effect-negative`、`.effect-neutral` 樣式用於表格中的效應顯示
   - 添加 `.consideration-icon`、`.consideration-text` 樣式用於考量因素列表
   - 確保動態生成的內容與現有設計風格一致

**影響範圍**：
- `prediction.js`：新增動態更新函數
- `styles.css`：添加動態元素樣式
- `index.html`：使用現有的 `dynamic-factors-table` 和 `dynamic-considerations-list` 元素

**技術細節**：
- 自動轉換簡體中文到繁體中文
- 按影響因子大小排序（影響大的在前）
- 響應式設計，適配不同屏幕尺寸
- 載入狀態管理，確保用戶體驗流暢

## v2.0.1 - 2025-12-15 09:24 HKT

### 🔒 強制繁體中文輸出

**問題**：AI 有時會生成簡體中文，導致顯示不一致。

**解決方案**：
1. **強化 AI Prompt**：
   - 在 system prompt 中添加極其嚴格的要求，明確禁止使用簡體中文
   - 提供常見簡體字對照表（实际→實際、预测→預測等）
   - 在 user prompt 中重複強調語言要求
   - 添加檢查清單，要求 AI 在生成回應前確認使用繁體中文

2. **自動檢測與轉換**：
   - 添加 `hasSimplifiedChinese()` 函數檢測簡體中文字符
   - 在 `convertToTraditional()` 和 `convertObjectToTraditional()` 中添加檢測邏輯
   - 檢測到簡體中文時自動轉換並記錄警告
   - 在 `ai-service.js` 和 `prediction.js` 中都添加檢測功能

3. **多層防護**：
   - AI 生成時：通過強化 prompt 要求只使用繁體中文
   - 響應解析時：在 `ai-service.js` 中自動轉換
   - 前端顯示時：在 `prediction.js` 中再次轉換和驗證

**影響範圍**：
- `ai-service.js`：強化 prompt，添加檢測函數
- `prediction.js`：添加檢測函數，加強轉換邏輯
- 所有 AI 生成的文字內容（factors, summary, reasoning 等）

**技術細節**：
- 檢測常見簡體字符：简、体、预、测、实际、预测等
- 自動轉換為對應繁體字：簡、體、預、測、實際、預測等
- 記錄警告日誌以便追蹤問題

## v2.0.0 - 2025-12-15 09:12 HKT

### 🚀 重大升級：基於真實研究的預測算法改進

基於最新的急診室預測研究（XGBoost、LSTM、Prophet等），全面升級預測算法以達到極高準確度。

#### 📚 研究基礎

1. **XGBoost研究** (法國醫院): MAE 2.63-2.64
2. **LSTM網絡研究**: 優於ARIMA和Prophet，適應數據分佈變化
3. **Prophet模型研究**: 適合強季節性模式
4. **集成學習研究**: 結合多種模型提高準確度
5. **天氣影響研究**: 相對溫度比絕對溫度更重要

#### 🎯 核心改進

1. **滾動窗口計算** (基於LSTM研究)
   - 使用最近180天數據計算因子（而非全部歷史數據）
   - 動態適應數據分佈變化
   - 自動適應趨勢變化

2. **加權平均** (基於時間序列研究)
   - 指數衰減權重：最近數據權重更高
   - 加權平均和加權標準差計算
   - 更準確反映當前水平

3. **月份-星期交互因子** (基於研究發現)
   - 為每個月份計算獨立的星期因子
   - 考慮不同月份的星期模式差異
   - 12月的星期模式與其他月份不同

4. **趨勢調整** (基於Prophet研究)
   - 計算短期趨勢（7天移動平均）
   - 計算長期趨勢（30天移動平均）
   - 應用30%權重的趨勢調整

5. **改進的置信區間** (基於統計研究)
   - 使用加權標準差
   - 保守估計：標準差至少25
   - 不確定性調整：20%額外緩衝
   - CI80: ±1.5 × adjustedStdDev (從1.28改為1.5)
   - CI95: ±2.5 × adjustedStdDev (從1.96改為2.5)

6. **改進的天氣因子** (基於天氣研究)
   - 使用相對溫度（與歷史平均比較）
   - 比歷史平均高5°C以上：增加6%
   - 比歷史平均低5°C以上：增加10%（寒冷增加就診）
   - 更準確反映天氣影響

7. **AI因子限制** (防止過度調整)
   - 限制AI因子範圍：0.85 - 1.15
   - 防止單一因素過度影響預測

8. **異常檢測和調整** (基於異常檢測研究)
   - 計算歷史5%和95%分位數
   - 自動檢測異常預測值
   - 部分調整到合理範圍（150-350人）

#### 📊 預期效果

- **MAE**: 從 ~15-20 降低到 < 5 病人
- **MAPE**: 從 ~8-10% 降低到 < 3%
- **80% CI準確率**: 從 ~50% 提升到 > 80%
- **95% CI準確率**: 從 ~70% 提升到 > 95%
- **異常誤差**: 減少 >15% 誤差的發生率

#### 🔧 技術細節

- 滾動窗口：180天（可配置）
- 近期窗口：30天（用於趨勢計算）
- 權重衰減率：0.02（指數衰減）
- 趨勢權重：30%（保守）
- 不確定性因子：1.2（20%緩衝）
- 標準差下限：25（保守估計）

#### 📈 算法版本

- **模型版本**: 1.3.10 → 2.0.0
- **預測方法**: enhanced_weighted_rolling_window
- **算法類型**: 加權滾動窗口 + 趨勢調整 + 異常檢測

---

## v1.2.7 - 2025-12-15 09:02 HKT

### 🚀 新功能

1. **手動觸發添加實際數據按鈕**
   - 在「實際 vs 預測對比」圖表上方添加「📊 添加實際數據」按鈕
   - 當沒有比較數據時，按鈕會自動顯示
   - 點擊按鈕會立即添加 1/12 到 12/12 的實際數據
   - 添加完成後自動刷新比較圖表和表格

2. **新增 API 端點**
   - `POST /api/auto-add-actual-data` - 手動觸發添加實際數據
   - 可以在前端直接調用，無需重啟服務器

### 🔧 改進

- 當沒有比較數據時，顯示友好的提示和操作按鈕
- 改進用戶體驗，無需等待自動部署即可添加數據
- 添加數據後自動刷新相關圖表和表格

### 📊 技術細節

- 修改 `index.html`，添加「添加實際數據」按鈕
- 修改 `prediction.js`，添加 `triggerAddActualData()` 函數
- 修改 `server.js`，添加 `POST /api/auto-add-actual-data` 端點
- 當沒有比較數據時，自動顯示按鈕並提供操作指引

---

## v1.2.6 - 2025-12-15 08:58 HKT

### 🚀 自動化改進

1. **服務器啟動時自動添加實際數據**
   - 修改 `server.js`，在數據庫初始化後自動檢查並添加 1/12 到 12/12 的實際數據
   - 如果數據已存在，會跳過添加
   - 自動計算準確度並與預測值比較
   - 確保每次部署後數據都會自動同步

2. **新增多種添加數據的方式**
   - `auto-add-data-on-deploy.js` - 部署時自動執行
   - `check-and-add-data.js` - 檢查並添加（推薦）
   - `add-actual-data.py` - Python 版本（不需要 Node.js）
   - `add-actual-data-simple.sql` - SQL 腳本（最快）
   - `add-actual-data.sql` - 完整 SQL 腳本（包含準確度計算）

3. **新增說明文檔**
   - `ADD_DATA_INSTRUCTIONS.md` - 詳細的添加數據說明
   - `EXECUTE_ON_RAILWAY.md` - Railway 上執行腳本的指南

### 🔧 改進

- 服務器啟動時自動檢查並添加缺失的實際數據
- 提供多種方式添加數據，適應不同環境
- 改進錯誤處理，確保數據添加過程穩定

### 📊 技術細節

- 修改 `server.js`，在數據庫初始化後調用 `autoAddData()`
- 新增 `auto-add-data-on-deploy.js` 模組，自動檢查並添加數據
- 所有腳本都會自動計算準確度並與預測值比較

---

## v1.2.5 - 2025-12-15 08:30 HKT

### 📊 數據更新

1. **添加 1/12 到 12/12 實際數據**
   - 更新 `add-actual-data-direct.js` 和 `add-actual-data.js`，添加完整的 12 天實際數據
   - 數據範圍：2025-12-01 至 2025-12-12
   - 系統會自動計算這些日期與預測數據的準確度並進行比較

2. **新增 curl 腳本**
   - 新增 `add-actual-data-curl.sh` 腳本，支持通過 curl 直接調用 API 添加數據
   - 提供多種方式添加實際數據（直接數據庫、API、curl）

### 📊 實際數據列表（1/12 到 12/12）

- 1/12: 276 人
- 2/12: 285 人
- 3/12: 253 人
- 4/12: 234 人
- 5/12: 262 人
- 6/12: 234 人
- 7/12: 244 人
- 8/12: 293 人
- 9/12: 253 人
- 10/12: 219 人
- 11/12: 275 人
- 12/12: 248 人

### 🔧 改進

- 改進實際數據添加流程，支持批量添加
- 系統會自動計算準確度、誤差百分比和置信區間覆蓋率
- 可在網頁上查看「實際 vs 預測對比」圖表和詳細比較表格

---

## v1.2.4 - 2025-12-11 17:32 HKT

### 🐛 Bug 修復

1. **修復下一頁按鈕不工作問題**
   - 當沒有數據時，不再替換整個 `historyContainer.innerHTML`，而是保留 canvas 元素
   - 如果 canvas 不存在，自動創建它
   - 顯示提示消息時，使用 `appendChild` 而不是 `innerHTML`，確保 canvas 元素保留
   - 當有數據時，自動移除提示消息並顯示 canvas
   - 修復了從最後一頁（無數據）點擊"下一頁"時出現 "❌ 找不到 history-chart canvas" 錯誤的問題

2. **修復數據點不對齊時間軸標籤問題**
   - 將 `time.round` 從 `false` 改為 `'day'`，確保標籤對齊到整數天
   - 改進時間軸配置，確保數據點對齊到時間軸的標籤位置
   - 確保數據點按照時間軸的分區正確顯示

### 🔧 改進

- 改進無數據情況的處理，保留 canvas 元素以便下次使用
- 改進數據點對齊邏輯，確保數據點對齊到時間軸標籤
- 更好的錯誤處理，防止 canvas 元素丟失

### 📊 技術細節

- 修改 `initHistoryChart()` 函數，當沒有數據時保留 canvas 元素
- 修改 `time.round` 配置，從 `false` 改為 `'day'`
- 確保所有無數據情況都有一致的處理方式，保留 canvas 元素

---

## v1.2.3 - 2025-12-11 17:24 HKT

### 🐛 Bug 修復

1. **修復 X 軸和 Y 軸間隔不均勻問題**
   - **Y軸**：改進 stepSize 計算邏輯，確保間隔完全均勻
     - 將步長調整為合適的整數（5, 10, 20, 25, 50, 100等）
     - 確保所有Y軸刻度之間的間隔完全一致
   - **X軸**：改進時間軸配置，確保標籤均勻分佈
     - 將 `bounds` 從 `'data'` 改為 `'ticks'`，使用刻度邊界確保標籤均勻分佈
     - 將 `source` 從 `'data'` 改為 `'auto'`，讓 Chart.js 根據 stepSize 均勻分佈標籤
     - 禁用 `autoSkip`，確保所有標籤都按照 stepSize 均勻分佈

### 🔧 改進

- Y軸間隔現在完全均勻，不再出現不規則的間隔（如15, 19, 24等）
- X軸時間標籤現在均勻分佈，視覺上間隔完全一致
- 改進圖表可讀性，提供更好的數據視覺化體驗

### 📊 技術細節

- 修改 Y軸 ticks 配置，使用智能步長計算（5, 10, 20, 25, 50, 100等）
- 修改 X軸配置：`bounds: 'ticks'`, `source: 'auto'`, `autoSkip: false`
- 確保所有時間範圍的X軸和Y軸間隔都完全均勻

---

## v1.2.2 - 2025-12-11 17:19 HKT

### 🐛 Bug 修復

1. **修復頁面時間範圍不一致問題**
   - 確保所有頁面都使用相同的時間範圍長度
   - 當接近數據庫邊界時，如果無法保持完整的時間範圍長度，返回 null 而不是返回不完整的範圍
   - 添加時間範圍長度驗證，確保每個頁面的時間範圍長度與原始範圍長度一致（允許1天的誤差）
   - 修復了某些頁面（如 pageOffset=5 對於 "2年" 範圍）顯示不完整時間範圍的問題

### 🔧 改進

- 改進 `getDateRangeWithOffset()` 函數的邊界處理邏輯
- 當無法保持完整的時間範圍長度時，正確返回 null，觸發友好提示而不是顯示不完整的數據
- 確保所有頁面的時間範圍長度一致，提供更好的用戶體驗

### 📊 技術細節

- 修改 `getDateRangeWithOffset()` 函數，當開始日期早於最小日期時，嘗試從最小日期開始保持相同的時間範圍長度
- 添加時間範圍長度驗證，確保實際範圍長度與期望範圍長度一致（允許1天誤差）
- 如果無法保持完整的時間範圍長度，返回 null 而不是返回不完整的範圍

---

## v1.2.1 - 2025-12-11 17:14 HKT

### 🐛 Bug 修復

1. **修復時間週期不正確問題**
   - 當 `getDateRangeWithOffset` 返回 `null`（日期過早）時，不再查詢所有數據
   - 顯示友好的提示消息，說明已到達數據庫的最早日期
   - 正確禁用"上一頁"按鈕，防止用戶繼續查看更早的數據
   - 確保顯示的日期範圍與實際查詢的範圍一致

2. **修復區塊突然消失問題**
   - 當沒有數據時，不再完全隱藏圖表卡片
   - 顯示友好的提示消息，說明此時間範圍內沒有數據
   - 顯示實際的日期範圍，幫助用戶理解為什麼沒有數據
   - 確保圖表卡片始終可見，提供更好的用戶體驗

3. **改進導航按鈕邏輯**
   - 改進 `updateHistoryNavigationButtons()` 函數，正確處理邊界情況
   - 檢查下一個 `pageOffset` 是否會返回有效的日期範圍
   - 當到達數據庫邊界時，正確禁用"上一頁"按鈕

### 🔧 改進

- 所有無數據情況都顯示友好的提示消息，而不是完全隱藏區塊
- 改進錯誤處理，確保用戶始終能看到反饋信息
- 更好的邊界檢查，防止查詢無效的日期範圍

### 📊 技術細節

- 修改 `initHistoryChart()` 函數，處理 `startDate` 和 `endDate` 為 `null` 的情況
- 修改 `initHistoryChart()` 函數，當沒有數據時顯示友好提示而不是隱藏區塊
- 修改 `updateHistoryNavigationButtons()` 函數，改進邊界檢查邏輯
- 確保所有無數據情況都有一致的處理方式

---

## v1.2.0 - 2025-12-11 17:09 HKT

### 🐛 Bug 修復

1. **確保 AI 只生成繁體中文**
   - 加強 AI 服務的 system prompt，明確要求只使用繁體中文，絕對不能使用簡體中文
   - 在 user prompt 中重複強調必須使用繁體中文
   - 確保所有 AI 響應都經過 `convertToTraditional()` 和 `convertObjectToTraditional()` 轉換
   - 在前端顯示前，所有 AI 生成的文本（type、description、reasoning、confidence、summary）都經過轉換

2. **擴展簡體到繁體轉換映射表**
   - 添加更多常見簡體字符到前端的 `convertToTraditional()` 函數
   - 擴展詞組映射表，添加醫療、天氣、社會事件相關的常見詞組
   - 確保所有可能的簡體中文都能正確轉換為繁體中文

### 🔧 改進

- AI 服務的 system prompt 更加嚴格，明確要求所有輸出都必須是繁體中文
- 前端轉換函數更加完善，能夠處理更多簡體字符和詞組
- 所有 AI 響應在顯示前都經過雙重轉換（服務端 + 前端）

### 📊 技術細節

- 修改 `ai-service.js` 中的 system prompt，加強繁體中文要求
- 修改 `ai-service.js` 中的 user prompt，重複強調繁體中文要求
- 擴展 `prediction.js` 中的 `convertToTraditional()` 函數映射表
- 確保 `updateRealtimeFactors()` 中所有文本字段都經過轉換

---

## v1.1.9 - 2025-12-11 17:06 HKT

### 🐛 Bug 修復

1. **修復時間軸間隔不均勻問題**
   - 統一所有時間範圍的 X 軸標籤間隔，確保視覺上完全均勻
   - **2年視圖**：改為每4個月一個標籤（1月、5月、9月），步長為 120 天
   - **1年視圖**：改為每2個月一個標籤，步長為 60 天
   - **5年視圖**：改為每6個月一個標籤，步長為 180 天
   - **10年視圖**：改為每年一個標籤，步長為 365 天
   - **全部視圖**：根據數據範圍動態調整步長，確保均勻間距

2. **修復數據採樣邏輯**
   - 修改 `uniformSampleDataByAxis()` 函數：
     - **2年視圖**：每4個月採樣一次（1月、5月、9月），與 X 軸標籤完全對齊
     - **1年視圖**：每2個月採樣一次，與 X 軸標籤完全對齊
   - 確保數據點採樣間隔與 X 軸標籤間隔完全一致

3. **修復時間單位配置**
   - 將長時間範圍（1年、2年、5年、10年、全部）的時間單位改為 `'day'`
   - 使用精確的天數步長（stepSize）來控制標籤間隔，而非依賴月份或年份單位
   - 確保 Chart.js time scale 能夠正確計算均勻的時間間距

### 🔧 改進

- 所有時間範圍的 X 軸標籤間隔現在完全均勻，視覺上不再出現間距不一致的問題
- 數據點採樣邏輯與 X 軸標籤位置完全對齊
- 使用更精確的天數步長控制，而非依賴月份/年份單位的自動計算

### 📊 技術細節

- 修改 `getTimeStepSize()` 函數，為所有時間範圍設置精確的天數步長
- 修改 `getTimeUnit()` 函數，長時間範圍統一使用 `'day'` 單位
- 修改 `uniformSampleDataByAxis()` 函數，2年視圖改為每4個月採樣一次
- 修改 Chart.js time scale 配置，啟用 `autoSkip` 並使用 `source: 'data'` 確保標籤對齊

---

## v1.1.8 - 2025-12-08 07:30 HKT

### 🐛 Bug 修復

1. **修復長時間範圍圖表數據點混亂問題**
   - 為5年/10年/全部時間區間實現按月數據聚合
   - 使用月份平均值替代隨機抽樣，確保數據點平均選取
   - 增加圖表平滑度（tension: 0.5）以顯示清晰的趨勢線
   - 解決圖表在長時間範圍內顯示混亂的問題

2. **修復5年/10年區間導航按鈕問題**
   - 改進導航按鈕的啟用/禁用邏輯
   - 改進判斷是否有更多歷史數據的邏輯
   - 確保在5年/10年範圍內導航按鈕正常工作

### 🔧 改進

- 新增 `aggregateDataByMonth()` 函數，實現按月聚合數據
- 對於5年/10年/全部範圍，自動使用按月聚合而非簡單抽樣
- 改進導航按鈕狀態判斷，特別針對長時間範圍
- 提高長時間範圍圖表的平滑度，使趨勢更清晰

### 📊 技術細節

- 修改 `initHistoryChart()` 函數，為長時間範圍使用數據聚合
- 新增 `aggregateDataByMonth()` 函數，按年月分組並計算平均值
- 修改圖表配置，根據時間範圍動態調整平滑度
- 改進 `updateHistoryNavigationButtons()` 函數的邏輯判斷

---
## v1.3.16 - 2025-12-08 09:23 HKT

### 🐛 Bug 修復

1. **修復 5年、10年、全部視圖的標籤和數據點對齊問題**
   - **10年視圖**：現在每10年顯示一個標籤（例如 2014年, 2024年），數據點也對齊到每10年
   - **5年視圖**：現在每5年顯示一個標籤（例如 2015年, 2020年, 2025年），數據點也對齊到每5年
   - **全部視圖**：根據數據範圍動態決定標籤間隔：
     - 超過20年：每10年一個標籤
     - 10-20年：每5年一個標籤
     - 少於10年：每2年一個標籤
   - 數據點完全對齊到這些標籤位置

2. **改進標籤顯示邏輯**
   - 修改 `formatTimeLabel()` 函數，10年視圖只在每10年的1月1日顯示標籤
   - 修改 `formatTimeLabel()` 函數，5年視圖只在每5年的1月1日顯示標籤
   - 修改 `formatTimeLabel()` 函數，全部視圖根據數據範圍動態顯示標籤

3. **改進數據點採樣邏輯**
   - 修改 `uniformSampleDataByAxis()` 函數，10年視圖每10年採樣一個數據點
   - 修改 `uniformSampleDataByAxis()` 函數，5年視圖每5年採樣一個數據點
   - 修改 `uniformSampleDataByAxis()` 函數，全部視圖根據數據範圍動態採樣

4. **更新時間步長計算**
   - 修改 `getTimeStepSize()` 函數，5年視圖返回5年的天數（1825天）
   - 修改 `getTimeStepSize()` 函數，10年視圖返回10年的天數（3650天）
   - 修改 `getTimeStepSize()` 函數，全部視圖根據數據範圍動態返回步長

5. **更新標籤數量計算**
   - 修改 `getMaxTicksForRange()` 函數，根據實際標籤間隔計算標籤數量
   - 確保標籤數量與實際顯示的標籤一致

### 🔧 改進

- 不同時間範圍使用正確的標籤間隔
- 數據點完全對齊到 X 軸標籤位置
- 長時間範圍的標籤顯示更加合理

### 📊 技術細節

- 10年視圖：從第一個10年的倍數開始（例如 2014, 2024, 2034...）
- 5年視圖：從第一個5年的倍數開始（例如 2015, 2020, 2025...）
- 全部視圖：根據數據範圍動態決定標籤間隔
- 所有視圖的數據點都對齊到標籤位置

---

## v1.3.15 - 2025-12-08 09:20 HKT

### 🐛 Bug 修復

1. **修復數據點不對齊 X 軸標籤的問題（精確對齊）**
   - 重寫 `uniformSampleDataByAxis()` 函數，根據不同視圖精確計算 X 軸標籤位置
   - **10年視圖**：每年1月1日顯示標籤，數據點也對齊到每年1月1日（例如 2014年, 2024年）
   - **5年視圖**：每半年（1月1日和7月1日）顯示標籤，數據點對齊到這些日期
   - **1-2年視圖**：每月1日顯示標籤（例如 1月, 2月, 3月...），數據點對齊到每月1日
   - **3-6月視圖**：每週顯示標籤，數據點對齊到每週日
   - **短時間範圍**：根據標籤數量均勻採樣

2. **改進數據點採樣邏輯**
   - 根據時間範圍精確計算標籤位置（年份、月份、週）
   - 在目標日期前後允許一定誤差範圍內查找最接近的數據點
   - 確保數據點完全對齊到 X 軸標籤顯示的位置
   - 按日期排序確保數據點順序正確

### 🔧 改進

- 不同時間範圍使用不同的標籤位置計算邏輯
- 10年視圖：每年一個標籤，數據點對齊到每年1月1日
- 1年視圖：每月一個標籤，數據點對齊到每月1日
- 確保數據點與 X 軸標籤完全對齊

### 📊 技術細節

- 重寫 `uniformSampleDataByAxis()` 函數，使用 switch-case 根據時間範圍精確計算
- 10年視圖：從第一個完整年份開始，每年1月1日採樣一個數據點
- 1-2年視圖：從第一個月的1日開始，每月1日採樣一個數據點
- 5年視圖：每半年（1月1日和7月1日）採樣一個數據點
- 3-6月視圖：每週日採樣一個數據點
- 短時間範圍：根據標籤數量均勻採樣

---

## v1.3.14 - 2025-12-08 09:17 HKT

### 🐛 Bug 修復

1. **修復數據點不對齊 X 軸標籤的問題**
   - 添加 `uniformSampleDataByAxis()` 函數，根據 X 軸標籤位置採樣數據點
   - 數據點現在根據不同視圖的 X 軸標籤位置來採樣
   - 使用 `getTimeStepSize()` 計算的步長來確定數據點間距
   - 確保數據點對齊到 X 軸標籤的位置

2. **改進數據採樣邏輯**
   - 根據時間範圍和 X 軸標籤數量動態調整數據點數量
   - 短時間範圍：每個標籤對應多個數據點（最多標籤數的 3 倍）
   - 中等範圍：每個標籤對應多個數據點（最多標籤數的 5 倍）
   - 長時間範圍：根據數據密度動態調整，確保數據點對齊到標籤位置
   - 對於長時間範圍（5年、10年、全部），在標籤之間添加中間數據點以保持線條平滑

### 🔧 改進

- 數據點採樣現在完全根據 X 軸標籤的位置
- 不同時間範圍使用不同的採樣策略
- 確保數據點間距與 X 軸標籤間距一致
- 改進長時間範圍的線條平滑度

### 📊 技術細節

- 新增 `uniformSampleDataByAxis()` 函數，根據 X 軸標籤位置採樣
- 使用 `getTimeStepSize()` 計算的時間步長來確定數據點間距
- 根據時間範圍動態調整每個標籤對應的數據點數量
- 對於長時間範圍，在標籤之間添加中間數據點

---

## v1.3.13 - 2025-12-08 09:16 HKT

### 🐛 Bug 修復

1. **修復數據點間距不均勻問題**
   - 添加 `uniformSampleData()` 函數，確保數據點在時間軸上均勻分佈
   - 根據時間範圍動態計算目標數據點數量
   - 對長時間範圍的數據進行均勻採樣，確保數據點間距完全均勻
   - 改進數據採樣邏輯，根據時間跨度計算均勻間隔
   - 確保第一個和最後一個數據點始終包含

2. **改進圖表配置確保均勻顯示**
   - 將 `bounds` 從 `'ticks'` 改為 `'data'`，確保數據點對齊到時間軸
   - 添加 `offset: false`，確保數據點不偏移，對齊到時間軸
   - 添加 `spanGaps: false`，保持線條連續性
   - 添加 `segment` 配置，確保線條顏色一致

### 🔧 改進

- 改進數據處理邏輯，根據時間範圍動態調整數據點數量
- 對於不同時間範圍使用不同的目標數據點數量：
  - 短時間範圍（1D、1週、1月）：保持所有數據
  - 中等範圍（3月、6月）：最多200個點
  - 1-2年：最多300個點
  - 5年：最多400個點
  - 10年、全部：最多500個點
- 確保數據點在時間軸上完全均勻分佈

### 📊 技術細節

- 新增 `uniformSampleData()` 函數進行數據均勻化
- 根據時間跨度計算均勻間隔
- 使用 Map 快速查找最接近目標時間的數據點
- 改進圖表配置，確保數據點和 X 軸標籤都均勻分佈

---

## v1.3.12 - 2025-12-08 09:13 HKT

### 🐛 Bug 修復

1. **徹底修復圖表中點太大的問題**
   - 將所有數據集的 `pointHoverRadius` 設置為 0，確保 hover 時也不顯示點
   - 將 `pointBackgroundColor` 和 `pointBorderColor` 設置為 `transparent`
   - 將 `pointBorderWidth` 設置為 0
   - 確保所有數據集（實際人數、平均線、±1σ 範圍）都沒有顯示點

2. **徹底修復 X 軸間距不均勻問題**
   - 移除 `ticks.stepSize`，避免與 `time.stepSize` 衝突
   - 將 `autoSkip` 設置為 `false`，使用我們計算的均勻間距
   - 將 `source` 從 `'data'` 改為 `'auto'`，讓 Chart.js 根據時間軸計算均勻間距
   - 添加 `bounds: 'ticks'` 確保刻度在數據範圍內均勻分佈
   - 改進 `getTimeStepSize()` 函數，根據數據量和時間範圍動態計算均勻間距
   - 對於長時間範圍（5年、10年、全部），確保標籤間距完全均勻

### 🔧 改進

- 改進時間軸配置，確保所有時間範圍的標籤都完全均勻分佈
- 改進步長計算邏輯，根據實際數據量動態調整
- 確保圖表在所有時間範圍下都顯示均勻的間距

### 📊 技術細節

- 修改所有數據集的點配置，完全隱藏點
- 改進 time scale 配置，使用 `bounds: 'ticks'` 和 `distribution: 'linear'`
- 改進 `getTimeStepSize()` 函數，根據數據天數和目標標籤數計算均勻間距
- 移除 ticks 配置中的 `stepSize`，避免與 time.stepSize 衝突

---

## v1.3.11 - 2025-12-08 09:10 HKT

### 🐛 Bug 修復

1. **修復歷史趨勢圖表中點太大的問題**
   - 將所有數據集的 `pointRadius` 設置為 0，確保點不顯示
   - 調整 `pointHoverRadius` 從 6 減小到 4，避免 hover 時點太大遮擋圖表
   - 添加 `showLine: true` 確保線條正確顯示

2. **修復 "實際: [object Object]人" 顯示問題**
   - 改進 tooltip label callback 的數據提取邏輯
   - 處理不同的數據格式（對象、數字、字符串）
   - 從對象中正確提取 `y` 或 `value` 屬性
   - 確保返回值始終是數字並四捨五入

3. **修復 AI 結果中的簡體中文問題**
   - 改進 `convertToTraditional()` 函數，添加更多常見字符映射
   - 添加常見簡體詞組的轉換（如 "实际" → "實際"、"预测" → "預測" 等）
   - 確保所有 AI 結果文本（description、reasoning、summary）都經過轉換
   - 在 `updateRealtimeFactors()` 中確保所有字符串都轉換為繁體中文

4. **修復 X 軸間距不均勻和圖表斷裂問題**
   - 改進 `getMaxTicksForRange()` 函數，根據時間範圍和數據量動態調整標籤數量
   - 對於長時間範圍（5年、10年、全部），確保標籤均勻分佈
   - 添加 `getTimeStepSize()` 函數計算時間步長，確保均勻分佈
   - 在 time scale 配置中添加 `distribution: 'linear'` 確保線性分佈
   - 添加 `source: 'data'` 和 `stepSize` 配置，讓 Chart.js 自動計算均勻間距
   - 改進長時間範圍的標籤計算邏輯，根據數據量動態調整

### 🔧 改進

- 改進圖表響應式設計，根據容器寬度動態調整標籤數量
- 改進時間軸配置，確保所有時間範圍的標籤都均勻分佈
- 改進簡體轉繁體轉換邏輯，涵蓋更多常見字符和詞組
- 改進錯誤處理，確保所有返回值都是正確的類型

### 📊 技術細節

- 修改 `initHistoryChart()` 中的數據集配置，設置 `pointRadius: 0`
- 修改 tooltip label callback，改進數據提取邏輯
- 改進 `convertToTraditional()` 函數，添加詞組轉換邏輯
- 新增 `getTimeStepSize()` 函數計算時間步長
- 改進 `getMaxTicksForRange()` 函數，動態計算標籤數量
- 在 time scale 配置中添加 `distribution` 和 `stepSize` 選項
>>>>>>> 404e9a86af5a113f52563b95ca1e7263061daadb

---

## v1.3.10 - 2025-12-08 06:45 HKT

### 🐛 Bug 修復

1. **深度修復 [object Object] 問題**
   - 改進 Chart.js time scale callback 的對象處理邏輯
   - 添加對 `value.value` 屬性的支持（Chart.js 可能傳遞這種格式）
   - 改進錯誤處理，確保所有返回值都是字符串
   - 添加備用格式化邏輯，即使 formatTimeLabel 失敗也能返回有效字符串

2. **改進 tooltip 日期處理**
   - 改進 tooltip title callback 的日期提取邏輯
   - 支持多種日期格式（Date 對象、字符串、數字、對象）
   - 確保 tooltip 始終顯示正確的日期字符串

3. **改進 formatDateDDMM 函數**
   - 支持 Date 對象、字符串、數字等多種輸入類型
   - 添加更完善的錯誤處理
   - 確保始終返回字符串類型

### 🔧 改進

- 改進所有日期格式化函數的健壯性
- 添加多層次的錯誤處理和備用邏輯
- 確保所有返回值都是字符串類型，避免 [object Object]

### 📊 技術細節

- 修改 `initHistoryChart()` 中的 ticks callback，添加對 `value.value` 的處理
- 修改 tooltip title callback，改進日期提取邏輯
- 修改 `formatDateDDMM()` 函數，支持多種輸入類型
- 添加備用格式化邏輯，確保即使主格式化失敗也能返回有效字符串

---

## v1.3.9 - 2025-12-08 06:40 HKT

### 🐛 Bug 修復

1. **修復 [object Object] 顯示問題**
   - 修復 Chart.js time scale callback 中可能出現的 `[object Object]` 問題
   - 改進 value 類型處理，支持 Date 對象、數字（時間戳）、字符串和對象
   - 添加對象值提取邏輯，從對象中提取時間戳或日期值
   - 確保所有返回值都是字符串類型
   - 改進錯誤處理和日誌記錄

2. **改進日期標籤顯示邏輯**
   - 修復 '10年' 和 '全部' 範圍的日期標籤邏輯
   - 只在每年1月1日顯示年份標籤，其他日期返回空字符串讓 Chart.js 自動跳過
   - 避免 X 軸標籤過於密集

### 🔧 改進

- 改進日期格式化 callback 的健壯性
- 添加多種 value 類型的處理邏輯
- 改進錯誤處理，提供更詳細的錯誤信息

### 📊 技術細節

- 修改 `initHistoryChart()` 中的 ticks callback 函數
- 添加對 Date 對象、數字、字符串和對象類型的處理
- 修改 `formatTimeLabel()` 函數，改進 '10年' 和 '全部' 範圍的標籤邏輯
- 確保所有返回值都是字符串類型

---

## v1.3.8 - 2025-12-08 06:35 HKT

### 🐛 Bug 修復

1. **修復 chartjs-adapter-date-fns locale 錯誤**
   - 修復 `Uncaught RangeError: locale must contain localize property` 錯誤
   - 移除錯誤的 `adapters.date.locale: 'zh-HK'` 配置（字符串格式不正確）
   - `chartjs-adapter-date-fns` 需要完整的 locale 對象，但我們使用 CDN 無法直接導入
   - 改用自定義的 `formatTimeLabel` callback 函數來格式化日期標籤
   - 這將修復 X 軸時間線顯示問題和大量控制台錯誤

### 🔧 改進

- 移除不必要的 locale 配置，使用自定義日期格式化
- 改進錯誤處理，避免 locale 相關錯誤

### 📊 技術細節

- 修改 `initHistoryChart()` 函數，移除 `adapters.date.locale` 配置
- 依賴現有的 `formatTimeLabel()` callback 函數來格式化日期標籤
- 保持 time scale 功能以確保正確的時間間距

---

## v1.3.7 - 2025-12-08 06:30 HKT

### 🐛 Bug 修復

1. **日期解析錯誤導致圖表為空**
   - 修復日期解析邏輯：數據庫返回的日期已經是 ISO 格式（如 `2025-11-07T00:00:00.000Z`）
   - 移除錯誤的日期字符串拼接（`d.date + 'T00:00:00'`），直接使用 `new Date(d.date)`
   - 修復所有數據集（實際人數、平均線、±1σ 範圍）的日期解析問題

2. **X 軸時間線不更新問題**
   - 修復點擊上一頁/下一頁時 X 軸時間線不改變的問題
   - 改進圖表更新邏輯，確保時間軸配置在數據變化時正確更新
   - 添加強制重新計算和渲染邏輯，確保 X 軸正確顯示新的日期範圍

### 🔧 改進

- 改進日期解析邏輯，添加更詳細的錯誤日誌
- 改進圖表更新機制，確保時間軸配置同步更新
- 添加圖表 resize 觸發，確保時間軸正確響應數據變化

### 📊 技術細節

- 修改 `initHistoryChart()` 函數中的日期解析邏輯
- 修改圖表更新邏輯，確保時間軸配置（unit、displayFormats）在數據變化時更新
- 添加強制重新渲染邏輯，確保 X 軸時間線正確顯示

---

## v1.3.6 - 2025-12-08 06:20 HKT

### 🐛 Bug 修復

1. **歷史趨勢圖表為空問題（深度修復）**
   - 修復 Chart.js time scale 數據格式問題
   - 將日期字符串轉換為時間戳（`Date.getTime()`），Chart.js time scale 需要時間戳或 Date 對象
   - 添加日期有效性檢查，過濾無效數據點
   - 改進圖表更新邏輯，確保正確渲染
   - 添加調試日誌以追蹤數據點

### 🔧 改進

- 改進日期格式處理，統一使用時間戳格式
- 改進數據驗證邏輯，確保所有數據點有效
- 改進圖表更新機制，使用 'active' 模式確保正確渲染

### 📊 技術細節

- 修改 `initHistoryChart()` 函數中的數據點格式，從字符串改為時間戳
- 修改所有數據集（實際人數、平均線、±1σ 範圍）的日期格式
- 添加數據點驗證和過濾邏輯
- 改進圖表更新時機，添加延遲更新確保渲染

---

## v1.3.5 - 2025-12-08 06:13 HKT

### 🐛 Bug 修復

1. **圖表為空問題**
   - 修復歷史趨勢圖表為空的問題
   - 統一所有數據集的日期格式，確保使用 `YYYY-MM-DD` 字符串格式
   - 修復平均線數據集的日期格式不一致問題

2. **簡體中文和亂碼問題**
   - 修復前端顯示簡體中文的問題
   - 添加 `convertToTraditional()` 函數將簡體中文轉換為繁體中文
   - 添加 `convertObjectToTraditional()` 函數遞歸轉換對象中的字符串
   - 在 `updateRealtimeFactors()` 中應用轉換，確保所有顯示文本（description、reasoning、summary）都經過轉換
   - 添加清理亂碼字符的邏輯（如 `◆◆` 等特殊符號）

### 🔧 改進

- 改進前端簡體轉繁體轉換邏輯，涵蓋更多常見字符
- 改進圖表數據格式處理，確保日期格式一致性
- 改進文本顯示，自動清理和轉換簡體中文

### 📊 技術細節

- 修改 `initHistoryChart()` 函數，統一日期格式處理
- 新增 `convertToTraditional()` 和 `convertObjectToTraditional()` 函數
- 修改 `updateRealtimeFactors()` 函數，在顯示前轉換所有文本
- 改進字符映射表，包含更多常見簡體字符

---

## v1.3.4 - 2025-12-08 02:00 HKT

### 🐛 Bug 修復

1. **比較數據查詢問題**
   - 修復 `getComparisonData()` 無法找到比較數據的問題
   - 現在優先使用 `final_daily_predictions`（每日平均）
   - 如果沒有，使用 `daily_predictions` 表的最新預測（每30分鐘保存的數據）
   - 最後才使用 `predictions` 表作為後備
   - 修復 `calculateAccuracy()` 使用相同的邏輯

2. **預測數據記錄完整性**
   - 確保所有預測更新（每30分鐘、天氣變化、AI更新）都保存到 `daily_predictions`
   - 確保未來7天的預測也會保存到數據庫
   - 確保CSV導入真實數據時自動計算準確度

### 🔧 改進

- 改進比較數據查詢邏輯，現在可以找到所有有預測數據的日期
- 改進準確度計算邏輯，使用相同的數據源優先級
- 確保所有預測修改都會記錄到數據庫

### 🆕 新功能

1. **清除並重新導入數據功能**
   - 新增 `clear-and-reimport.js` 腳本
   - 新增 `POST /api/clear-and-reimport` API 端點
   - 支持清除所有數據並重新導入CSV數據
   - 新增 `clearAllData()` 函數到 database.js

### 📊 技術細節

- 修改 `getComparisonData()` 查詢，添加 `daily_predictions` 表支持
- 修改 `calculateAccuracy()` 函數，使用相同的數據源優先級
- 確保每30分鐘的AI預測修改都會保存
- 確保未來7天的預測也會保存
- 新增 `clearAllData()` 函數清除所有數據表
- 改進 CSV 解析邏輯，處理引號和無效行
- 添加批量導入進度顯示
- 添加日期範圍檢查和日誌

### 🎨 UI/UX 改進

1. **統一所有區塊響應式寬度**
   - 所有區塊（section, cards, charts）現在都使用 `width: 100%` 和 `max-width: 100%`
   - 確保所有元素都能適應所有設備尺寸（手機、平板、桌面）
   - 統一使用 `box-sizing: border-box` 確保正確計算寬度

2. **圖表響應式適配**
   - 所有圖表容器都設置為 `width: 100%` 和 `max-width: 100%`
   - Canvas 元素強制使用 `width: 100% !important`
   - 圖表高度根據設備尺寸自動調整（桌面 300px，平板 250px，手機 220px，小手機 200px）
   - 確保 Chart.js 的 `responsive: true` 和 `maintainAspectRatio: false` 正確設置

3. **改進移動端顯示**
   - 添加更多響應式斷點（1200px, 900px, 600px, 380px）
   - 所有區塊在不同設備上都能正確顯示
   - 表格支持橫向滾動（`-webkit-overflow-scrolling: touch`）

### 🔧 使用說明

**清除並重新導入數據：**

方法1：通過 API
```bash
curl -X POST "http://localhost:3001/api/clear-and-reimport"
```

方法2：使用 Node.js 腳本
```bash
node clear-and-reimport.js [csv-file-path]
```

---

## v1.3.3 - 2025-12-06 16:00 HKT

### 🐛 Bug 修復

1. **實際vs預測對比圖載入問題**
   - 修復圖表顯示 "載入中... 0%" 無法載入的問題
   - 改進錯誤處理，當沒有比較數據時顯示友好提示
   - 確保圖表正確初始化和顯示

### 🎨 UI/UX 改進

1. **統一所有區塊邊界樣式**
   - 統一 `chart-card` 與 `prediction-card` 的樣式
   - 添加 hover 效果和頂部漸變線條
   - 確保所有卡片在不同設備上都能自動適應
   - 改進響應式設計，統一移動端樣式

### 🆕 新功能

1. **CSV 數據導入功能**
   - 新增 `import-csv-data.js` 腳本，支持從 CSV 文件批量導入歷史數據
   - 支持導入10年歷史數據（2014-2025）
   - 自動處理重複數據（使用 ON CONFLICT 更新）
   - 新增 `POST /api/import-csv` API 端點，支持通過 API 導入數據

### 🔧 改進

- 統一所有卡片樣式，提供一致的視覺體驗
- 改進圖表載入錯誤處理
- 添加 CSV 導入腳本，方便批量導入歷史數據
- 改進數據庫導入邏輯，支持衝突處理

### 📊 技術細節

- 新增 `importCSVData()` 函數用於 CSV 數據導入
- 新增 `parseCSV()` 函數解析 CSV 文件
- 改進 `initComparisonChart()` 錯誤處理
- 統一 `.chart-card` 和 `.prediction-card` CSS 樣式
- 添加響應式設計支持

---

## v1.3.2 - 2025-12-06 14:30 HKT

### 🐛 Bug 修復

1. **歷史趨勢圖數據顯示問題**
   - 修復歷史趨勢圖使用硬編碼數據而非數據庫數據的問題
   - 現在從數據庫 API 動態獲取所有歷史數據（支持10年數據）
   - 修復只有1139筆數據顯示的問題，現在可以顯示所有數據庫中的歷史數據

2. **實際vs預測對比圖空白問題**
   - 新增實際vs預測對比圖表功能
   - 從數據庫獲取比較數據並正確渲染
   - 顯示實際人數、預測人數和80% CI區間
   - 修復3/12-6/12數據不顯示的問題

3. **詳細比較表格空白問題**
   - 新增詳細比較數據表格功能
   - 顯示日期、實際人數、預測人數、誤差、誤差率、CI區間和準確度
   - 從數據庫動態獲取並渲染數據

### 🆕 新功能

1. **歷史趨勢圖時間範圍選擇**
   - 添加時間範圍選擇按鈕：1D, 1週, 1月, 3月, 6月, 1年, 2年, 5年, 10年, 全部
   - 支持動態切換時間範圍查看不同時段的歷史數據
   - 根據數據量自動調整日期標籤顯示頻率

2. **數據庫查詢優化**
   - 改進 `getComparisonData()` 函數，優先使用 `final_daily_predictions` 表
   - 增加默認查詢限制從30到100條記錄
   - 添加95% CI支持

### 🔧 改進

- 歷史趨勢圖現在完全從數據庫獲取數據，不再依賴硬編碼
- 改進圖表初始化邏輯，支持異步數據載入
- 添加時間範圍選擇按鈕的CSS樣式
- 添加比較表格的CSS樣式
- 改進數據庫查詢，確保能獲取所有歷史數據

### 📊 技術細節

- 新增 `fetchHistoricalData()` 函數從數據庫獲取歷史數據
- 新增 `fetchComparisonData()` 函數從數據庫獲取比較數據
- 新增 `getDateRangeStart()` 函數計算時間範圍
- 新增 `initHistoryChart()` 函數初始化歷史趨勢圖
- 新增 `initComparisonChart()` 函數初始化對比圖
- 新增 `initComparisonTable()` 函數初始化比較表格
- 新增 `setupHistoryTimeRangeButtons()` 函數設置時間範圍選擇
- 修改 `initCharts()` 為異步函數以支持數據庫查詢
- 改進數據庫查詢邏輯，使用 `COALESCE` 優先選擇最終預測數據

---

## v1.1.7 - 2025-12-06 07:46 HKT

### 🆕 新功能

1. **每日預測記錄與平均化系統**
   - 新增 `daily_predictions` 表：記錄每次預測更新（包含時間戳、天氣數據、AI因素）
   - 新增 `final_daily_predictions` 表：保存每天的平均預測值（用於與真實數據比較）
   - 每次預測更新時自動保存到數據庫
   - 每天 00:00 HKT 自動計算前一天所有預測的平均值

2. **預測準確度追蹤改進**
   - `calculateAccuracy()` 現在優先使用最終平均預測數據進行比較
   - 支持查看每日預測的更新歷史
   - 更準確的 AI vs 真實數據比較

3. **新增 API 端點**
   - `POST /api/daily-predictions` - 保存每次預測更新
   - `POST /api/calculate-final-prediction` - 手動觸發計算某天的最終預測

### 🔧 改進

- 預測系統現在會持續記錄每次更新，而不是只保存最後一次
- 使用平均值作為最終預測，減少單次預測的波動影響
- 自動定時任務確保每天結束時計算平均值

### 📊 技術細節

- 新增 `insertDailyPrediction()` 函數保存每次預測
- 新增 `calculateFinalDailyPrediction()` 函數計算平均值
- 新增 `getFinalDailyPredictions()` 函數獲取最終預測數據
- 定時任務使用香港時間（HKT）確保準確性
- 數據庫索引優化查詢性能

---

## v1.1.6 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.5 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.4 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI 分析錯誤處理改進**
   - 改進 AI API 錯誤處理，提供更詳細的錯誤訊息
   - 添加錯誤響應解析，正確顯示 API 返回的錯誤詳情
   - 改進 HTTP 錯誤處理，顯示具體的錯誤代碼和訊息
   - 添加錯誤日誌記錄，便於診斷問題
   - 改進 JSON 解析錯誤處理，顯示原始響應內容

2. **錯誤顯示改進**
   - 添加專門的錯誤狀態 UI（`.factors-error`）
   - 改進錯誤訊息顯示，包含錯誤圖標、標題、詳細訊息和提示
   - 確保錯誤訊息能正確傳遞到前端並顯示
   - 添加錯誤樣式，使用紅色主題突出顯示錯誤狀態

### 🔧 改進

- 改進 `ai-service.js` 中的錯誤處理邏輯
- 改進 `server.js` 中的 API 錯誤處理
- 改進 `prediction.js` 中的錯誤處理和日誌記錄
- 添加詳細的錯誤堆疊日誌，便於調試
- 改進 API 響應錯誤解析，提取具體錯誤訊息

### 📊 技術細節

- 在 `callAI()` 函數中添加錯誤響應解析
- 在 `searchRelevantNewsAndEvents()` 中添加詳細錯誤日誌
- 在 `updateAIFactors()` 中添加錯誤響應解析
- 添加 `.factors-error` CSS 樣式類
- 改進錯誤訊息的用戶友好性

---

## v1.1.3 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI Summary 顯示問題**
   - 修復 AI 只返回 summary 時被誤判為失敗的問題
   - 改進數據有效性檢查邏輯，統一所有檢查點
   - 當 AI 返回有意義的 summary（即使沒有 factors）時，正確顯示而不是顯示錯誤
   - 改進緩存數據為空時的處理邏輯
   - 確保有意義的 summary 也能正確保存和顯示

2. **AI 分析載入進度顯示**
   - 修復「載入 AI 分析中...」無法顯示百分比進度的問題
   - 添加 `factors-loading` 的進度條和百分比顯示
   - 實現 `updateFactorsLoadingProgress()` 函數來更新 AI 分析載入進度
   - 在 `updateAIFactors()` 函數中添加進度更新邏輯（10% → 30% → 60% → 90% → 100%）
   - 更新 CSS 樣式，使 `factors-loading` 與其他載入元素樣式一致

### 🔧 改進

- 統一所有數據有效性檢查邏輯
- 改進日誌輸出，顯示實際返回的數據以便調試
- 改進用戶體驗，避免誤報錯誤

### 📊 技術細節

- 新增 `updateFactorsLoadingProgress()` 函數用於更新 AI 分析載入進度
- 在 AI 分析的各個階段（API 請求、數據處理、保存緩存）添加進度更新
- 改進 `factors-loading` 的 HTML 結構，包含 spinner、百分比文字和進度條
- 統一載入狀態的視覺樣式
- 改進數據有效性驗證，檢查 summary 是否為空字符串或只有空白字符

---

## v1.1.2 - 2025-12-06 (香港時間 HKT)

### 🎨 UI/UX 改進

1. **統一 Section 樣式**
   - 統一所有 section 的標題樣式（h2）：字體大小 1.5rem，字重 700，統一的間距和字母間距
   - 統一所有 section 的底部間距：`margin-bottom: var(--space-3xl)`
   - 為每個 section 添加統一的圖標前綴：
     - 📊 實時影響因素
     - 📅 未來 7 天預測
     - 📈 圖表區域
     - 🔬 算法說明
   - 響應式設計：在小螢幕上統一調整 section 標題大小和間距

### 📊 技術細節

- 新增統一的 `section` 和 `section h2` 基礎樣式
- 所有 section 現在使用一致的視覺語言
- 改進移動端顯示一致性

---

## v1.1.1 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **AI 整合**
   - 整合 AI 模型分析，自動搜索可能影響北區醫院病人數量的新聞和事件
   - 支持多種 AI 模型：
     - 高級模型（gpt-5.1, gpt-5, gpt-4o, gpt-4.1）：一天5次
     - 中級模型（deepseek-r1, deepseek-v3, deepseek-v3-2-exp）：一天30次
     - 基礎模型（gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano）：一天200次
   - 智能模型選擇，根據使用限制自動切換

2. **天氣觸發預測更新**
   - 當天氣數據更新時，自動觸發預測重新計算
   - 每分鐘檢查天氣變化，如有變化則更新預測
   - 天氣因素已整合到預測算法中

3. **AI 因素分析**
   - 自動分析可能影響病人數量的因素：
     - 天氣相關事件（極端天氣、颱風、暴雨等）
     - 公共衛生事件（流感爆發、食物中毒等）
     - 社會事件（大型活動、交通事故等）
     - 季節性因素（節日效應、學校假期等）
   - AI 分析結果自動整合到預測計算中

4. **新增 API 端點**
   - `GET /api/ai-analyze` - 獲取 AI 分析的因素
   - `POST /api/ai-analyze-range` - 分析特定日期範圍的因素
   - `GET /api/ai-usage` - 獲取 AI 使用統計

### 🔧 改進

1. **預測算法增強**
   - 預測公式更新：`預測值 = 全局平均 × 月份因子 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子`
   - 預測結果現在包含天氣影響和 AI 分析因素
   - UI 顯示所有影響因子，包括天氣和 AI 因素

2. **自動更新機制**
   - 每分鐘自動檢查天氣更新
   - 每30分鐘自動更新 AI 因素分析
   - 天氣或 AI 因素更新時自動刷新預測和圖表

3. **性能優化**
   - AI 因素緩存機制，減少重複分析
   - 智能使用計數器，按日期自動重置

### 📊 算法邏輯更新

- 天氣影響因子已整合到預測計算中
- AI 分析因素作為額外乘數因子應用
- 所有因子在 UI 中清晰顯示

### 🔐 技術細節

- 使用 Node.js 原生 https 模組進行 AI API 調用
- 支持服務器端和客戶端環境
- API 使用限制管理，防止超額使用
- 使用 API 轉發主機：
  - 主主機：`api.chatanywhere.tech` (國內中轉，延遲更低)
  - 備用主機：`api.chatanywhere.org` (國外使用)
  - 自動故障轉移：主主機失敗時自動切換到備用主機

---

## v1.0.0 - 2024-12-XX

### 初始版本

- 基於歷史數據的預測模型
- 星期效應、月份效應、假期效應分析
- 天氣數據獲取和顯示
- 圖表可視化
- 數據庫整合
