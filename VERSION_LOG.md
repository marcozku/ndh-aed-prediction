# 版本更新日誌

## v1.3.6 - 2025-12-08 06:20 HKT

### 🐛 Bug 修復

1. **歷史趨勢圖表為空問題（深度修復）**
   - 修復 Chart.js time scale 數據格式問題
   - 將日期字符串轉換為時間戳（`Date.getTime()`），Chart.js time scale 需要時間戳或 Date 對象
   - 添加日期有效性檢查，過濾無效數據點
   - 改進圖表更新邏輯，確保正確渲染
   - 添加調試日誌以追蹤數據點

### 🔧 改進

- 改進日期格式處理，統一使用時間戳格式
- 改進數據驗證邏輯，確保所有數據點有效
- 改進圖表更新機制，使用 'active' 模式確保正確渲染

### 📊 技術細節

- 修改 `initHistoryChart()` 函數中的數據點格式，從字符串改為時間戳
- 修改所有數據集（實際人數、平均線、±1σ 範圍）的日期格式
- 添加數據點驗證和過濾邏輯
- 改進圖表更新時機，添加延遲更新確保渲染

---

## v1.3.5 - 2025-12-08 06:13 HKT

### 🐛 Bug 修復

1. **圖表為空問題**
   - 修復歷史趨勢圖表為空的問題
   - 統一所有數據集的日期格式，確保使用 `YYYY-MM-DD` 字符串格式
   - 修復平均線數據集的日期格式不一致問題

2. **簡體中文和亂碼問題**
   - 修復前端顯示簡體中文的問題
   - 添加 `convertToTraditional()` 函數將簡體中文轉換為繁體中文
   - 添加 `convertObjectToTraditional()` 函數遞歸轉換對象中的字符串
   - 在 `updateRealtimeFactors()` 中應用轉換，確保所有顯示文本（description、reasoning、summary）都經過轉換
   - 添加清理亂碼字符的邏輯（如 `◆◆` 等特殊符號）

### 🔧 改進

- 改進前端簡體轉繁體轉換邏輯，涵蓋更多常見字符
- 改進圖表數據格式處理，確保日期格式一致性
- 改進文本顯示，自動清理和轉換簡體中文

### 📊 技術細節

- 修改 `initHistoryChart()` 函數，統一日期格式處理
- 新增 `convertToTraditional()` 和 `convertObjectToTraditional()` 函數
- 修改 `updateRealtimeFactors()` 函數，在顯示前轉換所有文本
- 改進字符映射表，包含更多常見簡體字符

---

## v1.3.4 - 2025-12-08 02:00 HKT

### 🐛 Bug 修復

1. **比較數據查詢問題**
   - 修復 `getComparisonData()` 無法找到比較數據的問題
   - 現在優先使用 `final_daily_predictions`（每日平均）
   - 如果沒有，使用 `daily_predictions` 表的最新預測（每30分鐘保存的數據）
   - 最後才使用 `predictions` 表作為後備
   - 修復 `calculateAccuracy()` 使用相同的邏輯

2. **預測數據記錄完整性**
   - 確保所有預測更新（每30分鐘、天氣變化、AI更新）都保存到 `daily_predictions`
   - 確保未來7天的預測也會保存到數據庫
   - 確保CSV導入真實數據時自動計算準確度

### 🔧 改進

- 改進比較數據查詢邏輯，現在可以找到所有有預測數據的日期
- 改進準確度計算邏輯，使用相同的數據源優先級
- 確保所有預測修改都會記錄到數據庫

### 🆕 新功能

1. **清除並重新導入數據功能**
   - 新增 `clear-and-reimport.js` 腳本
   - 新增 `POST /api/clear-and-reimport` API 端點
   - 支持清除所有數據並重新導入CSV數據
   - 新增 `clearAllData()` 函數到 database.js

### 📊 技術細節

- 修改 `getComparisonData()` 查詢，添加 `daily_predictions` 表支持
- 修改 `calculateAccuracy()` 函數，使用相同的數據源優先級
- 確保每30分鐘的AI預測修改都會保存
- 確保未來7天的預測也會保存
- 新增 `clearAllData()` 函數清除所有數據表
- 改進 CSV 解析邏輯，處理引號和無效行
- 添加批量導入進度顯示
- 添加日期範圍檢查和日誌

### 🎨 UI/UX 改進

1. **統一所有區塊響應式寬度**
   - 所有區塊（section, cards, charts）現在都使用 `width: 100%` 和 `max-width: 100%`
   - 確保所有元素都能適應所有設備尺寸（手機、平板、桌面）
   - 統一使用 `box-sizing: border-box` 確保正確計算寬度

2. **圖表響應式適配**
   - 所有圖表容器都設置為 `width: 100%` 和 `max-width: 100%`
   - Canvas 元素強制使用 `width: 100% !important`
   - 圖表高度根據設備尺寸自動調整（桌面 300px，平板 250px，手機 220px，小手機 200px）
   - 確保 Chart.js 的 `responsive: true` 和 `maintainAspectRatio: false` 正確設置

3. **改進移動端顯示**
   - 添加更多響應式斷點（1200px, 900px, 600px, 380px）
   - 所有區塊在不同設備上都能正確顯示
   - 表格支持橫向滾動（`-webkit-overflow-scrolling: touch`）

### 🔧 使用說明

**清除並重新導入數據：**

方法1：通過 API
```bash
curl -X POST "http://localhost:3001/api/clear-and-reimport"
```

方法2：使用 Node.js 腳本
```bash
node clear-and-reimport.js [csv-file-path]
```

---

## v1.3.3 - 2025-12-06 16:00 HKT

### 🐛 Bug 修復

1. **實際vs預測對比圖載入問題**
   - 修復圖表顯示 "載入中... 0%" 無法載入的問題
   - 改進錯誤處理，當沒有比較數據時顯示友好提示
   - 確保圖表正確初始化和顯示

### 🎨 UI/UX 改進

1. **統一所有區塊邊界樣式**
   - 統一 `chart-card` 與 `prediction-card` 的樣式
   - 添加 hover 效果和頂部漸變線條
   - 確保所有卡片在不同設備上都能自動適應
   - 改進響應式設計，統一移動端樣式

### 🆕 新功能

1. **CSV 數據導入功能**
   - 新增 `import-csv-data.js` 腳本，支持從 CSV 文件批量導入歷史數據
   - 支持導入10年歷史數據（2014-2025）
   - 自動處理重複數據（使用 ON CONFLICT 更新）
   - 新增 `POST /api/import-csv` API 端點，支持通過 API 導入數據

### 🔧 改進

- 統一所有卡片樣式，提供一致的視覺體驗
- 改進圖表載入錯誤處理
- 添加 CSV 導入腳本，方便批量導入歷史數據
- 改進數據庫導入邏輯，支持衝突處理

### 📊 技術細節

- 新增 `importCSVData()` 函數用於 CSV 數據導入
- 新增 `parseCSV()` 函數解析 CSV 文件
- 改進 `initComparisonChart()` 錯誤處理
- 統一 `.chart-card` 和 `.prediction-card` CSS 樣式
- 添加響應式設計支持

---

## v1.3.2 - 2025-12-06 14:30 HKT

### 🐛 Bug 修復

1. **歷史趨勢圖數據顯示問題**
   - 修復歷史趨勢圖使用硬編碼數據而非數據庫數據的問題
   - 現在從數據庫 API 動態獲取所有歷史數據（支持10年數據）
   - 修復只有1139筆數據顯示的問題，現在可以顯示所有數據庫中的歷史數據

2. **實際vs預測對比圖空白問題**
   - 新增實際vs預測對比圖表功能
   - 從數據庫獲取比較數據並正確渲染
   - 顯示實際人數、預測人數和80% CI區間
   - 修復3/12-6/12數據不顯示的問題

3. **詳細比較表格空白問題**
   - 新增詳細比較數據表格功能
   - 顯示日期、實際人數、預測人數、誤差、誤差率、CI區間和準確度
   - 從數據庫動態獲取並渲染數據

### 🆕 新功能

1. **歷史趨勢圖時間範圍選擇**
   - 添加時間範圍選擇按鈕：1D, 1週, 1月, 3月, 6月, 1年, 2年, 5年, 10年, 全部
   - 支持動態切換時間範圍查看不同時段的歷史數據
   - 根據數據量自動調整日期標籤顯示頻率

2. **數據庫查詢優化**
   - 改進 `getComparisonData()` 函數，優先使用 `final_daily_predictions` 表
   - 增加默認查詢限制從30到100條記錄
   - 添加95% CI支持

### 🔧 改進

- 歷史趨勢圖現在完全從數據庫獲取數據，不再依賴硬編碼
- 改進圖表初始化邏輯，支持異步數據載入
- 添加時間範圍選擇按鈕的CSS樣式
- 添加比較表格的CSS樣式
- 改進數據庫查詢，確保能獲取所有歷史數據

### 📊 技術細節

- 新增 `fetchHistoricalData()` 函數從數據庫獲取歷史數據
- 新增 `fetchComparisonData()` 函數從數據庫獲取比較數據
- 新增 `getDateRangeStart()` 函數計算時間範圍
- 新增 `initHistoryChart()` 函數初始化歷史趨勢圖
- 新增 `initComparisonChart()` 函數初始化對比圖
- 新增 `initComparisonTable()` 函數初始化比較表格
- 新增 `setupHistoryTimeRangeButtons()` 函數設置時間範圍選擇
- 修改 `initCharts()` 為異步函數以支持數據庫查詢
- 改進數據庫查詢邏輯，使用 `COALESCE` 優先選擇最終預測數據

---

## v1.1.7 - 2025-12-06 07:46 HKT

### 🆕 新功能

1. **每日預測記錄與平均化系統**
   - 新增 `daily_predictions` 表：記錄每次預測更新（包含時間戳、天氣數據、AI因素）
   - 新增 `final_daily_predictions` 表：保存每天的平均預測值（用於與真實數據比較）
   - 每次預測更新時自動保存到數據庫
   - 每天 00:00 HKT 自動計算前一天所有預測的平均值

2. **預測準確度追蹤改進**
   - `calculateAccuracy()` 現在優先使用最終平均預測數據進行比較
   - 支持查看每日預測的更新歷史
   - 更準確的 AI vs 真實數據比較

3. **新增 API 端點**
   - `POST /api/daily-predictions` - 保存每次預測更新
   - `POST /api/calculate-final-prediction` - 手動觸發計算某天的最終預測

### 🔧 改進

- 預測系統現在會持續記錄每次更新，而不是只保存最後一次
- 使用平均值作為最終預測，減少單次預測的波動影響
- 自動定時任務確保每天結束時計算平均值

### 📊 技術細節

- 新增 `insertDailyPrediction()` 函數保存每次預測
- 新增 `calculateFinalDailyPrediction()` 函數計算平均值
- 新增 `getFinalDailyPredictions()` 函數獲取最終預測數據
- 定時任務使用香港時間（HKT）確保準確性
- 數據庫索引優化查詢性能

---

## v1.1.6 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.5 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.4 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI 分析錯誤處理改進**
   - 改進 AI API 錯誤處理，提供更詳細的錯誤訊息
   - 添加錯誤響應解析，正確顯示 API 返回的錯誤詳情
   - 改進 HTTP 錯誤處理，顯示具體的錯誤代碼和訊息
   - 添加錯誤日誌記錄，便於診斷問題
   - 改進 JSON 解析錯誤處理，顯示原始響應內容

2. **錯誤顯示改進**
   - 添加專門的錯誤狀態 UI（`.factors-error`）
   - 改進錯誤訊息顯示，包含錯誤圖標、標題、詳細訊息和提示
   - 確保錯誤訊息能正確傳遞到前端並顯示
   - 添加錯誤樣式，使用紅色主題突出顯示錯誤狀態

### 🔧 改進

- 改進 `ai-service.js` 中的錯誤處理邏輯
- 改進 `server.js` 中的 API 錯誤處理
- 改進 `prediction.js` 中的錯誤處理和日誌記錄
- 添加詳細的錯誤堆疊日誌，便於調試
- 改進 API 響應錯誤解析，提取具體錯誤訊息

### 📊 技術細節

- 在 `callAI()` 函數中添加錯誤響應解析
- 在 `searchRelevantNewsAndEvents()` 中添加詳細錯誤日誌
- 在 `updateAIFactors()` 中添加錯誤響應解析
- 添加 `.factors-error` CSS 樣式類
- 改進錯誤訊息的用戶友好性

---

## v1.1.3 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI Summary 顯示問題**
   - 修復 AI 只返回 summary 時被誤判為失敗的問題
   - 改進數據有效性檢查邏輯，統一所有檢查點
   - 當 AI 返回有意義的 summary（即使沒有 factors）時，正確顯示而不是顯示錯誤
   - 改進緩存數據為空時的處理邏輯
   - 確保有意義的 summary 也能正確保存和顯示

2. **AI 分析載入進度顯示**
   - 修復「載入 AI 分析中...」無法顯示百分比進度的問題
   - 添加 `factors-loading` 的進度條和百分比顯示
   - 實現 `updateFactorsLoadingProgress()` 函數來更新 AI 分析載入進度
   - 在 `updateAIFactors()` 函數中添加進度更新邏輯（10% → 30% → 60% → 90% → 100%）
   - 更新 CSS 樣式，使 `factors-loading` 與其他載入元素樣式一致

### 🔧 改進

- 統一所有數據有效性檢查邏輯
- 改進日誌輸出，顯示實際返回的數據以便調試
- 改進用戶體驗，避免誤報錯誤

### 📊 技術細節

- 新增 `updateFactorsLoadingProgress()` 函數用於更新 AI 分析載入進度
- 在 AI 分析的各個階段（API 請求、數據處理、保存緩存）添加進度更新
- 改進 `factors-loading` 的 HTML 結構，包含 spinner、百分比文字和進度條
- 統一載入狀態的視覺樣式
- 改進數據有效性驗證，檢查 summary 是否為空字符串或只有空白字符

---

## v1.1.2 - 2025-12-06 (香港時間 HKT)

### 🎨 UI/UX 改進

1. **統一 Section 樣式**
   - 統一所有 section 的標題樣式（h2）：字體大小 1.5rem，字重 700，統一的間距和字母間距
   - 統一所有 section 的底部間距：`margin-bottom: var(--space-3xl)`
   - 為每個 section 添加統一的圖標前綴：
     - 📊 實時影響因素
     - 📅 未來 7 天預測
     - 📈 圖表區域
     - 🔬 算法說明
   - 響應式設計：在小螢幕上統一調整 section 標題大小和間距

### 📊 技術細節

- 新增統一的 `section` 和 `section h2` 基礎樣式
- 所有 section 現在使用一致的視覺語言
- 改進移動端顯示一致性

---

## v1.1.1 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **AI 整合**
   - 整合 AI 模型分析，自動搜索可能影響北區醫院病人數量的新聞和事件
   - 支持多種 AI 模型：
     - 高級模型（gpt-5.1, gpt-5, gpt-4o, gpt-4.1）：一天5次
     - 中級模型（deepseek-r1, deepseek-v3, deepseek-v3-2-exp）：一天30次
     - 基礎模型（gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano）：一天200次
   - 智能模型選擇，根據使用限制自動切換

2. **天氣觸發預測更新**
   - 當天氣數據更新時，自動觸發預測重新計算
   - 每分鐘檢查天氣變化，如有變化則更新預測
   - 天氣因素已整合到預測算法中

3. **AI 因素分析**
   - 自動分析可能影響病人數量的因素：
     - 天氣相關事件（極端天氣、颱風、暴雨等）
     - 公共衛生事件（流感爆發、食物中毒等）
     - 社會事件（大型活動、交通事故等）
     - 季節性因素（節日效應、學校假期等）
   - AI 分析結果自動整合到預測計算中

4. **新增 API 端點**
   - `GET /api/ai-analyze` - 獲取 AI 分析的因素
   - `POST /api/ai-analyze-range` - 分析特定日期範圍的因素
   - `GET /api/ai-usage` - 獲取 AI 使用統計

### 🔧 改進

1. **預測算法增強**
   - 預測公式更新：`預測值 = 全局平均 × 月份因子 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子`
   - 預測結果現在包含天氣影響和 AI 分析因素
   - UI 顯示所有影響因子，包括天氣和 AI 因素

2. **自動更新機制**
   - 每分鐘自動檢查天氣更新
   - 每30分鐘自動更新 AI 因素分析
   - 天氣或 AI 因素更新時自動刷新預測和圖表

3. **性能優化**
   - AI 因素緩存機制，減少重複分析
   - 智能使用計數器，按日期自動重置

### 📊 算法邏輯更新

- 天氣影響因子已整合到預測計算中
- AI 分析因素作為額外乘數因子應用
- 所有因子在 UI 中清晰顯示

### 🔐 技術細節

- 使用 Node.js 原生 https 模組進行 AI API 調用
- 支持服務器端和客戶端環境
- API 使用限制管理，防止超額使用
- 使用 API 轉發主機：
  - 主主機：`api.chatanywhere.tech` (國內中轉，延遲更低)
  - 備用主機：`api.chatanywhere.org` (國外使用)
  - 自動故障轉移：主主機失敗時自動切換到備用主機

---

## v1.0.0 - 2024-12-XX

### 初始版本

- 基於歷史數據的預測模型
- 星期效應、月份效應、假期效應分析
- 天氣數據獲取和顯示
- 圖表可視化
- 數據庫整合
