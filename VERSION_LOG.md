# 版本更新日誌

## v1.2.0 - 2025-12-07 (香港時間 HKT)

### 🔧 改進

1. **更新數據來源信息**
   - 更新 footer 顯示正確的數據範圍：2015-12-03 至 2024-12-03
   - 更新數據筆數：774筆，十年數據
   - 更新預測模型版本和應用版本為 1.2.0

### 📊 技術細節

- 更新 `index.html` 中的 footer 信息
- 更新 `package.json` 版本號為 1.2.0
- 更新 `server.js` 中的 MODEL_VERSION 為 1.2.0

---

## v1.1.12 - 2025-12-07 (香港時間 HKT)

### 🆕 新功能

1. **自動導入歷史數據**
   - 服務器啟動時自動檢查數據庫中是否有歷史數據
   - 如果數據庫為空，自動執行歷史數據導入腳本
   - 如果已有數據，跳過導入以避免重複
   - 導入過程在後台執行，不阻塞服務器啟動

### 🔧 改進

- 改進導入腳本，支持作為模組調用（不退出進程）
- 添加 `skipInit` 參數，允許跳過數據庫初始化（當已初始化時）
- 改進錯誤處理，導入失敗不會阻止服務器啟動

### 📊 技術細節

- 在 `server.js` 中添加 `autoImportHistoricalData()` 函數
- 修改 `import-historical-data.js` 支持作為模組調用
- 自動導入在數據庫初始化完成後執行
- 使用 `getActualData()` 檢查是否已有數據

---

## v1.1.11 - 2025-12-07 (香港時間 HKT)

### 🆕 新功能

1. **數據比較與準確度分析系統**
   - 新增數據比較區塊，詳細分析實際數據與預測數據的差異
   - 顯示統計摘要：比較數據點數、平均絕對誤差率、80% CI 準確度、95% CI 準確度
   - 實際 vs 預測對比圖表，可視化預測準確度
   - 詳細比較表格，顯示每日的實際值、預測值、誤差、誤差率、CI範圍和準確度等級
   - 準確度等級標記：優秀（≤5%）、良好（≤10%）、一般（≤15%）、差（>15%）

2. **歷史趨勢圖表改進**
   - 歷史趨勢圖表現支持橫向滾動，可查看所有365天數據
   - 自動調整canvas寬度以適應所有歷史數據點
   - 添加滾動提示，引導用戶左右滾動查看更多數據

3. **數據更新**
   - 添加2025年12月1日至6日的新數據（276, 285, 253, 234, 262, 234）

### 🔧 改進

- 改進數據比較API，支持獲取最多365天的比較數據
- 優化圖表顯示性能，支持大量數據點的可視化
- 改進表格響應式設計，在移動設備上也能良好顯示

### 📊 技術細節

- 新增 `loadComparisonData()` 函數載入比較數據
- 新增 `displayComparisonData()` 函數顯示比較結果
- 新增 `calculateComparisonStats()` 函數計算統計信息
- 新增 `displayComparisonChart()` 函數顯示對比圖表
- 新增 `displayComparisonTable()` 函數顯示詳細表格
- 改進歷史趨勢圖表canvas寬度計算邏輯
- 添加可滾動圖表容器的CSS樣式

---

## v1.1.10 - 2025-12-07 (香港時間 HKT)

### 🆕 新功能

1. **歷史數據批量導入系統**
   - 新增 `import-historical-data.js` 腳本，用於批量導入歷史病人數據
   - 支持解析自定義格式的歷史數據（DD/MM/YYYY 緊接著數字）
   - 自動將日期格式轉換為標準格式（YYYY-MM-DD）
   - 批量導入從 2014-12-01 至 2025-12-01 的歷史數據

### 🔧 改進

- 改進數據導入流程，支持大規模歷史數據批量處理
- 自動統計導入數據的日期範圍和病人數量統計
- 使用事務處理確保數據一致性
- 支持數據更新（ON CONFLICT 處理）

### 📊 技術細節

- 新增 `parseRawData()` 函數解析自定義格式的歷史數據
- 使用 `insertBulkActualData()` 函數進行批量數據插入
- 所有時間操作使用香港時間（HKT）
- 數據來源標記為 `historical_bulk_import`

---

## v1.1.9 - 2025-12-07 03:39 HKT

### 🔧 改進

1. **AI 分析因素繁體中文支持**
   - 確保 AI 返回的所有分析因素使用繁體中文
   - 在 system message 和 prompt 中明確要求使用繁體中文
   - 添加簡體到繁體的類型映射，確保顯示正確
   - 因素類型、描述、分析理由、總結等全部使用繁體中文

### 📊 技術細節

- 更新 `ai-service.js` 中的 prompt，明確要求返回繁體中文
- 在 `prediction.js` 中添加簡體到繁體的類型轉換映射
- 確保信心度顯示也使用繁體中文

---

## v1.1.7 - 2025-12-06 07:46 HKT

### 🆕 新功能

1. **每日預測記錄與平均化系統**
   - 新增 `daily_predictions` 表：記錄每次預測更新（包含時間戳、天氣數據、AI因素）
   - 新增 `final_daily_predictions` 表：保存每天的平均預測值（用於與真實數據比較）
   - 每次預測更新時自動保存到數據庫
   - 每天 00:00 HKT 自動計算前一天所有預測的平均值

2. **預測準確度追蹤改進**
   - `calculateAccuracy()` 現在優先使用最終平均預測數據進行比較
   - 支持查看每日預測的更新歷史
   - 更準確的 AI vs 真實數據比較

3. **新增 API 端點**
   - `POST /api/daily-predictions` - 保存每次預測更新
   - `POST /api/calculate-final-prediction` - 手動觸發計算某天的最終預測

### 🔧 改進

- 預測系統現在會持續記錄每次更新，而不是只保存最後一次
- 使用平均值作為最終預測，減少單次預測的波動影響
- 自動定時任務確保每天結束時計算平均值

### 📊 技術細節

- 新增 `insertDailyPrediction()` 函數保存每次預測
- 新增 `calculateFinalDailyPrediction()` 函數計算平均值
- 新增 `getFinalDailyPredictions()` 函數獲取最終預測數據
- 定時任務使用香港時間（HKT）確保準確性
- 數據庫索引優化查詢性能

---

## v1.1.6 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.5 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **自動模型切換機制**
   - 當 AI API 調用失敗時，自動從高級模型到低級模型依次嘗試
   - 優先級順序：
     - 高級模型（premium）：gpt-5.1, gpt-5, gpt-4o, gpt-4.1（一天5次）
     - 中級模型（standard）：deepseek-r1, deepseek-v3, deepseek-v3-2-exp（一天30次）
     - 基礎模型（basic）：gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano（一天200次）
   - 自動檢測使用限制錯誤，切換到下一個可用模型
   - 智能跳過已達到使用限制的模型

### 🔧 改進

- 改進 `callAI()` 函數，實現自動模型切換邏輯
- 新增 `callSingleModel()` 函數，用於調用單個模型
- 新增 `getAllAvailableModels()` 函數，獲取所有可用模型列表
- 新增 `isRateLimitError()` 函數，檢測是否為使用限制錯誤
- 改進錯誤處理，確保所有錯誤都會嘗試下一個模型
- 添加詳細的日誌記錄，顯示嘗試的模型和結果

### 📊 技術細節

- 當模型失敗時，自動嘗試下一個可用模型
- 支持檢測使用限制錯誤（包含 "limit"、"每日"、"per day"、"00:00"、"免費"、"free" 等關鍵詞）
- 按優先級順序嘗試模型，確保使用最高質量的可用模型
- 記錄所有嘗試過的模型，避免重複嘗試

---

## v1.1.4 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI 分析錯誤處理改進**
   - 改進 AI API 錯誤處理，提供更詳細的錯誤訊息
   - 添加錯誤響應解析，正確顯示 API 返回的錯誤詳情
   - 改進 HTTP 錯誤處理，顯示具體的錯誤代碼和訊息
   - 添加錯誤日誌記錄，便於診斷問題
   - 改進 JSON 解析錯誤處理，顯示原始響應內容

2. **錯誤顯示改進**
   - 添加專門的錯誤狀態 UI（`.factors-error`）
   - 改進錯誤訊息顯示，包含錯誤圖標、標題、詳細訊息和提示
   - 確保錯誤訊息能正確傳遞到前端並顯示
   - 添加錯誤樣式，使用紅色主題突出顯示錯誤狀態

### 🔧 改進

- 改進 `ai-service.js` 中的錯誤處理邏輯
- 改進 `server.js` 中的 API 錯誤處理
- 改進 `prediction.js` 中的錯誤處理和日誌記錄
- 添加詳細的錯誤堆疊日誌，便於調試
- 改進 API 響應錯誤解析，提取具體錯誤訊息

### 📊 技術細節

- 在 `callAI()` 函數中添加錯誤響應解析
- 在 `searchRelevantNewsAndEvents()` 中添加詳細錯誤日誌
- 在 `updateAIFactors()` 中添加錯誤響應解析
- 添加 `.factors-error` CSS 樣式類
- 改進錯誤訊息的用戶友好性

---

## v1.1.3 - 2025-12-06 (香港時間 HKT)

### 🐛 Bug 修復

1. **AI Summary 顯示問題**
   - 修復 AI 只返回 summary 時被誤判為失敗的問題
   - 改進數據有效性檢查邏輯，統一所有檢查點
   - 當 AI 返回有意義的 summary（即使沒有 factors）時，正確顯示而不是顯示錯誤
   - 改進緩存數據為空時的處理邏輯
   - 確保有意義的 summary 也能正確保存和顯示

2. **AI 分析載入進度顯示**
   - 修復「載入 AI 分析中...」無法顯示百分比進度的問題
   - 添加 `factors-loading` 的進度條和百分比顯示
   - 實現 `updateFactorsLoadingProgress()` 函數來更新 AI 分析載入進度
   - 在 `updateAIFactors()` 函數中添加進度更新邏輯（10% → 30% → 60% → 90% → 100%）
   - 更新 CSS 樣式，使 `factors-loading` 與其他載入元素樣式一致

### 🔧 改進

- 統一所有數據有效性檢查邏輯
- 改進日誌輸出，顯示實際返回的數據以便調試
- 改進用戶體驗，避免誤報錯誤

### 📊 技術細節

- 新增 `updateFactorsLoadingProgress()` 函數用於更新 AI 分析載入進度
- 在 AI 分析的各個階段（API 請求、數據處理、保存緩存）添加進度更新
- 改進 `factors-loading` 的 HTML 結構，包含 spinner、百分比文字和進度條
- 統一載入狀態的視覺樣式
- 改進數據有效性驗證，檢查 summary 是否為空字符串或只有空白字符

---

## v1.1.2 - 2025-12-06 (香港時間 HKT)

### 🎨 UI/UX 改進

1. **統一 Section 樣式**
   - 統一所有 section 的標題樣式（h2）：字體大小 1.5rem，字重 700，統一的間距和字母間距
   - 統一所有 section 的底部間距：`margin-bottom: var(--space-3xl)`
   - 為每個 section 添加統一的圖標前綴：
     - 📊 實時影響因素
     - 📅 未來 7 天預測
     - 📈 圖表區域
     - 🔬 算法說明
   - 響應式設計：在小螢幕上統一調整 section 標題大小和間距

### 📊 技術細節

- 新增統一的 `section` 和 `section h2` 基礎樣式
- 所有 section 現在使用一致的視覺語言
- 改進移動端顯示一致性

---

## v1.1.1 - 2025-12-06 (香港時間 HKT)

### 🆕 新功能

1. **AI 整合**
   - 整合 AI 模型分析，自動搜索可能影響北區醫院病人數量的新聞和事件
   - 支持多種 AI 模型：
     - 高級模型（gpt-5.1, gpt-5, gpt-4o, gpt-4.1）：一天5次
     - 中級模型（deepseek-r1, deepseek-v3, deepseek-v3-2-exp）：一天30次
     - 基礎模型（gpt-4o-mini, gpt-3.5-turbo, gpt-4.1-mini, gpt-4.1-nano, gpt-5-mini, gpt-5-nano）：一天200次
   - 智能模型選擇，根據使用限制自動切換

2. **天氣觸發預測更新**
   - 當天氣數據更新時，自動觸發預測重新計算
   - 每分鐘檢查天氣變化，如有變化則更新預測
   - 天氣因素已整合到預測算法中

3. **AI 因素分析**
   - 自動分析可能影響病人數量的因素：
     - 天氣相關事件（極端天氣、颱風、暴雨等）
     - 公共衛生事件（流感爆發、食物中毒等）
     - 社會事件（大型活動、交通事故等）
     - 季節性因素（節日效應、學校假期等）
   - AI 分析結果自動整合到預測計算中

4. **新增 API 端點**
   - `GET /api/ai-analyze` - 獲取 AI 分析的因素
   - `POST /api/ai-analyze-range` - 分析特定日期範圍的因素
   - `GET /api/ai-usage` - 獲取 AI 使用統計

### 🔧 改進

1. **預測算法增強**
   - 預測公式更新：`預測值 = 全局平均 × 月份因子 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子`
   - 預測結果現在包含天氣影響和 AI 分析因素
   - UI 顯示所有影響因子，包括天氣和 AI 因素

2. **自動更新機制**
   - 每分鐘自動檢查天氣更新
   - 每30分鐘自動更新 AI 因素分析
   - 天氣或 AI 因素更新時自動刷新預測和圖表

3. **性能優化**
   - AI 因素緩存機制，減少重複分析
   - 智能使用計數器，按日期自動重置

### 📊 算法邏輯更新

- 天氣影響因子已整合到預測計算中
- AI 分析因素作為額外乘數因子應用
- 所有因子在 UI 中清晰顯示

### 🔐 技術細節

- 使用 Node.js 原生 https 模組進行 AI API 調用
- 支持服務器端和客戶端環境
- API 使用限制管理，防止超額使用
- 使用 API 轉發主機：
  - 主主機：`api.chatanywhere.tech` (國內中轉，延遲更低)
  - 備用主機：`api.chatanywhere.org` (國外使用)
  - 自動故障轉移：主主機失敗時自動切換到備用主機

---

## v1.0.0 - 2024-12-XX

### 初始版本

- 基於歷史數據的預測模型
- 星期效應、月份效應、假期效應分析
- 天氣數據獲取和顯示
- 圖表可視化
- 數據庫整合
<<<<<<< Updated upstream
=======


>>>>>>> Stashed changes
