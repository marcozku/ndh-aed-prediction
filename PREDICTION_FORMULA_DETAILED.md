# 詳細預測公式說明

## 📐 完整預測公式（v2.9.52）

### 總公式（特徵選擇優化版）

```
最終預測值 = XGBoost(25 精選特徵) × 實時天氣因子 × AI 因素調整
```

### 模型性能（v2.9.52）

| 指標 | 數值 | vs v2.9.50 (161特徵) |
|------|------|----------------------|
| **R²** | 92.0% | **+1.7%** ✅ |
| **調整 R²** | 91.7% | **+4.3%** ✅ |
| MAE | 5.33 病人 | **-15%** ✅ |
| MAPE | 2.10% | **-14%** ✅ |
| 特徵數 | 25 | **-85%** ✅ |

### XGBoost 模型架構

基於 **BMC Emergency Medicine (2025)** + **Optuna 優化**：

```
XGBoost 預測 = f(
    時間特徵,                    # 8 個
    循環編碼,                    # 4 個
    Fourier 季節特徵,            # 10 個 (研究基礎: Prophet)
    滯後特徵 (擴展版),            # 30 個 (Lag1-Lag7, Lag14-365)
    同星期歷史滯後,               # 5 個 (1w-4w + 平均)
    EWMA 指數加權移動平均,        # 3 個 (佔 85% 重要性！)
    滾動統計 (擴展版),            # 49 個 (3-90天窗口)
    相對位置 + 變異係數,          # 6 個
    目標編碼特徵,                 # 3 個 (DayOfWeek, Month, YearMonth)
    事件指標,                    # 8 個
    交互特徵,                    # 3 個
    趨勢特徵,                    # 5 個
    假期特徵,                    # 9 個
    AI 因子特徵,                 # 13 個
    天氣特徵                     # 10 個 (HKO 歷史數據)
)
```

### 最重要特徵（v2.9.52）

| 排名 | 特徵 | 重要性 |
|------|------|--------|
| 1 | Attendance_EWMA7 | 45.2% |
| 2 | Attendance_EWMA14 | 44.6% |
| 3 | Daily_Change | 2.2% |
| 4 | Monthly_Change | 2.0% |
| 5 | Attendance_EWMA30 | 1.3% |

**關鍵發現**：EWMA7 + EWMA14 兩個特徵佔 90% 重要性！

### 樣本權重（研究基礎: JMIR 2025）

```python
# 時間衰減權重
time_weight = exp(-0.693 × days_from_latest / 365)

# COVID 期間調整
if date in [2020-02, 2022-06]:
    weight *= 0.3

# 異常值調整
if z_score > 3:
    weight *= 0.5
```

---

## 🔢 傳統預測公式（備用）

---

## 🔢 步驟 1：計算基礎預測值（乘法模型）

### 1.1 基準值計算

```
基準值 = 全局平均 × 月份因子
```

**詳細說明**：
- **全局平均**：使用加權平均計算，最近 180 天的數據，指數衰減權重
  - 權重公式：`w_i = e^(-0.02 × days_ago)`
  - 加權平均：`globalMean = Σ(attendance_i × w_i) / Σ(w_i)`
- **月份因子**：`monthFactors[month]`，範圍約 0.85 - 1.25
  - 基於最近 180 天同月份的加權平均計算

### 1.2 星期效應

```
星期因子 = 月份-星期交互因子（優先）或 星期因子（後備）
```

**詳細說明**：
- **優先使用**：`monthDowFactors[month][dow]`（月份-星期交互因子）
  - 基於研究：不同月份的星期模式不同
  - 例如：12 月的星期一與 1 月的星期一模式不同
- **後備使用**：`dowFactors[dow]`（全局星期因子）
  - 範圍約 0.70 - 1.30

### 1.3 基礎預測值計算

```
基礎預測值 = 基準值 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子
```

**各因子說明**：

#### 假期因子
- **範圍**：0.60 - 1.40
- **計算**：`holidayInfo.factor`
- **影響**：香港公眾假期對就診人數有顯著影響

#### 流感季節因子
- **值**：1.004（約 0.4% 增加）
- **適用月份**：1, 2, 3, 7, 8 月
- **影響**：流感高峰期就診人數增加

#### 天氣因子
- **範圍**：0.90 - 1.15
- **計算方法**：`calculateWeatherImpact(weatherData, historicalData)`
- **詳細計算**：
  ```
  天氣因子 = 溫度因子 × 濕度因子 × 降雨因子 × 天氣警告因子
  ```
  
  **溫度影響**（使用相對溫度，基於研究）：
  - 比歷史平均高 5°C 以上：×1.06（增加 6%）
  - 比歷史平均低 5°C 以上：×1.10（增加 10%，寒冷增加就診）
  - 絕對溫度（回退）：
    - >33°C：×1.08（酷熱）
    - 30-33°C：×1.04（炎熱）
    - 10-15°C：×1.06（寒冷）
    - <10°C：×1.12（嚴寒）
  
  **濕度影響**：
  - ≥95%：×1.03（極潮濕）
  - 85-95%：×1.01（潮濕）
  - 60-85%：×1.00（正常）
  - <60%：×0.99（乾燥）
  
  **降雨影響**：
  - ≥30mm：×0.92（大雨，減少 8%）
  - 10-30mm：×0.96（中雨，減少 4%）
  - 0.1-10mm：×0.98（小雨，減少 2%）
  - <0.1mm：×1.00（無雨）
  
  **天氣警告影響**：
  - 八號風球：×0.40（大幅減少）
  - 三號風球：×0.85
  - 紅雨：×0.75
  - 黃雨：×0.90
  - 寒冷天氣警告：×1.08
  - 酷熱天氣警告：×1.06

#### AI 因子
- **範圍**：0.85 - 1.15（限制範圍，避免過度調整）
- **計算**：`Math.max(0.85, Math.min(1.15, aiFactor.impactFactor))`
- **影響**：基於實時新聞和事件分析，動態調整預測值

---

## 📊 步驟 2：滯後特徵調整（加法模型）

### 2.1 Lag1 調整（昨天）

```
lag1_adjustment = (昨天就診人數 - 全局平均) × 0.18
```

**詳細說明**：
- **權重**：18%（基於研究：lag1 係數約 0.15-0.20）
- **意義**：捕捉日間自相關性，昨天的高/低就診量會影響今天
- **研究基礎**：特徵工程研究（2024）發現 lag1 是最重要的單一預測因子

### 2.2 Lag7 調整（上週同一天）

```
lag7_adjustment = (上週同一天就診人數 - 全局平均) × 0.10
```

**詳細說明**：
- **權重**：10%（基於研究：lag7 係數約 0.08-0.12）
- **意義**：捕捉週期性模式，上週同一天的模式會重現
- **研究基礎**：時間序列分析研究（2024）發現 lag7 捕捉週期性模式

### 2.3 移動平均調整

```
rolling_adjustment = (7天移動平均 - 30天移動平均) × 0.14
```

**詳細說明**：
- **權重**：14%（基於研究：rolling7 係數約 0.12-0.16）
- **計算**：
  ```
  7天移動平均 = Σ(最近7天就診人數) / 7
  30天移動平均 = Σ(最近30天就診人數) / 30
  ```
- **意義**：捕捉短期趨勢變化
  - 如果 7 天平均 > 30 天平均：上升趨勢，增加預測值
  - 如果 7 天平均 < 30 天平均：下降趨勢，減少預測值
- **研究基礎**：BMC Medical Informatics（2024）發現 rolling7 是重要特徵

### 2.4 總滯後調整

```
滯後特徵調整 = lag1_adjustment + lag7_adjustment + rolling_adjustment
```

---

## 📈 步驟 3：趨勢調整（基於 Prophet 研究）

### 3.1 趨勢計算

```
趨勢 = (7天移動平均 - 30天移動平均) / 30天移動平均
```

**詳細說明**：
- **計算窗口**：最近 30 天數據（`recentWindowDays = 30`）
- **意義**：捕捉短期趨勢方向
  - 正值：上升趨勢
  - 負值：下降趨勢

### 3.2 趨勢調整

```
趨勢調整 = 基礎預測值 × 趨勢 × 0.3
```

**詳細說明**：
- **權重**：30%（保守估計，基於 Prophet 模型研究）
- **意義**：根據短期趨勢調整預測值
- **研究基礎**：Facebook Prophet 模型研究（2017）

---

## 🎯 步驟 4：異常檢測和調整

### 4.1 計算歷史分位數

```
p5 = 歷史數據的 5% 分位數
p95 = 歷史數據的 95% 分位數
minReasonable = max(p5, 150)  // 至少 150 人
maxReasonable = min(p95, 350)  // 最多 350 人
```

### 4.2 異常值調整

```
如果 預測值 < minReasonable:
    預測值 = minReasonable + (預測值 - minReasonable) × 0.5  // 部分調整

如果 預測值 > maxReasonable:
    預測值 = maxReasonable + (預測值 - maxReasonable) × 0.5  // 部分調整
```

**詳細說明**：
- **部分調整**：不完全限制在範圍內，保留部分異常信號
- **研究基礎**：異常檢測研究（2024）

---

## 📊 步驟 5：信賴區間計算

### 5.1 調整標準差

```
調整標準差 = 加權標準差 × 1.2  // 20% 不確定性調整
```

**詳細說明**：
- **加權標準差**：基於最近 180 天數據，使用指數衰減權重計算
- **不確定性因子**：1.2（20% 額外緩衝，更保守的估計）

### 5.2 信賴區間

```
80% 信賴區間：
  lower = max(0, 預測值 - 1.5 × 調整標準差)
  upper = 預測值 + 1.5 × 調整標準差

95% 信賴區間：
  lower = max(0, 預測值 - 2.5 × 調整標準差)
  upper = 預測值 + 2.5 × 調整標準差
```

**詳細說明**：
- **80% CI 乘數**：1.5（從標準 1.28 改為 1.5，更保守）
- **95% CI 乘數**：2.5（從標準 1.96 改為 2.5，更保守）
- **研究基礎**：統計研究，考慮預測不確定性

---

## 🔄 完整計算流程

```
1. 計算全局平均（加權，180天窗口，指數衰減）
2. 計算月份因子（加權，180天窗口）
3. 計算星期因子（加權，180天窗口）
4. 計算月份-星期交互因子（加權，180天窗口）

5. 基準值 = 全局平均 × 月份因子
6. 基礎預測值 = 基準值 × 星期因子 × 假期因子 × 流感季節因子 × 天氣因子 × AI因子

7. Lag1 調整 = (昨天 - 全局平均) × 0.18
8. Lag7 調整 = (上週同一天 - 全局平均) × 0.10
9. 移動平均調整 = (7天平均 - 30天平均) × 0.14
10. 滯後調整 = Lag1 + Lag7 + 移動平均

11. 趨勢 = (7天平均 - 30天平均) / 30天平均
12. 趨勢調整 = 基礎預測值 × 趨勢 × 0.3

13. 預測值 = 基礎預測值 + 滯後調整 + 趨勢調整

14. 異常檢測和調整（如果超出合理範圍）

15. 計算信賴區間（使用調整後的標準差）
```

---

## 📚 研究基礎

### 核心研究文獻

1. **法國醫院 XGBoost 研究（2025）**
   - MAE: 2.63-2.64 病人
   - BMC Emergency Medicine

2. **特徵工程增強預測研究（2024）**
   - Lag1 係數：0.15-0.20
   - Lag7 係數：0.08-0.12
   - Rolling7 係數：0.12-0.16
   - BMC Medical Informatics

3. **深度自回歸循環網絡研究（2017）**
   - DeepAR 方法，準確性提升約 15%
   - arXiv:1704.04110

4. **時間序列預測深度學習研究（2019）**
   - TCN 方法，捕捉季節性和假日效應
   - arXiv:1906.04397

5. **Prophet 模型研究（2017）**
   - 短期和長期趨勢組合
   - Facebook Research

6. **天氣影響研究**
   - 相對溫度比絕對溫度更重要
   - 極端溫度增加就診量 8-12%
   - ResearchGate, 2024

---

## 🎯 預期性能

- **MAE**：< 2.5 病人（目標 < 2.0）
- **MAPE**：< 2.5%（目標 < 1.5%）
- **方向準確度**：> 93%
- **80% CI 覆蓋率**：> 80%
- **95% CI 覆蓋率**：> 95%

---

## 📝 版本信息

- **算法版本**：v2.3.3
- **預測方法**：enhanced_weighted_rolling_window_with_lag_features
- **更新日期**：2025-12-23

